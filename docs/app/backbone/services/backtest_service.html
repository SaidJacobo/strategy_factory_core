<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>app.backbone.services.backtest_service API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../services.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;app.backbone.services</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#log_message">log_message</a>
            </li>
            <li>
                    <a class="class" href="#BacktestService">BacktestService</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#BacktestService.db_service">db_service</a>
                        </li>
                        <li>
                                <a class="variable" href="#BacktestService.bot_service">bot_service</a>
                        </li>
                        <li>
                                <a class="variable" href="#BacktestService.config_service">config_service</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.async_iterator">async_iterator</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.run_backtest">run_backtest</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.run_backtests_and_save">run_backtests_and_save</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_performances_by_strategy_ticker">get_performances_by_strategy_ticker</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_performances_by_bot_dates">get_performances_by_bot_dates</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_performance_by_bot">get_performance_by_bot</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_bot_performance_by_id">get_bot_performance_by_id</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.delete_from_strategy">delete_from_strategy</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.delete">delete</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.update_favorite">update_favorite</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_robusts">get_robusts</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_robusts_by_strategy_id">get_robusts_by_strategy_id</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_favorites">get_favorites</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_trades">get_trades</a>
                        </li>
                        <li>
                                <a class="function" href="#BacktestService.get_by_filter">get_by_filter</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
app<wbr>.<a href="./../../backbone.html">backbone</a><wbr>.<a href="./../services.html">services</a><wbr>.backtest_service    </h1>

                
                        <input id="mod-backtest_service-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-backtest_service-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span><span class="p">,</span> <span class="n">List</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.database.db_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">DbService</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.bot</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bot</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.bot_performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">BotPerformance</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.bot_trade_performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">BotTradePerformance</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.luck_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">LuckTest</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.metric_wharehouse</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetricWharehouse</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.montecarlo_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">MontecarloTest</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.random_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomTest</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.strategy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Strategy</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ticker</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.timeframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Timeframe</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.entities.trade</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trade</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.services.config_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigService</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.services.operation_result</span><span class="w"> </span><span class="kn">import</span> <span class="n">OperationResult</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.services.bot_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">BotService</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.services.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_performance_from_df_to_obj</span><span class="p">,</span> <span class="n">trades_from_df_to_obj</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.utils.get_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_data</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.utils.general_purpose</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_function</span><span class="p">,</span> <span class="n">profile_function</span><span class="p">,</span> <span class="n">streaming_endpoint</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.backbone.utils.wfo_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_strategy_and_get_performances</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">joinedload</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">select</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">aliased</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Función para agregar logs a la cola sin detener el proceso.&quot;&quot;&quot;</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="p">}))</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BacktestService</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    Handles the orchestration, execution, persistence, and retrieval of backtests and related performance metrics.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    This service acts as the central component for running backtests on trading strategies, saving their results,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    and performing various queries on historical performance data. It supports streaming logs, asynchronous execution,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    and interaction with the database and configuration layers.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    Main features include:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    - Running and saving individual or batch backtests across strategy/ticker/timeframe/risk combinations.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    - Loading strategies dynamically and executing them with proper capital, leverage, and configuration.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    - Persisting detailed performance metrics and trade history in the database.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    - Performing deletions and cleanup of historical test data (including files and DB records).</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    - Providing filtering, querying, and tagging of backtests (e.g. by performance, robustness, favorites).</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    - Identifying robust strategies via custom metrics and filters (e.g. return/drawdown ratio &gt; 1).</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    - Managing test dependencies such as Monte Carlo, Luck Test, and Random Test results.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    Attributes:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        db_service (DbService): Handles database connections and CRUD operations.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        bot_service (BotService): Manages bot records used during backtesting.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        config_service (ConfigService): Provides access to configuration values (e.g. risk-free rate).</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    Notes:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        - Backtests can be persisted with reports or run temporarily.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">        - Streaming logs (via queues) allow real-time feedback when executing long-running backtests.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">        - This class assumes a full application context with all entities (Bot, BotPerformance, Trade, etc.) properly defined.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span> <span class="o">=</span> <span class="n">DbService</span><span class="p">()</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bot_service</span> <span class="o">=</span> <span class="n">BotService</span><span class="p">()</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_service</span> <span class="o">=</span> <span class="n">ConfigService</span><span class="p">()</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="c1"># Si iterable es una lista, la envolvemos en una iteración asíncrona</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="k">yield</span> <span class="n">item</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtest</span><span class="p">(</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="n">Ticker</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">timeframe</span><span class="p">:</span> <span class="n">Timeframe</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="n">risk</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        Executes an asynchronous backtest for a given trading strategy and returns performance metrics, </span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        trade details, and statistics via a streaming endpoint.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        This function loads the specified strategy, fetches historical price data, applies leverage rules,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        and runs a backtest simulation. Results are streamed in real-time through an asyncio queue, </span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        and optional plots/reports are generated.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        Steps performed:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        - Loads the trading strategy dynamically from a module path.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        - Retrieves leverage rules from a YAML config file.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        - Fetches and prepares historical price data for the given ticker/timeframe.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        - Computes margin requirements based on leverage.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        - Executes the backtest using the strategy&#39;s logic and calculates performance metrics.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        - Generates and saves backtest plots (temporary or persistent) if requested.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        - Streams progress updates, logs, and final results through the provided queue.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        Parameters:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        - initial_cash (float): Starting capital for the backtest simulation.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        - strategy (Strategy): Strategy object containing the module path and name.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        - ticker (Ticker): Financial instrument to backtest on (e.g., currency pair, stock).</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        - timeframe (Timeframe): Timeframe for price data (e.g., &#39;1H&#39;, &#39;4H&#39;).</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        - date_from (pd.Timestamp): Start date for historical data.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">        - date_to (pd.Timestamp): End date for historical data.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        - method (str): Reserved for future backtest variations (unused in current implementation).</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">        - risk (float): Risk percentage per trade (e.g., 0.01 for 1% risk).</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode: </span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">            - &#39;temp&#39;: Saves in a temporary directory (auto-cleaned later).</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">            - &#39;persist&#39;: Saves in the main backtest_plots directory.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">            - Any other value skips plot generation.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for real-time progress streaming.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        Returns:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        AsyncGenerator[str, None]: Yields three objects upon completion:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        - performance (pd.DataFrame): Aggregated strategy performance metrics.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        - trade_performance (pd.DataFrame): Detailed trade-by-trade results.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        - stats (pd.DataFrame): Statistical summaries (e.g., Sharpe ratio, max drawdown).</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        Side effects:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        - Reads leverage configurations from &#39;./app/configs/leverages.yml&#39;.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        - May create HTML plot files in either &#39;./app/templates/static/backtest_plots/temp&#39; (temporary)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        or &#39;./app/templates/static/backtest_plots&#39; (persistent).</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        - Streams logs/results via the provided asyncio.Queue (e.g., for frontend progress updates).</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        Notes:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        - The strategy module path must follow the convention: &#39;app.backbone.strategies.{strategy_name}&#39;.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        - Temporary plots include a timestamp and are automatically purged by a separate cleanup process.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        - Risk-free rate is fetched from the application&#39;s config service (used for Sharpe ratio calculations).</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">        - Margin is calculated as 1/leverage (e.g., 50x leverage → 2% margin requirement).</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loading strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">strategy_path</span> <span class="o">=</span> <span class="s1">&#39;app.backbone.strategies.&#39;</span> <span class="o">+</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">strategy_func</span> <span class="o">=</span> <span class="n">load_function</span><span class="p">(</span><span class="n">strategy_path</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2"> loaded succesfully&quot;</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading leverages&quot;</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./app/configs/leverages.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_name</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="n">leverages</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Leverages loaded&quot;</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="n">leverage</span> <span class="o">=</span> <span class="n">leverages</span><span class="p">[</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">leverage</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Getting data&quot;</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">MetaTraderNumber</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data ready: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting backtest&quot;</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_from</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_to</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="n">plot_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;temp&#39;</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots/temp&#39;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/backtest_plots/temp&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span><span class="p">))</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">elif</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots&#39;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">risk_free_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_service</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="s1">&#39;RiskFreeRate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">run_strategy_and_get_performances</span><span class="p">(</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy_func</span><span class="p">,</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">prices</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="n">risk_free_rate</span><span class="o">=</span><span class="n">risk_free_rate</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="n">save_report</span><span class="o">=</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span> <span class="c1"># Solo genera el reporte si no es una corrida temporal</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest is done :)&quot;</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtests_and_save</span><span class="p">(</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="n">strategies</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">tickers</span><span class="p">:</span> <span class="n">Ticker</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Ticker</span><span class="p">],</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Timeframe</span><span class="p">],</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="n">risks</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        Executes multiple backtests in parallel for all combinations of strategies, tickers, timeframes and risks,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        then saves results to the database while streaming progress updates.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">        This function handles the complete backtesting pipeline:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        - Generates all possible combinations of input parameters</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        - Checks for existing backtest results to avoid duplicate work</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        - Runs new backtests when needed using run_backtest()</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        - Saves performance metrics, trade details, and statistics to the database</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        - Provides real-time feedback through an async queue</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        Steps performed:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        1. Normalizes all input parameters to lists (single items → single-element lists)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        2. Generates all combinations of strategies/tickers/timeframes/risks</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        3. For each combination:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        - Checks if bot exists in database</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        - Verifies if backtest already exists for the date range</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        - Runs new backtest if needed</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        - Converts results to database objects</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        - Saves all data (bot, performance, trades) transactionally</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        4. Streams progress, warnings, and completion messages via queue</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        Parameters:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        - initial_cash (float): Starting capital for all backtests</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        - strategies (Strategy|List[Strategy]): Single strategy or list to test</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">        - tickers (Ticker|List[Ticker]): Financial instrument(s) to backtest</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        - timeframes (List[Timeframe]): Time intervals to test (e.g. [&#39;1H&#39;, &#39;4H&#39;])</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        - date_from (date): Start date for historical data</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        - date_to (date): End date for historical data</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">        - method (str): Backtesting methodology identifier</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        - risks (float|List[float]): Risk percentage(s) per trade (e.g. [0.01, 0.02])</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            - &#39;temp&#39;: Temporary storage</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">            - &#39;persist&#39;: Permanent storage</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">            - Other: Skip plot generation</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for progress streaming</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        Returns:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        - AsyncGenerator[str, None]: Yields list of saved BotPerformance objects when complete</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">        Side effects:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">        - Creates/updates database records for:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">            - Bot configurations</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">            - Performance metrics</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">            - Individual trades</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        - May generate plot files depending on save_bt_plot parameter</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        - Streams messages to provided queue including:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">            - Progress logs</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">            - Warnings about duplicates</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">            - Completion/failure notifications</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        Notes:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        - Automatically skips existing backtests for the same parameters/date range</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        - Uses atomic database transactions to ensure data consistency</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        - New bots are created if they don&#39;t exist in the database</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        - Trade history is extracted from backtest stats and saved relationally</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        - All database operations use the service&#39;s db_service interface</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        - Failures for individual combinations don&#39;t stop overall execution</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="n">backtests</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategies</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">strategies</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">strategies</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tickers</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">tickers</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeframes</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">timeframes</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="n">risks</span> <span class="o">=</span> <span class="p">[</span><span class="n">risks</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">risks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">risks</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>  
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">strategies</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">,</span> <span class="n">risks</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_iterator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">)):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                <span class="n">strategy</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">risk</span> <span class="o">=</span> <span class="n">combination</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting&quot;</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking bot in the database&quot;</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">bot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_service</span><span class="o">.</span><span class="n">get_bot</span><span class="p">(</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                    <span class="n">strategy_id</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                    <span class="n">ticker_id</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                    <span class="n">timeframe_id</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                    <span class="n">risk</span><span class="o">=</span><span class="n">risk</span>   
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="k">if</span> <span class="n">bot</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot already exists&quot;</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                    <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking backtest in the database&quot;</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                    <span class="n">result_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performances_by_bot_dates</span><span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                        <span class="n">bot_id</span><span class="o">=</span><span class="n">bot</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> 
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span> 
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                    <span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                    
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                    <span class="k">if</span> <span class="n">result_performance</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_performance</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest already exists. Skipping...&quot;</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                        <span class="k">continue</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot is not in the database&quot;</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                    <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                        <span class="n">Name</span><span class="o">=</span><span class="n">bot_name</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                        <span class="n">StrategyId</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                        <span class="n">TickerId</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                        <span class="n">TimeframeId</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                        <span class="n">Risk</span><span class="o">=</span><span class="n">risk</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                        <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                        <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                        <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                        <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                        <span class="n">save_bt_plot</span><span class="o">=</span><span class="n">save_bt_plot</span><span class="p">,</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                    <span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Saving metrics in the database&quot;</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                    <span class="n">bot_performance_for_db</span> <span class="o">=</span> <span class="n">_performance_from_df_to_obj</span><span class="p">(</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                        <span class="n">performance</span><span class="p">,</span> 
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                        <span class="n">date_from</span><span class="p">,</span> 
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                        <span class="n">date_to</span><span class="p">,</span> 
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                        <span class="n">risk</span><span class="p">,</span> 
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                        <span class="n">method</span><span class="p">,</span> 
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                        <span class="n">bot</span><span class="p">,</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                        <span class="n">initial_cash</span><span class="p">,</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                    <span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                    
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                    <span class="n">trade_performance_for_db</span> <span class="o">=</span> <span class="p">[</span><span class="n">BotTradePerformance</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trade_performance</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                    <span class="n">trade_performance_for_db</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span> 
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                    
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_exists</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                        
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot_performance_for_db</span><span class="p">))</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade_performance_for_db</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                        
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                        <span class="n">trade_history</span> <span class="o">=</span> <span class="n">trades_from_df_to_obj</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">_trades</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_history</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                            <span class="n">trade</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;It&#39;s done buddy ;)&quot;</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="n">backtests</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_strategy_ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">,</span> <span class="n">ticker_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">ticker_id</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">))</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>            <span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="k">return</span> <span class="n">bot_performances</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_bot_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">RandomTestPerformance</span><span class="p">),</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformance</span><span class="p">),</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_id</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateFrom</span> <span class="o">==</span> <span class="n">date_from</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateTo</span> <span class="o">==</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>     
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performance_by_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">BotId</span><span class="o">=</span><span class="n">bot_id</span><span class="p">)</span>  
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bot_performance_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_from_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MetricWharehouse</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                    <span class="n">MetricWharehouse</span><span class="o">.</span><span class="n">MontecarloTestId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                        <span class="n">select</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="n">lucktest_bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">lucktest_bp_subq</span><span class="p">)))</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Trade</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Trade</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="c1"># Borrar archivos relacionados</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="k">for</span> <span class="n">bot_performance</span> <span class="ow">in</span> <span class="n">bot_performances</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="c1"># Cargar el objeto con relaciones necesarias</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">bot_performance_id</span> <span class="o">=</span> <span class="n">bot_performance</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bot_performance</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                <span class="p">)</span>\
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bot_performance_id</span><span class="p">)</span>\
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_performance</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;BotPerformance not found&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="c1"># Eliminar relaciones directas</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="c1"># Eliminar Montecarlo y métricas asociadas</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="n">montecarlo_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="k">if</span> <span class="n">montecarlo_test</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MetricWharehouse</span><span class="p">,</span> <span class="n">MontecarloTestId</span><span class="o">=</span><span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="c1"># Eliminar LuckTests y sus performances</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="n">luck_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">luck_tests</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="c1"># Borrar archivos relacionados</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="c1"># Eliminar RandomTests y sus dependencias</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                <span class="n">rt</span> <span class="o">=</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                <span class="n">rt_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="k">if</span> <span class="n">rt_perf</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                    <span class="n">rt_trade_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">rt_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                    <span class="k">if</span> <span class="n">rt_trade_perf</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">rt_trade_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">RandomTest</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="c1"># Borrar trades relacionados</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="c1"># Si no hay más performance, borrar el Bot</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                <span class="n">rem</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">performance</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Backtest not found&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">updated_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance</span><span class="p">)</span>   
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_performance</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Update failed&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">updated_performance</span><span class="o">.</span><span class="n">Favorite</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="c1"># Subquery para filtrar estrategias robustas (RreturnDd promedio &gt; 1)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                <span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                <span class="p">)</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="c1"># Alias para evitar ambigüedad</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="c1"># Subquery para asignar un número de fila basado en StabilityWeightedRar</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="n">ranked_subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;bp_id&quot;</span><span class="p">),</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                    <span class="o">.</span><span class="n">over</span><span class="p">(</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">],</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>                        <span class="n">order_by</span><span class="o">=</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>                    <span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                    <span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;row_num&quot;</span><span class="p">),</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                <span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>                    <span class="n">subquery</span><span class="p">,</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">),</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="c1"># Query final seleccionando solo los mejores (row_num == 1)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="p">,</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">bp_id</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">row_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>               
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts_by_strategy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="c1"># Subquery para calcular el promedio de RreturnDd por StrategyId y TickerId</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                <span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">,</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                <span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># &gt;= en lugar de &gt; para incluir exactamente 1</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="c1"># Alias para evitar ambigüedad en las relaciones</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="c1"># Subquery para seleccionar la mejor temporalidad por StrategyId - TickerId</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>            <span class="n">best_temporalities</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;max_custom_metric&quot;</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                <span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">))</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>            <span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>            <span class="c1"># Query final para traer solo los registros que corresponden a la mejor temporalidad</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_temporalities</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>                    <span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_custom_metric</span><span class="p">))</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_favorites</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">favorites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Favorite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>        
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>        <span class="k">return</span> <span class="n">favorites</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="k">return</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">TradeHistory</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_filter</span><span class="p">(</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="n">return_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>        <span class="n">stability_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="n">sharpe_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="n">trades</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>        <span class="n">rreturn_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="n">custom_metric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">winrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="c1"># Base query y joins explícitos</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>            <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>\
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>\
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Ticker</span><span class="p">,</span> <span class="n">Ticker</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>            <span class="c1"># Filtros numéricos</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>            <span class="k">if</span> <span class="n">return_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Return</span> <span class="o">&gt;=</span> <span class="n">return_</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>            <span class="k">if</span> <span class="n">drawdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Drawdown</span> <span class="o">&lt;=</span> <span class="n">drawdown</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>            <span class="k">if</span> <span class="n">stability_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityRatio</span> <span class="o">&gt;=</span> <span class="n">stability_ratio</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="k">if</span> <span class="n">sharpe_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">SharpeRatio</span> <span class="o">&gt;=</span> <span class="n">sharpe_ratio</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="k">if</span> <span class="n">trades</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Trades</span> <span class="o">&gt;=</span> <span class="n">trades</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>            <span class="k">if</span> <span class="n">rreturn_dd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">&gt;=</span> <span class="n">rreturn_dd</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>            <span class="k">if</span> <span class="n">custom_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">&gt;=</span> <span class="n">custom_metric</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>            <span class="k">if</span> <span class="n">winrate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">WinRate</span> <span class="o">&gt;=</span> <span class="n">winrate</span><span class="p">)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>            <span class="c1"># Filtros por texto con ILIKE correctamente aplicados</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>            <span class="k">if</span> <span class="n">strategy</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="k">if</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ticker</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="c1"># Query final que aplica filtros correctamente</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>            <span class="n">final_query</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>                <span class="n">query</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">TradeHistory</span><span class="p">),</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">MontecarloTest</span><span class="p">),</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                <span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>            <span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="k">return</span> <span class="n">final_query</span>
</span></pre></div>


            </section>
                <section id="log_message">
                            <input id="log_message-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">log_message</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">Queue</span>,</span><span class="param">	<span class="n">ticker</span>,</span><span class="param">	<span class="n">timeframe</span>,</span><span class="param">	<span class="n">status</span>,</span><span class="param">	<span class="n">message</span>,</span><span class="param">	<span class="n">error</span><span class="o">=</span><span class="s1">&#39;&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="log_message-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#log_message"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="log_message-34"><a href="#log_message-34"><span class="linenos">34</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="log_message-35"><a href="#log_message-35"><span class="linenos">35</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Función para agregar logs a la cola sin detener el proceso.&quot;&quot;&quot;</span>
</span><span id="log_message-36"><a href="#log_message-36"><span class="linenos">36</span></a>    <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="log_message-37"><a href="#log_message-37"><span class="linenos">37</span></a>        <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
</span><span id="log_message-38"><a href="#log_message-38"><span class="linenos">38</span></a>        <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
</span><span id="log_message-39"><a href="#log_message-39"><span class="linenos">39</span></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
</span><span id="log_message-40"><a href="#log_message-40"><span class="linenos">40</span></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
</span><span id="log_message-41"><a href="#log_message-41"><span class="linenos">41</span></a>        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span>
</span><span id="log_message-42"><a href="#log_message-42"><span class="linenos">42</span></a><span class="p">}))</span>
</span></pre></div>


            <div class="docstring"><p>Función para agregar logs a la cola sin detener el proceso.</p>
</div>


                </section>
                <section id="BacktestService">
                            <input id="BacktestService-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BacktestService</span>:

                <label class="view-source-button" for="BacktestService-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService-44"><a href="#BacktestService-44"><span class="linenos"> 44</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BacktestService</span><span class="p">:</span>
</span><span id="BacktestService-45"><a href="#BacktestService-45"><span class="linenos"> 45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BacktestService-46"><a href="#BacktestService-46"><span class="linenos"> 46</span></a><span class="sd">    Handles the orchestration, execution, persistence, and retrieval of backtests and related performance metrics.</span>
</span><span id="BacktestService-47"><a href="#BacktestService-47"><span class="linenos"> 47</span></a>
</span><span id="BacktestService-48"><a href="#BacktestService-48"><span class="linenos"> 48</span></a><span class="sd">    This service acts as the central component for running backtests on trading strategies, saving their results,</span>
</span><span id="BacktestService-49"><a href="#BacktestService-49"><span class="linenos"> 49</span></a><span class="sd">    and performing various queries on historical performance data. It supports streaming logs, asynchronous execution,</span>
</span><span id="BacktestService-50"><a href="#BacktestService-50"><span class="linenos"> 50</span></a><span class="sd">    and interaction with the database and configuration layers.</span>
</span><span id="BacktestService-51"><a href="#BacktestService-51"><span class="linenos"> 51</span></a>
</span><span id="BacktestService-52"><a href="#BacktestService-52"><span class="linenos"> 52</span></a><span class="sd">    Main features include:</span>
</span><span id="BacktestService-53"><a href="#BacktestService-53"><span class="linenos"> 53</span></a><span class="sd">    - Running and saving individual or batch backtests across strategy/ticker/timeframe/risk combinations.</span>
</span><span id="BacktestService-54"><a href="#BacktestService-54"><span class="linenos"> 54</span></a><span class="sd">    - Loading strategies dynamically and executing them with proper capital, leverage, and configuration.</span>
</span><span id="BacktestService-55"><a href="#BacktestService-55"><span class="linenos"> 55</span></a><span class="sd">    - Persisting detailed performance metrics and trade history in the database.</span>
</span><span id="BacktestService-56"><a href="#BacktestService-56"><span class="linenos"> 56</span></a><span class="sd">    - Performing deletions and cleanup of historical test data (including files and DB records).</span>
</span><span id="BacktestService-57"><a href="#BacktestService-57"><span class="linenos"> 57</span></a><span class="sd">    - Providing filtering, querying, and tagging of backtests (e.g. by performance, robustness, favorites).</span>
</span><span id="BacktestService-58"><a href="#BacktestService-58"><span class="linenos"> 58</span></a><span class="sd">    - Identifying robust strategies via custom metrics and filters (e.g. return/drawdown ratio &gt; 1).</span>
</span><span id="BacktestService-59"><a href="#BacktestService-59"><span class="linenos"> 59</span></a><span class="sd">    - Managing test dependencies such as Monte Carlo, Luck Test, and Random Test results.</span>
</span><span id="BacktestService-60"><a href="#BacktestService-60"><span class="linenos"> 60</span></a>
</span><span id="BacktestService-61"><a href="#BacktestService-61"><span class="linenos"> 61</span></a><span class="sd">    Attributes:</span>
</span><span id="BacktestService-62"><a href="#BacktestService-62"><span class="linenos"> 62</span></a><span class="sd">        db_service (DbService): Handles database connections and CRUD operations.</span>
</span><span id="BacktestService-63"><a href="#BacktestService-63"><span class="linenos"> 63</span></a><span class="sd">        bot_service (BotService): Manages bot records used during backtesting.</span>
</span><span id="BacktestService-64"><a href="#BacktestService-64"><span class="linenos"> 64</span></a><span class="sd">        config_service (ConfigService): Provides access to configuration values (e.g. risk-free rate).</span>
</span><span id="BacktestService-65"><a href="#BacktestService-65"><span class="linenos"> 65</span></a>
</span><span id="BacktestService-66"><a href="#BacktestService-66"><span class="linenos"> 66</span></a><span class="sd">    Notes:</span>
</span><span id="BacktestService-67"><a href="#BacktestService-67"><span class="linenos"> 67</span></a><span class="sd">        - Backtests can be persisted with reports or run temporarily.</span>
</span><span id="BacktestService-68"><a href="#BacktestService-68"><span class="linenos"> 68</span></a><span class="sd">        - Streaming logs (via queues) allow real-time feedback when executing long-running backtests.</span>
</span><span id="BacktestService-69"><a href="#BacktestService-69"><span class="linenos"> 69</span></a><span class="sd">        - This class assumes a full application context with all entities (Bot, BotPerformance, Trade, etc.) properly defined.</span>
</span><span id="BacktestService-70"><a href="#BacktestService-70"><span class="linenos"> 70</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BacktestService-71"><a href="#BacktestService-71"><span class="linenos"> 71</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BacktestService-72"><a href="#BacktestService-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span> <span class="o">=</span> <span class="n">DbService</span><span class="p">()</span>
</span><span id="BacktestService-73"><a href="#BacktestService-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bot_service</span> <span class="o">=</span> <span class="n">BotService</span><span class="p">()</span>
</span><span id="BacktestService-74"><a href="#BacktestService-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_service</span> <span class="o">=</span> <span class="n">ConfigService</span><span class="p">()</span>
</span><span id="BacktestService-75"><a href="#BacktestService-75"><span class="linenos"> 75</span></a>    
</span><span id="BacktestService-76"><a href="#BacktestService-76"><span class="linenos"> 76</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
</span><span id="BacktestService-77"><a href="#BacktestService-77"><span class="linenos"> 77</span></a>        <span class="c1"># Si iterable es una lista, la envolvemos en una iteración asíncrona</span>
</span><span id="BacktestService-78"><a href="#BacktestService-78"><span class="linenos"> 78</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span id="BacktestService-79"><a href="#BacktestService-79"><span class="linenos"> 79</span></a>            <span class="k">yield</span> <span class="n">item</span>
</span><span id="BacktestService-80"><a href="#BacktestService-80"><span class="linenos"> 80</span></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="BacktestService-81"><a href="#BacktestService-81"><span class="linenos"> 81</span></a>
</span><span id="BacktestService-82"><a href="#BacktestService-82"><span class="linenos"> 82</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="BacktestService-83"><a href="#BacktestService-83"><span class="linenos"> 83</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtest</span><span class="p">(</span>
</span><span id="BacktestService-84"><a href="#BacktestService-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService-85"><a href="#BacktestService-85"><span class="linenos"> 85</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService-86"><a href="#BacktestService-86"><span class="linenos"> 86</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span>
</span><span id="BacktestService-87"><a href="#BacktestService-87"><span class="linenos"> 87</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="n">Ticker</span><span class="p">,</span>
</span><span id="BacktestService-88"><a href="#BacktestService-88"><span class="linenos"> 88</span></a>        <span class="n">timeframe</span><span class="p">:</span> <span class="n">Timeframe</span><span class="p">,</span>
</span><span id="BacktestService-89"><a href="#BacktestService-89"><span class="linenos"> 89</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="BacktestService-90"><a href="#BacktestService-90"><span class="linenos"> 90</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="BacktestService-91"><a href="#BacktestService-91"><span class="linenos"> 91</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService-92"><a href="#BacktestService-92"><span class="linenos"> 92</span></a>        <span class="n">risk</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService-93"><a href="#BacktestService-93"><span class="linenos"> 93</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService-94"><a href="#BacktestService-94"><span class="linenos"> 94</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="BacktestService-95"><a href="#BacktestService-95"><span class="linenos"> 95</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BacktestService-96"><a href="#BacktestService-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BacktestService-97"><a href="#BacktestService-97"><span class="linenos"> 97</span></a><span class="sd">        Executes an asynchronous backtest for a given trading strategy and returns performance metrics, </span>
</span><span id="BacktestService-98"><a href="#BacktestService-98"><span class="linenos"> 98</span></a><span class="sd">        trade details, and statistics via a streaming endpoint.</span>
</span><span id="BacktestService-99"><a href="#BacktestService-99"><span class="linenos"> 99</span></a>
</span><span id="BacktestService-100"><a href="#BacktestService-100"><span class="linenos">100</span></a><span class="sd">        This function loads the specified strategy, fetches historical price data, applies leverage rules,</span>
</span><span id="BacktestService-101"><a href="#BacktestService-101"><span class="linenos">101</span></a><span class="sd">        and runs a backtest simulation. Results are streamed in real-time through an asyncio queue, </span>
</span><span id="BacktestService-102"><a href="#BacktestService-102"><span class="linenos">102</span></a><span class="sd">        and optional plots/reports are generated.</span>
</span><span id="BacktestService-103"><a href="#BacktestService-103"><span class="linenos">103</span></a>
</span><span id="BacktestService-104"><a href="#BacktestService-104"><span class="linenos">104</span></a><span class="sd">        Steps performed:</span>
</span><span id="BacktestService-105"><a href="#BacktestService-105"><span class="linenos">105</span></a><span class="sd">        - Loads the trading strategy dynamically from a module path.</span>
</span><span id="BacktestService-106"><a href="#BacktestService-106"><span class="linenos">106</span></a><span class="sd">        - Retrieves leverage rules from a YAML config file.</span>
</span><span id="BacktestService-107"><a href="#BacktestService-107"><span class="linenos">107</span></a><span class="sd">        - Fetches and prepares historical price data for the given ticker/timeframe.</span>
</span><span id="BacktestService-108"><a href="#BacktestService-108"><span class="linenos">108</span></a><span class="sd">        - Computes margin requirements based on leverage.</span>
</span><span id="BacktestService-109"><a href="#BacktestService-109"><span class="linenos">109</span></a><span class="sd">        - Executes the backtest using the strategy&#39;s logic and calculates performance metrics.</span>
</span><span id="BacktestService-110"><a href="#BacktestService-110"><span class="linenos">110</span></a><span class="sd">        - Generates and saves backtest plots (temporary or persistent) if requested.</span>
</span><span id="BacktestService-111"><a href="#BacktestService-111"><span class="linenos">111</span></a><span class="sd">        - Streams progress updates, logs, and final results through the provided queue.</span>
</span><span id="BacktestService-112"><a href="#BacktestService-112"><span class="linenos">112</span></a>
</span><span id="BacktestService-113"><a href="#BacktestService-113"><span class="linenos">113</span></a><span class="sd">        Parameters:</span>
</span><span id="BacktestService-114"><a href="#BacktestService-114"><span class="linenos">114</span></a><span class="sd">        - initial_cash (float): Starting capital for the backtest simulation.</span>
</span><span id="BacktestService-115"><a href="#BacktestService-115"><span class="linenos">115</span></a><span class="sd">        - strategy (Strategy): Strategy object containing the module path and name.</span>
</span><span id="BacktestService-116"><a href="#BacktestService-116"><span class="linenos">116</span></a><span class="sd">        - ticker (Ticker): Financial instrument to backtest on (e.g., currency pair, stock).</span>
</span><span id="BacktestService-117"><a href="#BacktestService-117"><span class="linenos">117</span></a><span class="sd">        - timeframe (Timeframe): Timeframe for price data (e.g., &#39;1H&#39;, &#39;4H&#39;).</span>
</span><span id="BacktestService-118"><a href="#BacktestService-118"><span class="linenos">118</span></a><span class="sd">        - date_from (pd.Timestamp): Start date for historical data.</span>
</span><span id="BacktestService-119"><a href="#BacktestService-119"><span class="linenos">119</span></a><span class="sd">        - date_to (pd.Timestamp): End date for historical data.</span>
</span><span id="BacktestService-120"><a href="#BacktestService-120"><span class="linenos">120</span></a><span class="sd">        - method (str): Reserved for future backtest variations (unused in current implementation).</span>
</span><span id="BacktestService-121"><a href="#BacktestService-121"><span class="linenos">121</span></a><span class="sd">        - risk (float): Risk percentage per trade (e.g., 0.01 for 1% risk).</span>
</span><span id="BacktestService-122"><a href="#BacktestService-122"><span class="linenos">122</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode: </span>
</span><span id="BacktestService-123"><a href="#BacktestService-123"><span class="linenos">123</span></a><span class="sd">            - &#39;temp&#39;: Saves in a temporary directory (auto-cleaned later).</span>
</span><span id="BacktestService-124"><a href="#BacktestService-124"><span class="linenos">124</span></a><span class="sd">            - &#39;persist&#39;: Saves in the main backtest_plots directory.</span>
</span><span id="BacktestService-125"><a href="#BacktestService-125"><span class="linenos">125</span></a><span class="sd">            - Any other value skips plot generation.</span>
</span><span id="BacktestService-126"><a href="#BacktestService-126"><span class="linenos">126</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for real-time progress streaming.</span>
</span><span id="BacktestService-127"><a href="#BacktestService-127"><span class="linenos">127</span></a>
</span><span id="BacktestService-128"><a href="#BacktestService-128"><span class="linenos">128</span></a><span class="sd">        Returns:</span>
</span><span id="BacktestService-129"><a href="#BacktestService-129"><span class="linenos">129</span></a><span class="sd">        AsyncGenerator[str, None]: Yields three objects upon completion:</span>
</span><span id="BacktestService-130"><a href="#BacktestService-130"><span class="linenos">130</span></a><span class="sd">        - performance (pd.DataFrame): Aggregated strategy performance metrics.</span>
</span><span id="BacktestService-131"><a href="#BacktestService-131"><span class="linenos">131</span></a><span class="sd">        - trade_performance (pd.DataFrame): Detailed trade-by-trade results.</span>
</span><span id="BacktestService-132"><a href="#BacktestService-132"><span class="linenos">132</span></a><span class="sd">        - stats (pd.DataFrame): Statistical summaries (e.g., Sharpe ratio, max drawdown).</span>
</span><span id="BacktestService-133"><a href="#BacktestService-133"><span class="linenos">133</span></a>
</span><span id="BacktestService-134"><a href="#BacktestService-134"><span class="linenos">134</span></a><span class="sd">        Side effects:</span>
</span><span id="BacktestService-135"><a href="#BacktestService-135"><span class="linenos">135</span></a><span class="sd">        - Reads leverage configurations from &#39;./app/configs/leverages.yml&#39;.</span>
</span><span id="BacktestService-136"><a href="#BacktestService-136"><span class="linenos">136</span></a><span class="sd">        - May create HTML plot files in either &#39;./app/templates/static/backtest_plots/temp&#39; (temporary)</span>
</span><span id="BacktestService-137"><a href="#BacktestService-137"><span class="linenos">137</span></a><span class="sd">        or &#39;./app/templates/static/backtest_plots&#39; (persistent).</span>
</span><span id="BacktestService-138"><a href="#BacktestService-138"><span class="linenos">138</span></a><span class="sd">        - Streams logs/results via the provided asyncio.Queue (e.g., for frontend progress updates).</span>
</span><span id="BacktestService-139"><a href="#BacktestService-139"><span class="linenos">139</span></a>
</span><span id="BacktestService-140"><a href="#BacktestService-140"><span class="linenos">140</span></a><span class="sd">        Notes:</span>
</span><span id="BacktestService-141"><a href="#BacktestService-141"><span class="linenos">141</span></a><span class="sd">        - The strategy module path must follow the convention: &#39;app.backbone.strategies.{strategy_name}&#39;.</span>
</span><span id="BacktestService-142"><a href="#BacktestService-142"><span class="linenos">142</span></a><span class="sd">        - Temporary plots include a timestamp and are automatically purged by a separate cleanup process.</span>
</span><span id="BacktestService-143"><a href="#BacktestService-143"><span class="linenos">143</span></a><span class="sd">        - Risk-free rate is fetched from the application&#39;s config service (used for Sharpe ratio calculations).</span>
</span><span id="BacktestService-144"><a href="#BacktestService-144"><span class="linenos">144</span></a><span class="sd">        - Margin is calculated as 1/leverage (e.g., 50x leverage → 2% margin requirement).</span>
</span><span id="BacktestService-145"><a href="#BacktestService-145"><span class="linenos">145</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BacktestService-146"><a href="#BacktestService-146"><span class="linenos">146</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loading strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService-147"><a href="#BacktestService-147"><span class="linenos">147</span></a>        
</span><span id="BacktestService-148"><a href="#BacktestService-148"><span class="linenos">148</span></a>        <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BacktestService-149"><a href="#BacktestService-149"><span class="linenos">149</span></a>        <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService-150"><a href="#BacktestService-150"><span class="linenos">150</span></a>        
</span><span id="BacktestService-151"><a href="#BacktestService-151"><span class="linenos">151</span></a>        <span class="n">strategy_path</span> <span class="o">=</span> <span class="s1">&#39;app.backbone.strategies.&#39;</span> <span class="o">+</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span>
</span><span id="BacktestService-152"><a href="#BacktestService-152"><span class="linenos">152</span></a>        <span class="n">strategy_func</span> <span class="o">=</span> <span class="n">load_function</span><span class="p">(</span><span class="n">strategy_path</span><span class="p">)</span>
</span><span id="BacktestService-153"><a href="#BacktestService-153"><span class="linenos">153</span></a>        
</span><span id="BacktestService-154"><a href="#BacktestService-154"><span class="linenos">154</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2"> loaded succesfully&quot;</span><span class="p">)</span>
</span><span id="BacktestService-155"><a href="#BacktestService-155"><span class="linenos">155</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading leverages&quot;</span><span class="p">)</span>
</span><span id="BacktestService-156"><a href="#BacktestService-156"><span class="linenos">156</span></a>
</span><span id="BacktestService-157"><a href="#BacktestService-157"><span class="linenos">157</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./app/configs/leverages.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_name</span><span class="p">:</span>
</span><span id="BacktestService-158"><a href="#BacktestService-158"><span class="linenos">158</span></a>            <span class="n">leverages</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService-159"><a href="#BacktestService-159"><span class="linenos">159</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Leverages loaded&quot;</span><span class="p">)</span>
</span><span id="BacktestService-160"><a href="#BacktestService-160"><span class="linenos">160</span></a>
</span><span id="BacktestService-161"><a href="#BacktestService-161"><span class="linenos">161</span></a>        <span class="n">leverage</span> <span class="o">=</span> <span class="n">leverages</span><span class="p">[</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
</span><span id="BacktestService-162"><a href="#BacktestService-162"><span class="linenos">162</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">leverage</span>
</span><span id="BacktestService-163"><a href="#BacktestService-163"><span class="linenos">163</span></a>        
</span><span id="BacktestService-164"><a href="#BacktestService-164"><span class="linenos">164</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Getting data&quot;</span><span class="p">)</span>
</span><span id="BacktestService-165"><a href="#BacktestService-165"><span class="linenos">165</span></a>
</span><span id="BacktestService-166"><a href="#BacktestService-166"><span class="linenos">166</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">MetaTraderNumber</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="BacktestService-167"><a href="#BacktestService-167"><span class="linenos">167</span></a>        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="BacktestService-168"><a href="#BacktestService-168"><span class="linenos">168</span></a>
</span><span id="BacktestService-169"><a href="#BacktestService-169"><span class="linenos">169</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data ready: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService-170"><a href="#BacktestService-170"><span class="linenos">170</span></a>
</span><span id="BacktestService-171"><a href="#BacktestService-171"><span class="linenos">171</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting backtest&quot;</span><span class="p">)</span>
</span><span id="BacktestService-172"><a href="#BacktestService-172"><span class="linenos">172</span></a>
</span><span id="BacktestService-173"><a href="#BacktestService-173"><span class="linenos">173</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_from</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_to</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService-174"><a href="#BacktestService-174"><span class="linenos">174</span></a>        <span class="n">plot_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService-175"><a href="#BacktestService-175"><span class="linenos">175</span></a>
</span><span id="BacktestService-176"><a href="#BacktestService-176"><span class="linenos">176</span></a>        <span class="k">if</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;temp&#39;</span><span class="p">:</span>
</span><span id="BacktestService-177"><a href="#BacktestService-177"><span class="linenos">177</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots/temp&#39;</span>
</span><span id="BacktestService-178"><a href="#BacktestService-178"><span class="linenos">178</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/backtest_plots/temp&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span><span class="p">))</span>
</span><span id="BacktestService-179"><a href="#BacktestService-179"><span class="linenos">179</span></a>
</span><span id="BacktestService-180"><a href="#BacktestService-180"><span class="linenos">180</span></a>        <span class="k">elif</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span><span class="p">:</span>
</span><span id="BacktestService-181"><a href="#BacktestService-181"><span class="linenos">181</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots&#39;</span>
</span><span id="BacktestService-182"><a href="#BacktestService-182"><span class="linenos">182</span></a>
</span><span id="BacktestService-183"><a href="#BacktestService-183"><span class="linenos">183</span></a>        <span class="n">risk_free_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_service</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="s1">&#39;RiskFreeRate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
</span><span id="BacktestService-184"><a href="#BacktestService-184"><span class="linenos">184</span></a>
</span><span id="BacktestService-185"><a href="#BacktestService-185"><span class="linenos">185</span></a>        <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">run_strategy_and_get_performances</span><span class="p">(</span>
</span><span id="BacktestService-186"><a href="#BacktestService-186"><span class="linenos">186</span></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy_func</span><span class="p">,</span>
</span><span id="BacktestService-187"><a href="#BacktestService-187"><span class="linenos">187</span></a>            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="BacktestService-188"><a href="#BacktestService-188"><span class="linenos">188</span></a>            <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="BacktestService-189"><a href="#BacktestService-189"><span class="linenos">189</span></a>            <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="BacktestService-190"><a href="#BacktestService-190"><span class="linenos">190</span></a>            <span class="n">prices</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span>
</span><span id="BacktestService-191"><a href="#BacktestService-191"><span class="linenos">191</span></a>            <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService-192"><a href="#BacktestService-192"><span class="linenos">192</span></a>            <span class="n">risk_free_rate</span><span class="o">=</span><span class="n">risk_free_rate</span><span class="p">,</span>
</span><span id="BacktestService-193"><a href="#BacktestService-193"><span class="linenos">193</span></a>            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
</span><span id="BacktestService-194"><a href="#BacktestService-194"><span class="linenos">194</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span>
</span><span id="BacktestService-195"><a href="#BacktestService-195"><span class="linenos">195</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="BacktestService-196"><a href="#BacktestService-196"><span class="linenos">196</span></a>            <span class="n">save_report</span><span class="o">=</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span> <span class="c1"># Solo genera el reporte si no es una corrida temporal</span>
</span><span id="BacktestService-197"><a href="#BacktestService-197"><span class="linenos">197</span></a>        <span class="p">)</span>
</span><span id="BacktestService-198"><a href="#BacktestService-198"><span class="linenos">198</span></a>
</span><span id="BacktestService-199"><a href="#BacktestService-199"><span class="linenos">199</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest is done :)&quot;</span><span class="p">)</span>
</span><span id="BacktestService-200"><a href="#BacktestService-200"><span class="linenos">200</span></a>
</span><span id="BacktestService-201"><a href="#BacktestService-201"><span class="linenos">201</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService-202"><a href="#BacktestService-202"><span class="linenos">202</span></a>        
</span><span id="BacktestService-203"><a href="#BacktestService-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span>
</span><span id="BacktestService-204"><a href="#BacktestService-204"><span class="linenos">204</span></a>
</span><span id="BacktestService-205"><a href="#BacktestService-205"><span class="linenos">205</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="BacktestService-206"><a href="#BacktestService-206"><span class="linenos">206</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtests_and_save</span><span class="p">(</span>
</span><span id="BacktestService-207"><a href="#BacktestService-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService-208"><a href="#BacktestService-208"><span class="linenos">208</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService-209"><a href="#BacktestService-209"><span class="linenos">209</span></a>        <span class="n">strategies</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
</span><span id="BacktestService-210"><a href="#BacktestService-210"><span class="linenos">210</span></a>        <span class="n">tickers</span><span class="p">:</span> <span class="n">Ticker</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Ticker</span><span class="p">],</span>
</span><span id="BacktestService-211"><a href="#BacktestService-211"><span class="linenos">211</span></a>        <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Timeframe</span><span class="p">],</span>
</span><span id="BacktestService-212"><a href="#BacktestService-212"><span class="linenos">212</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="BacktestService-213"><a href="#BacktestService-213"><span class="linenos">213</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="BacktestService-214"><a href="#BacktestService-214"><span class="linenos">214</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService-215"><a href="#BacktestService-215"><span class="linenos">215</span></a>        <span class="n">risks</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="BacktestService-216"><a href="#BacktestService-216"><span class="linenos">216</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService-217"><a href="#BacktestService-217"><span class="linenos">217</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="BacktestService-218"><a href="#BacktestService-218"><span class="linenos">218</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BacktestService-219"><a href="#BacktestService-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BacktestService-220"><a href="#BacktestService-220"><span class="linenos">220</span></a><span class="sd">        Executes multiple backtests in parallel for all combinations of strategies, tickers, timeframes and risks,</span>
</span><span id="BacktestService-221"><a href="#BacktestService-221"><span class="linenos">221</span></a><span class="sd">        then saves results to the database while streaming progress updates.</span>
</span><span id="BacktestService-222"><a href="#BacktestService-222"><span class="linenos">222</span></a>
</span><span id="BacktestService-223"><a href="#BacktestService-223"><span class="linenos">223</span></a><span class="sd">        This function handles the complete backtesting pipeline:</span>
</span><span id="BacktestService-224"><a href="#BacktestService-224"><span class="linenos">224</span></a><span class="sd">        - Generates all possible combinations of input parameters</span>
</span><span id="BacktestService-225"><a href="#BacktestService-225"><span class="linenos">225</span></a><span class="sd">        - Checks for existing backtest results to avoid duplicate work</span>
</span><span id="BacktestService-226"><a href="#BacktestService-226"><span class="linenos">226</span></a><span class="sd">        - Runs new backtests when needed using run_backtest()</span>
</span><span id="BacktestService-227"><a href="#BacktestService-227"><span class="linenos">227</span></a><span class="sd">        - Saves performance metrics, trade details, and statistics to the database</span>
</span><span id="BacktestService-228"><a href="#BacktestService-228"><span class="linenos">228</span></a><span class="sd">        - Provides real-time feedback through an async queue</span>
</span><span id="BacktestService-229"><a href="#BacktestService-229"><span class="linenos">229</span></a>
</span><span id="BacktestService-230"><a href="#BacktestService-230"><span class="linenos">230</span></a><span class="sd">        Steps performed:</span>
</span><span id="BacktestService-231"><a href="#BacktestService-231"><span class="linenos">231</span></a><span class="sd">        1. Normalizes all input parameters to lists (single items → single-element lists)</span>
</span><span id="BacktestService-232"><a href="#BacktestService-232"><span class="linenos">232</span></a><span class="sd">        2. Generates all combinations of strategies/tickers/timeframes/risks</span>
</span><span id="BacktestService-233"><a href="#BacktestService-233"><span class="linenos">233</span></a><span class="sd">        3. For each combination:</span>
</span><span id="BacktestService-234"><a href="#BacktestService-234"><span class="linenos">234</span></a><span class="sd">        - Checks if bot exists in database</span>
</span><span id="BacktestService-235"><a href="#BacktestService-235"><span class="linenos">235</span></a><span class="sd">        - Verifies if backtest already exists for the date range</span>
</span><span id="BacktestService-236"><a href="#BacktestService-236"><span class="linenos">236</span></a><span class="sd">        - Runs new backtest if needed</span>
</span><span id="BacktestService-237"><a href="#BacktestService-237"><span class="linenos">237</span></a><span class="sd">        - Converts results to database objects</span>
</span><span id="BacktestService-238"><a href="#BacktestService-238"><span class="linenos">238</span></a><span class="sd">        - Saves all data (bot, performance, trades) transactionally</span>
</span><span id="BacktestService-239"><a href="#BacktestService-239"><span class="linenos">239</span></a><span class="sd">        4. Streams progress, warnings, and completion messages via queue</span>
</span><span id="BacktestService-240"><a href="#BacktestService-240"><span class="linenos">240</span></a>
</span><span id="BacktestService-241"><a href="#BacktestService-241"><span class="linenos">241</span></a><span class="sd">        Parameters:</span>
</span><span id="BacktestService-242"><a href="#BacktestService-242"><span class="linenos">242</span></a><span class="sd">        - initial_cash (float): Starting capital for all backtests</span>
</span><span id="BacktestService-243"><a href="#BacktestService-243"><span class="linenos">243</span></a><span class="sd">        - strategies (Strategy|List[Strategy]): Single strategy or list to test</span>
</span><span id="BacktestService-244"><a href="#BacktestService-244"><span class="linenos">244</span></a><span class="sd">        - tickers (Ticker|List[Ticker]): Financial instrument(s) to backtest</span>
</span><span id="BacktestService-245"><a href="#BacktestService-245"><span class="linenos">245</span></a><span class="sd">        - timeframes (List[Timeframe]): Time intervals to test (e.g. [&#39;1H&#39;, &#39;4H&#39;])</span>
</span><span id="BacktestService-246"><a href="#BacktestService-246"><span class="linenos">246</span></a><span class="sd">        - date_from (date): Start date for historical data</span>
</span><span id="BacktestService-247"><a href="#BacktestService-247"><span class="linenos">247</span></a><span class="sd">        - date_to (date): End date for historical data</span>
</span><span id="BacktestService-248"><a href="#BacktestService-248"><span class="linenos">248</span></a><span class="sd">        - method (str): Backtesting methodology identifier</span>
</span><span id="BacktestService-249"><a href="#BacktestService-249"><span class="linenos">249</span></a><span class="sd">        - risks (float|List[float]): Risk percentage(s) per trade (e.g. [0.01, 0.02])</span>
</span><span id="BacktestService-250"><a href="#BacktestService-250"><span class="linenos">250</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode:</span>
</span><span id="BacktestService-251"><a href="#BacktestService-251"><span class="linenos">251</span></a><span class="sd">            - &#39;temp&#39;: Temporary storage</span>
</span><span id="BacktestService-252"><a href="#BacktestService-252"><span class="linenos">252</span></a><span class="sd">            - &#39;persist&#39;: Permanent storage</span>
</span><span id="BacktestService-253"><a href="#BacktestService-253"><span class="linenos">253</span></a><span class="sd">            - Other: Skip plot generation</span>
</span><span id="BacktestService-254"><a href="#BacktestService-254"><span class="linenos">254</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for progress streaming</span>
</span><span id="BacktestService-255"><a href="#BacktestService-255"><span class="linenos">255</span></a>
</span><span id="BacktestService-256"><a href="#BacktestService-256"><span class="linenos">256</span></a><span class="sd">        Returns:</span>
</span><span id="BacktestService-257"><a href="#BacktestService-257"><span class="linenos">257</span></a><span class="sd">        - AsyncGenerator[str, None]: Yields list of saved BotPerformance objects when complete</span>
</span><span id="BacktestService-258"><a href="#BacktestService-258"><span class="linenos">258</span></a>
</span><span id="BacktestService-259"><a href="#BacktestService-259"><span class="linenos">259</span></a><span class="sd">        Side effects:</span>
</span><span id="BacktestService-260"><a href="#BacktestService-260"><span class="linenos">260</span></a><span class="sd">        - Creates/updates database records for:</span>
</span><span id="BacktestService-261"><a href="#BacktestService-261"><span class="linenos">261</span></a><span class="sd">            - Bot configurations</span>
</span><span id="BacktestService-262"><a href="#BacktestService-262"><span class="linenos">262</span></a><span class="sd">            - Performance metrics</span>
</span><span id="BacktestService-263"><a href="#BacktestService-263"><span class="linenos">263</span></a><span class="sd">            - Individual trades</span>
</span><span id="BacktestService-264"><a href="#BacktestService-264"><span class="linenos">264</span></a><span class="sd">        - May generate plot files depending on save_bt_plot parameter</span>
</span><span id="BacktestService-265"><a href="#BacktestService-265"><span class="linenos">265</span></a><span class="sd">        - Streams messages to provided queue including:</span>
</span><span id="BacktestService-266"><a href="#BacktestService-266"><span class="linenos">266</span></a><span class="sd">            - Progress logs</span>
</span><span id="BacktestService-267"><a href="#BacktestService-267"><span class="linenos">267</span></a><span class="sd">            - Warnings about duplicates</span>
</span><span id="BacktestService-268"><a href="#BacktestService-268"><span class="linenos">268</span></a><span class="sd">            - Completion/failure notifications</span>
</span><span id="BacktestService-269"><a href="#BacktestService-269"><span class="linenos">269</span></a>
</span><span id="BacktestService-270"><a href="#BacktestService-270"><span class="linenos">270</span></a><span class="sd">        Notes:</span>
</span><span id="BacktestService-271"><a href="#BacktestService-271"><span class="linenos">271</span></a><span class="sd">        - Automatically skips existing backtests for the same parameters/date range</span>
</span><span id="BacktestService-272"><a href="#BacktestService-272"><span class="linenos">272</span></a><span class="sd">        - Uses atomic database transactions to ensure data consistency</span>
</span><span id="BacktestService-273"><a href="#BacktestService-273"><span class="linenos">273</span></a><span class="sd">        - New bots are created if they don&#39;t exist in the database</span>
</span><span id="BacktestService-274"><a href="#BacktestService-274"><span class="linenos">274</span></a><span class="sd">        - Trade history is extracted from backtest stats and saved relationally</span>
</span><span id="BacktestService-275"><a href="#BacktestService-275"><span class="linenos">275</span></a><span class="sd">        - All database operations use the service&#39;s db_service interface</span>
</span><span id="BacktestService-276"><a href="#BacktestService-276"><span class="linenos">276</span></a><span class="sd">        - Failures for individual combinations don&#39;t stop overall execution</span>
</span><span id="BacktestService-277"><a href="#BacktestService-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BacktestService-278"><a href="#BacktestService-278"><span class="linenos">278</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BacktestService-279"><a href="#BacktestService-279"><span class="linenos">279</span></a>            <span class="n">backtests</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BacktestService-280"><a href="#BacktestService-280"><span class="linenos">280</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService-281"><a href="#BacktestService-281"><span class="linenos">281</span></a>
</span><span id="BacktestService-282"><a href="#BacktestService-282"><span class="linenos">282</span></a>            <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategies</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">strategies</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">strategies</span>
</span><span id="BacktestService-283"><a href="#BacktestService-283"><span class="linenos">283</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tickers</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">tickers</span>
</span><span id="BacktestService-284"><a href="#BacktestService-284"><span class="linenos">284</span></a>            <span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeframes</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">timeframes</span>
</span><span id="BacktestService-285"><a href="#BacktestService-285"><span class="linenos">285</span></a>            <span class="n">risks</span> <span class="o">=</span> <span class="p">[</span><span class="n">risks</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">risks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">risks</span>
</span><span id="BacktestService-286"><a href="#BacktestService-286"><span class="linenos">286</span></a>  
</span><span id="BacktestService-287"><a href="#BacktestService-287"><span class="linenos">287</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">strategies</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">,</span> <span class="n">risks</span><span class="p">)</span>
</span><span id="BacktestService-288"><a href="#BacktestService-288"><span class="linenos">288</span></a>
</span><span id="BacktestService-289"><a href="#BacktestService-289"><span class="linenos">289</span></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_iterator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">)):</span>
</span><span id="BacktestService-290"><a href="#BacktestService-290"><span class="linenos">290</span></a>                <span class="n">strategy</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">risk</span> <span class="o">=</span> <span class="n">combination</span>
</span><span id="BacktestService-291"><a href="#BacktestService-291"><span class="linenos">291</span></a>
</span><span id="BacktestService-292"><a href="#BacktestService-292"><span class="linenos">292</span></a>                <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BacktestService-293"><a href="#BacktestService-293"><span class="linenos">293</span></a>
</span><span id="BacktestService-294"><a href="#BacktestService-294"><span class="linenos">294</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting&quot;</span><span class="p">)</span>
</span><span id="BacktestService-295"><a href="#BacktestService-295"><span class="linenos">295</span></a>                
</span><span id="BacktestService-296"><a href="#BacktestService-296"><span class="linenos">296</span></a>                <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService-297"><a href="#BacktestService-297"><span class="linenos">297</span></a>                
</span><span id="BacktestService-298"><a href="#BacktestService-298"><span class="linenos">298</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking bot in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService-299"><a href="#BacktestService-299"><span class="linenos">299</span></a>
</span><span id="BacktestService-300"><a href="#BacktestService-300"><span class="linenos">300</span></a>                <span class="n">bot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_service</span><span class="o">.</span><span class="n">get_bot</span><span class="p">(</span>
</span><span id="BacktestService-301"><a href="#BacktestService-301"><span class="linenos">301</span></a>                    <span class="n">strategy_id</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-302"><a href="#BacktestService-302"><span class="linenos">302</span></a>                    <span class="n">ticker_id</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-303"><a href="#BacktestService-303"><span class="linenos">303</span></a>                    <span class="n">timeframe_id</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-304"><a href="#BacktestService-304"><span class="linenos">304</span></a>                    <span class="n">risk</span><span class="o">=</span><span class="n">risk</span>   
</span><span id="BacktestService-305"><a href="#BacktestService-305"><span class="linenos">305</span></a>                <span class="p">)</span>
</span><span id="BacktestService-306"><a href="#BacktestService-306"><span class="linenos">306</span></a>                
</span><span id="BacktestService-307"><a href="#BacktestService-307"><span class="linenos">307</span></a>                <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BacktestService-308"><a href="#BacktestService-308"><span class="linenos">308</span></a>
</span><span id="BacktestService-309"><a href="#BacktestService-309"><span class="linenos">309</span></a>                <span class="k">if</span> <span class="n">bot</span><span class="p">:</span>
</span><span id="BacktestService-310"><a href="#BacktestService-310"><span class="linenos">310</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot already exists&quot;</span><span class="p">)</span>
</span><span id="BacktestService-311"><a href="#BacktestService-311"><span class="linenos">311</span></a>
</span><span id="BacktestService-312"><a href="#BacktestService-312"><span class="linenos">312</span></a>                    <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BacktestService-313"><a href="#BacktestService-313"><span class="linenos">313</span></a>
</span><span id="BacktestService-314"><a href="#BacktestService-314"><span class="linenos">314</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking backtest in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService-315"><a href="#BacktestService-315"><span class="linenos">315</span></a>                    <span class="n">result_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performances_by_bot_dates</span><span class="p">(</span>
</span><span id="BacktestService-316"><a href="#BacktestService-316"><span class="linenos">316</span></a>                        <span class="n">bot_id</span><span class="o">=</span><span class="n">bot</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> 
</span><span id="BacktestService-317"><a href="#BacktestService-317"><span class="linenos">317</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span> 
</span><span id="BacktestService-318"><a href="#BacktestService-318"><span class="linenos">318</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span>
</span><span id="BacktestService-319"><a href="#BacktestService-319"><span class="linenos">319</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-320"><a href="#BacktestService-320"><span class="linenos">320</span></a>                    
</span><span id="BacktestService-321"><a href="#BacktestService-321"><span class="linenos">321</span></a>                    <span class="k">if</span> <span class="n">result_performance</span><span class="p">:</span>
</span><span id="BacktestService-322"><a href="#BacktestService-322"><span class="linenos">322</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_performance</span><span class="p">)</span>
</span><span id="BacktestService-323"><a href="#BacktestService-323"><span class="linenos">323</span></a>                        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest already exists. Skipping...&quot;</span><span class="p">)</span>
</span><span id="BacktestService-324"><a href="#BacktestService-324"><span class="linenos">324</span></a>                        <span class="k">continue</span>
</span><span id="BacktestService-325"><a href="#BacktestService-325"><span class="linenos">325</span></a>
</span><span id="BacktestService-326"><a href="#BacktestService-326"><span class="linenos">326</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BacktestService-327"><a href="#BacktestService-327"><span class="linenos">327</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot is not in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService-328"><a href="#BacktestService-328"><span class="linenos">328</span></a>                    <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span>
</span><span id="BacktestService-329"><a href="#BacktestService-329"><span class="linenos">329</span></a>                        <span class="n">Name</span><span class="o">=</span><span class="n">bot_name</span><span class="p">,</span>
</span><span id="BacktestService-330"><a href="#BacktestService-330"><span class="linenos">330</span></a>                        <span class="n">StrategyId</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-331"><a href="#BacktestService-331"><span class="linenos">331</span></a>                        <span class="n">TickerId</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-332"><a href="#BacktestService-332"><span class="linenos">332</span></a>                        <span class="n">TimeframeId</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService-333"><a href="#BacktestService-333"><span class="linenos">333</span></a>                        <span class="n">Risk</span><span class="o">=</span><span class="n">risk</span>
</span><span id="BacktestService-334"><a href="#BacktestService-334"><span class="linenos">334</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-335"><a href="#BacktestService-335"><span class="linenos">335</span></a>
</span><span id="BacktestService-336"><a href="#BacktestService-336"><span class="linenos">336</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="BacktestService-337"><a href="#BacktestService-337"><span class="linenos">337</span></a>                    <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span>
</span><span id="BacktestService-338"><a href="#BacktestService-338"><span class="linenos">338</span></a>                        <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService-339"><a href="#BacktestService-339"><span class="linenos">339</span></a>                        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="BacktestService-340"><a href="#BacktestService-340"><span class="linenos">340</span></a>                        <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="BacktestService-341"><a href="#BacktestService-341"><span class="linenos">341</span></a>                        <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="BacktestService-342"><a href="#BacktestService-342"><span class="linenos">342</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span>
</span><span id="BacktestService-343"><a href="#BacktestService-343"><span class="linenos">343</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span><span class="p">,</span>
</span><span id="BacktestService-344"><a href="#BacktestService-344"><span class="linenos">344</span></a>                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
</span><span id="BacktestService-345"><a href="#BacktestService-345"><span class="linenos">345</span></a>                        <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="BacktestService-346"><a href="#BacktestService-346"><span class="linenos">346</span></a>                        <span class="n">save_bt_plot</span><span class="o">=</span><span class="n">save_bt_plot</span><span class="p">,</span>
</span><span id="BacktestService-347"><a href="#BacktestService-347"><span class="linenos">347</span></a>                        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
</span><span id="BacktestService-348"><a href="#BacktestService-348"><span class="linenos">348</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-349"><a href="#BacktestService-349"><span class="linenos">349</span></a>
</span><span id="BacktestService-350"><a href="#BacktestService-350"><span class="linenos">350</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Saving metrics in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService-351"><a href="#BacktestService-351"><span class="linenos">351</span></a>
</span><span id="BacktestService-352"><a href="#BacktestService-352"><span class="linenos">352</span></a>                    <span class="n">bot_performance_for_db</span> <span class="o">=</span> <span class="n">_performance_from_df_to_obj</span><span class="p">(</span>
</span><span id="BacktestService-353"><a href="#BacktestService-353"><span class="linenos">353</span></a>                        <span class="n">performance</span><span class="p">,</span> 
</span><span id="BacktestService-354"><a href="#BacktestService-354"><span class="linenos">354</span></a>                        <span class="n">date_from</span><span class="p">,</span> 
</span><span id="BacktestService-355"><a href="#BacktestService-355"><span class="linenos">355</span></a>                        <span class="n">date_to</span><span class="p">,</span> 
</span><span id="BacktestService-356"><a href="#BacktestService-356"><span class="linenos">356</span></a>                        <span class="n">risk</span><span class="p">,</span> 
</span><span id="BacktestService-357"><a href="#BacktestService-357"><span class="linenos">357</span></a>                        <span class="n">method</span><span class="p">,</span> 
</span><span id="BacktestService-358"><a href="#BacktestService-358"><span class="linenos">358</span></a>                        <span class="n">bot</span><span class="p">,</span>
</span><span id="BacktestService-359"><a href="#BacktestService-359"><span class="linenos">359</span></a>                        <span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService-360"><a href="#BacktestService-360"><span class="linenos">360</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-361"><a href="#BacktestService-361"><span class="linenos">361</span></a>                    
</span><span id="BacktestService-362"><a href="#BacktestService-362"><span class="linenos">362</span></a>                    <span class="n">trade_performance_for_db</span> <span class="o">=</span> <span class="p">[</span><span class="n">BotTradePerformance</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trade_performance</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="BacktestService-363"><a href="#BacktestService-363"><span class="linenos">363</span></a>                    <span class="n">trade_performance_for_db</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span> 
</span><span id="BacktestService-364"><a href="#BacktestService-364"><span class="linenos">364</span></a>                    
</span><span id="BacktestService-365"><a href="#BacktestService-365"><span class="linenos">365</span></a>                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-366"><a href="#BacktestService-366"><span class="linenos">366</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_exists</span><span class="p">:</span>
</span><span id="BacktestService-367"><a href="#BacktestService-367"><span class="linenos">367</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
</span><span id="BacktestService-368"><a href="#BacktestService-368"><span class="linenos">368</span></a>                        
</span><span id="BacktestService-369"><a href="#BacktestService-369"><span class="linenos">369</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot_performance_for_db</span><span class="p">))</span>
</span><span id="BacktestService-370"><a href="#BacktestService-370"><span class="linenos">370</span></a>
</span><span id="BacktestService-371"><a href="#BacktestService-371"><span class="linenos">371</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade_performance_for_db</span><span class="p">)</span>
</span><span id="BacktestService-372"><a href="#BacktestService-372"><span class="linenos">372</span></a>                        
</span><span id="BacktestService-373"><a href="#BacktestService-373"><span class="linenos">373</span></a>                        <span class="n">trade_history</span> <span class="o">=</span> <span class="n">trades_from_df_to_obj</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">_trades</span><span class="p">)</span>
</span><span id="BacktestService-374"><a href="#BacktestService-374"><span class="linenos">374</span></a>
</span><span id="BacktestService-375"><a href="#BacktestService-375"><span class="linenos">375</span></a>                        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_history</span><span class="p">:</span>
</span><span id="BacktestService-376"><a href="#BacktestService-376"><span class="linenos">376</span></a>                            <span class="n">trade</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span>
</span><span id="BacktestService-377"><a href="#BacktestService-377"><span class="linenos">377</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade</span><span class="p">)</span>
</span><span id="BacktestService-378"><a href="#BacktestService-378"><span class="linenos">378</span></a>
</span><span id="BacktestService-379"><a href="#BacktestService-379"><span class="linenos">379</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;It&#39;s done buddy ;)&quot;</span><span class="p">)</span>
</span><span id="BacktestService-380"><a href="#BacktestService-380"><span class="linenos">380</span></a>                
</span><span id="BacktestService-381"><a href="#BacktestService-381"><span class="linenos">381</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BacktestService-382"><a href="#BacktestService-382"><span class="linenos">382</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService-383"><a href="#BacktestService-383"><span class="linenos">383</span></a>            
</span><span id="BacktestService-384"><a href="#BacktestService-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="n">backtests</span>
</span><span id="BacktestService-385"><a href="#BacktestService-385"><span class="linenos">385</span></a>            
</span><span id="BacktestService-386"><a href="#BacktestService-386"><span class="linenos">386</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BacktestService-387"><a href="#BacktestService-387"><span class="linenos">387</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService-388"><a href="#BacktestService-388"><span class="linenos">388</span></a>
</span><span id="BacktestService-389"><a href="#BacktestService-389"><span class="linenos">389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_strategy_ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">,</span> <span class="n">ticker_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="BacktestService-390"><a href="#BacktestService-390"><span class="linenos">390</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-391"><a href="#BacktestService-391"><span class="linenos">391</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-392"><a href="#BacktestService-392"><span class="linenos">392</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService-393"><a href="#BacktestService-393"><span class="linenos">393</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-394"><a href="#BacktestService-394"><span class="linenos">394</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">ticker_id</span><span class="p">)</span>
</span><span id="BacktestService-395"><a href="#BacktestService-395"><span class="linenos">395</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService-396"><a href="#BacktestService-396"><span class="linenos">396</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">))</span>
</span><span id="BacktestService-397"><a href="#BacktestService-397"><span class="linenos">397</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService-398"><a href="#BacktestService-398"><span class="linenos">398</span></a>            <span class="p">)</span>
</span><span id="BacktestService-399"><a href="#BacktestService-399"><span class="linenos">399</span></a>
</span><span id="BacktestService-400"><a href="#BacktestService-400"><span class="linenos">400</span></a>            <span class="k">return</span> <span class="n">bot_performances</span>
</span><span id="BacktestService-401"><a href="#BacktestService-401"><span class="linenos">401</span></a>
</span><span id="BacktestService-402"><a href="#BacktestService-402"><span class="linenos">402</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_bot_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="BacktestService-403"><a href="#BacktestService-403"><span class="linenos">403</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-404"><a href="#BacktestService-404"><span class="linenos">404</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-405"><a href="#BacktestService-405"><span class="linenos">405</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService-406"><a href="#BacktestService-406"><span class="linenos">406</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService-407"><a href="#BacktestService-407"><span class="linenos">407</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">RandomTestPerformance</span><span class="p">),</span>
</span><span id="BacktestService-408"><a href="#BacktestService-408"><span class="linenos">408</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformance</span><span class="p">),</span>
</span><span id="BacktestService-409"><a href="#BacktestService-409"><span class="linenos">409</span></a>                <span class="p">)</span>
</span><span id="BacktestService-410"><a href="#BacktestService-410"><span class="linenos">410</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_id</span><span class="p">)</span>
</span><span id="BacktestService-411"><a href="#BacktestService-411"><span class="linenos">411</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateFrom</span> <span class="o">==</span> <span class="n">date_from</span><span class="p">)</span>
</span><span id="BacktestService-412"><a href="#BacktestService-412"><span class="linenos">412</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateTo</span> <span class="o">==</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="BacktestService-413"><a href="#BacktestService-413"><span class="linenos">413</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="BacktestService-414"><a href="#BacktestService-414"><span class="linenos">414</span></a>            <span class="p">)</span>
</span><span id="BacktestService-415"><a href="#BacktestService-415"><span class="linenos">415</span></a>            
</span><span id="BacktestService-416"><a href="#BacktestService-416"><span class="linenos">416</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="BacktestService-417"><a href="#BacktestService-417"><span class="linenos">417</span></a>     
</span><span id="BacktestService-418"><a href="#BacktestService-418"><span class="linenos">418</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performance_by_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="BacktestService-419"><a href="#BacktestService-419"><span class="linenos">419</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-420"><a href="#BacktestService-420"><span class="linenos">420</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">BotId</span><span class="o">=</span><span class="n">bot_id</span><span class="p">)</span>  
</span><span id="BacktestService-421"><a href="#BacktestService-421"><span class="linenos">421</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="BacktestService-422"><a href="#BacktestService-422"><span class="linenos">422</span></a>            
</span><span id="BacktestService-423"><a href="#BacktestService-423"><span class="linenos">423</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bot_performance_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="BacktestService-424"><a href="#BacktestService-424"><span class="linenos">424</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-425"><a href="#BacktestService-425"><span class="linenos">425</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="BacktestService-426"><a href="#BacktestService-426"><span class="linenos">426</span></a>
</span><span id="BacktestService-427"><a href="#BacktestService-427"><span class="linenos">427</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span><span id="BacktestService-428"><a href="#BacktestService-428"><span class="linenos">428</span></a>
</span><span id="BacktestService-429"><a href="#BacktestService-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_from_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService-430"><a href="#BacktestService-430"><span class="linenos">430</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-431"><a href="#BacktestService-431"><span class="linenos">431</span></a>            <span class="n">bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-432"><a href="#BacktestService-432"><span class="linenos">432</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-433"><a href="#BacktestService-433"><span class="linenos">433</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-434"><a href="#BacktestService-434"><span class="linenos">434</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService-435"><a href="#BacktestService-435"><span class="linenos">435</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-436"><a href="#BacktestService-436"><span class="linenos">436</span></a>
</span><span id="BacktestService-437"><a href="#BacktestService-437"><span class="linenos">437</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-438"><a href="#BacktestService-438"><span class="linenos">438</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MetricWharehouse</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="BacktestService-439"><a href="#BacktestService-439"><span class="linenos">439</span></a>                    <span class="n">MetricWharehouse</span><span class="o">.</span><span class="n">MontecarloTestId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
</span><span id="BacktestService-440"><a href="#BacktestService-440"><span class="linenos">440</span></a>                        <span class="n">select</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-441"><a href="#BacktestService-441"><span class="linenos">441</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-442"><a href="#BacktestService-442"><span class="linenos">442</span></a>                <span class="p">)</span>
</span><span id="BacktestService-443"><a href="#BacktestService-443"><span class="linenos">443</span></a>            <span class="p">)</span>
</span><span id="BacktestService-444"><a href="#BacktestService-444"><span class="linenos">444</span></a>
</span><span id="BacktestService-445"><a href="#BacktestService-445"><span class="linenos">445</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-446"><a href="#BacktestService-446"><span class="linenos">446</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-447"><a href="#BacktestService-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="BacktestService-448"><a href="#BacktestService-448"><span class="linenos">448</span></a>
</span><span id="BacktestService-449"><a href="#BacktestService-449"><span class="linenos">449</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-450"><a href="#BacktestService-450"><span class="linenos">450</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-451"><a href="#BacktestService-451"><span class="linenos">451</span></a>            <span class="p">)</span>
</span><span id="BacktestService-452"><a href="#BacktestService-452"><span class="linenos">452</span></a>
</span><span id="BacktestService-453"><a href="#BacktestService-453"><span class="linenos">453</span></a>            <span class="n">lucktest_bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-454"><a href="#BacktestService-454"><span class="linenos">454</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService-455"><a href="#BacktestService-455"><span class="linenos">455</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-456"><a href="#BacktestService-456"><span class="linenos">456</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-457"><a href="#BacktestService-457"><span class="linenos">457</span></a>
</span><span id="BacktestService-458"><a href="#BacktestService-458"><span class="linenos">458</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService-459"><a href="#BacktestService-459"><span class="linenos">459</span></a>
</span><span id="BacktestService-460"><a href="#BacktestService-460"><span class="linenos">460</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">lucktest_bp_subq</span><span class="p">)))</span>
</span><span id="BacktestService-461"><a href="#BacktestService-461"><span class="linenos">461</span></a>
</span><span id="BacktestService-462"><a href="#BacktestService-462"><span class="linenos">462</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-463"><a href="#BacktestService-463"><span class="linenos">463</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-464"><a href="#BacktestService-464"><span class="linenos">464</span></a>            <span class="p">)</span>
</span><span id="BacktestService-465"><a href="#BacktestService-465"><span class="linenos">465</span></a>
</span><span id="BacktestService-466"><a href="#BacktestService-466"><span class="linenos">466</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-467"><a href="#BacktestService-467"><span class="linenos">467</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-468"><a href="#BacktestService-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="BacktestService-469"><a href="#BacktestService-469"><span class="linenos">469</span></a>
</span><span id="BacktestService-470"><a href="#BacktestService-470"><span class="linenos">470</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-471"><a href="#BacktestService-471"><span class="linenos">471</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Trade</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Trade</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-472"><a href="#BacktestService-472"><span class="linenos">472</span></a>            <span class="p">)</span>
</span><span id="BacktestService-473"><a href="#BacktestService-473"><span class="linenos">473</span></a>
</span><span id="BacktestService-474"><a href="#BacktestService-474"><span class="linenos">474</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-475"><a href="#BacktestService-475"><span class="linenos">475</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService-476"><a href="#BacktestService-476"><span class="linenos">476</span></a>            <span class="p">)</span>
</span><span id="BacktestService-477"><a href="#BacktestService-477"><span class="linenos">477</span></a>
</span><span id="BacktestService-478"><a href="#BacktestService-478"><span class="linenos">478</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService-479"><a href="#BacktestService-479"><span class="linenos">479</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService-480"><a href="#BacktestService-480"><span class="linenos">480</span></a>            <span class="p">)</span>
</span><span id="BacktestService-481"><a href="#BacktestService-481"><span class="linenos">481</span></a>        
</span><span id="BacktestService-482"><a href="#BacktestService-482"><span class="linenos">482</span></a>        <span class="c1"># Borrar archivos relacionados</span>
</span><span id="BacktestService-483"><a href="#BacktestService-483"><span class="linenos">483</span></a>        <span class="k">for</span> <span class="n">bot_performance</span> <span class="ow">in</span> <span class="n">bot_performances</span><span class="p">:</span>
</span><span id="BacktestService-484"><a href="#BacktestService-484"><span class="linenos">484</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService-485"><a href="#BacktestService-485"><span class="linenos">485</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService-486"><a href="#BacktestService-486"><span class="linenos">486</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="BacktestService-487"><a href="#BacktestService-487"><span class="linenos">487</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="BacktestService-488"><a href="#BacktestService-488"><span class="linenos">488</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService-489"><a href="#BacktestService-489"><span class="linenos">489</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="BacktestService-490"><a href="#BacktestService-490"><span class="linenos">490</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="BacktestService-491"><a href="#BacktestService-491"><span class="linenos">491</span></a>
</span><span id="BacktestService-492"><a href="#BacktestService-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService-493"><a href="#BacktestService-493"><span class="linenos">493</span></a>
</span><span id="BacktestService-494"><a href="#BacktestService-494"><span class="linenos">494</span></a>
</span><span id="BacktestService-495"><a href="#BacktestService-495"><span class="linenos">495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService-496"><a href="#BacktestService-496"><span class="linenos">496</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-497"><a href="#BacktestService-497"><span class="linenos">497</span></a>            <span class="c1"># Cargar el objeto con relaciones necesarias</span>
</span><span id="BacktestService-498"><a href="#BacktestService-498"><span class="linenos">498</span></a>            <span class="n">bot_performance_id</span> <span class="o">=</span> <span class="n">bot_performance</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bot_performance</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span>
</span><span id="BacktestService-499"><a href="#BacktestService-499"><span class="linenos">499</span></a>
</span><span id="BacktestService-500"><a href="#BacktestService-500"><span class="linenos">500</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="BacktestService-501"><a href="#BacktestService-501"><span class="linenos">501</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService-502"><a href="#BacktestService-502"><span class="linenos">502</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="BacktestService-503"><a href="#BacktestService-503"><span class="linenos">503</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="BacktestService-504"><a href="#BacktestService-504"><span class="linenos">504</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="BacktestService-505"><a href="#BacktestService-505"><span class="linenos">505</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="BacktestService-506"><a href="#BacktestService-506"><span class="linenos">506</span></a>                <span class="p">)</span>\
</span><span id="BacktestService-507"><a href="#BacktestService-507"><span class="linenos">507</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bot_performance_id</span><span class="p">)</span>\
</span><span id="BacktestService-508"><a href="#BacktestService-508"><span class="linenos">508</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="BacktestService-509"><a href="#BacktestService-509"><span class="linenos">509</span></a>
</span><span id="BacktestService-510"><a href="#BacktestService-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_performance</span><span class="p">:</span>
</span><span id="BacktestService-511"><a href="#BacktestService-511"><span class="linenos">511</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;BotPerformance not found&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService-512"><a href="#BacktestService-512"><span class="linenos">512</span></a>
</span><span id="BacktestService-513"><a href="#BacktestService-513"><span class="linenos">513</span></a>            <span class="c1"># Eliminar relaciones directas</span>
</span><span id="BacktestService-514"><a href="#BacktestService-514"><span class="linenos">514</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">:</span>
</span><span id="BacktestService-515"><a href="#BacktestService-515"><span class="linenos">515</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-516"><a href="#BacktestService-516"><span class="linenos">516</span></a>
</span><span id="BacktestService-517"><a href="#BacktestService-517"><span class="linenos">517</span></a>            <span class="c1"># Eliminar Montecarlo y métricas asociadas</span>
</span><span id="BacktestService-518"><a href="#BacktestService-518"><span class="linenos">518</span></a>            <span class="n">montecarlo_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService-519"><a href="#BacktestService-519"><span class="linenos">519</span></a>            <span class="k">if</span> <span class="n">montecarlo_test</span><span class="p">:</span>
</span><span id="BacktestService-520"><a href="#BacktestService-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MetricWharehouse</span><span class="p">,</span> <span class="n">MontecarloTestId</span><span class="o">=</span><span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-521"><a href="#BacktestService-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-522"><a href="#BacktestService-522"><span class="linenos">522</span></a>
</span><span id="BacktestService-523"><a href="#BacktestService-523"><span class="linenos">523</span></a>            <span class="c1"># Eliminar LuckTests y sus performances</span>
</span><span id="BacktestService-524"><a href="#BacktestService-524"><span class="linenos">524</span></a>            <span class="n">luck_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService-525"><a href="#BacktestService-525"><span class="linenos">525</span></a>            <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">luck_tests</span><span class="p">:</span>
</span><span id="BacktestService-526"><a href="#BacktestService-526"><span class="linenos">526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService-527"><a href="#BacktestService-527"><span class="linenos">527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-528"><a href="#BacktestService-528"><span class="linenos">528</span></a>
</span><span id="BacktestService-529"><a href="#BacktestService-529"><span class="linenos">529</span></a>            <span class="c1"># Borrar archivos relacionados</span>
</span><span id="BacktestService-530"><a href="#BacktestService-530"><span class="linenos">530</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService-531"><a href="#BacktestService-531"><span class="linenos">531</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService-532"><a href="#BacktestService-532"><span class="linenos">532</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="BacktestService-533"><a href="#BacktestService-533"><span class="linenos">533</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="BacktestService-534"><a href="#BacktestService-534"><span class="linenos">534</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService-535"><a href="#BacktestService-535"><span class="linenos">535</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="BacktestService-536"><a href="#BacktestService-536"><span class="linenos">536</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="BacktestService-537"><a href="#BacktestService-537"><span class="linenos">537</span></a>
</span><span id="BacktestService-538"><a href="#BacktestService-538"><span class="linenos">538</span></a>            <span class="c1"># Eliminar RandomTests y sus dependencias</span>
</span><span id="BacktestService-539"><a href="#BacktestService-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">:</span>
</span><span id="BacktestService-540"><a href="#BacktestService-540"><span class="linenos">540</span></a>                <span class="n">rt</span> <span class="o">=</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span>
</span><span id="BacktestService-541"><a href="#BacktestService-541"><span class="linenos">541</span></a>                <span class="n">rt_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService-542"><a href="#BacktestService-542"><span class="linenos">542</span></a>                <span class="k">if</span> <span class="n">rt_perf</span><span class="p">:</span>
</span><span id="BacktestService-543"><a href="#BacktestService-543"><span class="linenos">543</span></a>                    <span class="n">rt_trade_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">rt_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-544"><a href="#BacktestService-544"><span class="linenos">544</span></a>                    <span class="k">if</span> <span class="n">rt_trade_perf</span><span class="p">:</span>
</span><span id="BacktestService-545"><a href="#BacktestService-545"><span class="linenos">545</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">rt_trade_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-546"><a href="#BacktestService-546"><span class="linenos">546</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService-547"><a href="#BacktestService-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">RandomTest</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-548"><a href="#BacktestService-548"><span class="linenos">548</span></a>
</span><span id="BacktestService-549"><a href="#BacktestService-549"><span class="linenos">549</span></a>            <span class="c1"># Borrar trades relacionados</span>
</span><span id="BacktestService-550"><a href="#BacktestService-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService-551"><a href="#BacktestService-551"><span class="linenos">551</span></a>
</span><span id="BacktestService-552"><a href="#BacktestService-552"><span class="linenos">552</span></a>            <span class="c1"># Si no hay más performance, borrar el Bot</span>
</span><span id="BacktestService-553"><a href="#BacktestService-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">:</span>
</span><span id="BacktestService-554"><a href="#BacktestService-554"><span class="linenos">554</span></a>                <span class="n">rem</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="BacktestService-555"><a href="#BacktestService-555"><span class="linenos">555</span></a>                <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BacktestService-556"><a href="#BacktestService-556"><span class="linenos">556</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-557"><a href="#BacktestService-557"><span class="linenos">557</span></a>
</span><span id="BacktestService-558"><a href="#BacktestService-558"><span class="linenos">558</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-559"><a href="#BacktestService-559"><span class="linenos">559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="BacktestService-560"><a href="#BacktestService-560"><span class="linenos">560</span></a>
</span><span id="BacktestService-561"><a href="#BacktestService-561"><span class="linenos">561</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService-562"><a href="#BacktestService-562"><span class="linenos">562</span></a>
</span><span id="BacktestService-563"><a href="#BacktestService-563"><span class="linenos">563</span></a>    
</span><span id="BacktestService-564"><a href="#BacktestService-564"><span class="linenos">564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService-565"><a href="#BacktestService-565"><span class="linenos">565</span></a>
</span><span id="BacktestService-566"><a href="#BacktestService-566"><span class="linenos">566</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-567"><a href="#BacktestService-567"><span class="linenos">567</span></a>            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span>
</span><span id="BacktestService-568"><a href="#BacktestService-568"><span class="linenos">568</span></a>            
</span><span id="BacktestService-569"><a href="#BacktestService-569"><span class="linenos">569</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">performance</span><span class="p">:</span>
</span><span id="BacktestService-570"><a href="#BacktestService-570"><span class="linenos">570</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Backtest not found&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService-571"><a href="#BacktestService-571"><span class="linenos">571</span></a>            
</span><span id="BacktestService-572"><a href="#BacktestService-572"><span class="linenos">572</span></a>            <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span>
</span><span id="BacktestService-573"><a href="#BacktestService-573"><span class="linenos">573</span></a>            <span class="n">updated_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance</span><span class="p">)</span>   
</span><span id="BacktestService-574"><a href="#BacktestService-574"><span class="linenos">574</span></a>
</span><span id="BacktestService-575"><a href="#BacktestService-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_performance</span><span class="p">:</span>
</span><span id="BacktestService-576"><a href="#BacktestService-576"><span class="linenos">576</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Update failed&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService-577"><a href="#BacktestService-577"><span class="linenos">577</span></a>
</span><span id="BacktestService-578"><a href="#BacktestService-578"><span class="linenos">578</span></a>            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">updated_performance</span><span class="o">.</span><span class="n">Favorite</span><span class="p">)</span>
</span><span id="BacktestService-579"><a href="#BacktestService-579"><span class="linenos">579</span></a>
</span><span id="BacktestService-580"><a href="#BacktestService-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService-581"><a href="#BacktestService-581"><span class="linenos">581</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-582"><a href="#BacktestService-582"><span class="linenos">582</span></a>            <span class="c1"># Subquery para filtrar estrategias robustas (RreturnDd promedio &gt; 1)</span>
</span><span id="BacktestService-583"><a href="#BacktestService-583"><span class="linenos">583</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-584"><a href="#BacktestService-584"><span class="linenos">584</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService-585"><a href="#BacktestService-585"><span class="linenos">585</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService-586"><a href="#BacktestService-586"><span class="linenos">586</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService-587"><a href="#BacktestService-587"><span class="linenos">587</span></a>                <span class="p">)</span>
</span><span id="BacktestService-588"><a href="#BacktestService-588"><span class="linenos">588</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-589"><a href="#BacktestService-589"><span class="linenos">589</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-590"><a href="#BacktestService-590"><span class="linenos">590</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="BacktestService-591"><a href="#BacktestService-591"><span class="linenos">591</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="BacktestService-592"><a href="#BacktestService-592"><span class="linenos">592</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="BacktestService-593"><a href="#BacktestService-593"><span class="linenos">593</span></a>                <span class="p">)</span>
</span><span id="BacktestService-594"><a href="#BacktestService-594"><span class="linenos">594</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService-595"><a href="#BacktestService-595"><span class="linenos">595</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BacktestService-596"><a href="#BacktestService-596"><span class="linenos">596</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-597"><a href="#BacktestService-597"><span class="linenos">597</span></a>            <span class="p">)</span>
</span><span id="BacktestService-598"><a href="#BacktestService-598"><span class="linenos">598</span></a>
</span><span id="BacktestService-599"><a href="#BacktestService-599"><span class="linenos">599</span></a>            <span class="c1"># Alias para evitar ambigüedad</span>
</span><span id="BacktestService-600"><a href="#BacktestService-600"><span class="linenos">600</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="BacktestService-601"><a href="#BacktestService-601"><span class="linenos">601</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService-602"><a href="#BacktestService-602"><span class="linenos">602</span></a>
</span><span id="BacktestService-603"><a href="#BacktestService-603"><span class="linenos">603</span></a>            <span class="c1"># Subquery para asignar un número de fila basado en StabilityWeightedRar</span>
</span><span id="BacktestService-604"><a href="#BacktestService-604"><span class="linenos">604</span></a>            <span class="n">ranked_subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-605"><a href="#BacktestService-605"><span class="linenos">605</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService-606"><a href="#BacktestService-606"><span class="linenos">606</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;bp_id&quot;</span><span class="p">),</span>
</span><span id="BacktestService-607"><a href="#BacktestService-607"><span class="linenos">607</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span>
</span><span id="BacktestService-608"><a href="#BacktestService-608"><span class="linenos">608</span></a>                    <span class="o">.</span><span class="n">over</span><span class="p">(</span>
</span><span id="BacktestService-609"><a href="#BacktestService-609"><span class="linenos">609</span></a>                        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">],</span>
</span><span id="BacktestService-610"><a href="#BacktestService-610"><span class="linenos">610</span></a>                        <span class="n">order_by</span><span class="o">=</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
</span><span id="BacktestService-611"><a href="#BacktestService-611"><span class="linenos">611</span></a>                    <span class="p">)</span>
</span><span id="BacktestService-612"><a href="#BacktestService-612"><span class="linenos">612</span></a>                    <span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;row_num&quot;</span><span class="p">),</span>
</span><span id="BacktestService-613"><a href="#BacktestService-613"><span class="linenos">613</span></a>                <span class="p">)</span>
</span><span id="BacktestService-614"><a href="#BacktestService-614"><span class="linenos">614</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-615"><a href="#BacktestService-615"><span class="linenos">615</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="BacktestService-616"><a href="#BacktestService-616"><span class="linenos">616</span></a>                    <span class="n">subquery</span><span class="p">,</span>
</span><span id="BacktestService-617"><a href="#BacktestService-617"><span class="linenos">617</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>
</span><span id="BacktestService-618"><a href="#BacktestService-618"><span class="linenos">618</span></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">),</span>
</span><span id="BacktestService-619"><a href="#BacktestService-619"><span class="linenos">619</span></a>                <span class="p">)</span>
</span><span id="BacktestService-620"><a href="#BacktestService-620"><span class="linenos">620</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-621"><a href="#BacktestService-621"><span class="linenos">621</span></a>            <span class="p">)</span>
</span><span id="BacktestService-622"><a href="#BacktestService-622"><span class="linenos">622</span></a>
</span><span id="BacktestService-623"><a href="#BacktestService-623"><span class="linenos">623</span></a>            <span class="c1"># Query final seleccionando solo los mejores (row_num == 1)</span>
</span><span id="BacktestService-624"><a href="#BacktestService-624"><span class="linenos">624</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-625"><a href="#BacktestService-625"><span class="linenos">625</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="BacktestService-626"><a href="#BacktestService-626"><span class="linenos">626</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="p">,</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">bp_id</span><span class="p">)</span>
</span><span id="BacktestService-627"><a href="#BacktestService-627"><span class="linenos">627</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">row_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BacktestService-628"><a href="#BacktestService-628"><span class="linenos">628</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService-629"><a href="#BacktestService-629"><span class="linenos">629</span></a>            <span class="p">)</span>
</span><span id="BacktestService-630"><a href="#BacktestService-630"><span class="linenos">630</span></a>
</span><span id="BacktestService-631"><a href="#BacktestService-631"><span class="linenos">631</span></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="BacktestService-632"><a href="#BacktestService-632"><span class="linenos">632</span></a>               
</span><span id="BacktestService-633"><a href="#BacktestService-633"><span class="linenos">633</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts_by_strategy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService-634"><a href="#BacktestService-634"><span class="linenos">634</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-635"><a href="#BacktestService-635"><span class="linenos">635</span></a>            <span class="c1"># Subquery para calcular el promedio de RreturnDd por StrategyId y TickerId</span>
</span><span id="BacktestService-636"><a href="#BacktestService-636"><span class="linenos">636</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-637"><a href="#BacktestService-637"><span class="linenos">637</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService-638"><a href="#BacktestService-638"><span class="linenos">638</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService-639"><a href="#BacktestService-639"><span class="linenos">639</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService-640"><a href="#BacktestService-640"><span class="linenos">640</span></a>                <span class="p">)</span>
</span><span id="BacktestService-641"><a href="#BacktestService-641"><span class="linenos">641</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-642"><a href="#BacktestService-642"><span class="linenos">642</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService-643"><a href="#BacktestService-643"><span class="linenos">643</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="BacktestService-644"><a href="#BacktestService-644"><span class="linenos">644</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">,</span>
</span><span id="BacktestService-645"><a href="#BacktestService-645"><span class="linenos">645</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="BacktestService-646"><a href="#BacktestService-646"><span class="linenos">646</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="BacktestService-647"><a href="#BacktestService-647"><span class="linenos">647</span></a>                <span class="p">)</span>
</span><span id="BacktestService-648"><a href="#BacktestService-648"><span class="linenos">648</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService-649"><a href="#BacktestService-649"><span class="linenos">649</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># &gt;= en lugar de &gt; para incluir exactamente 1</span>
</span><span id="BacktestService-650"><a href="#BacktestService-650"><span class="linenos">650</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-651"><a href="#BacktestService-651"><span class="linenos">651</span></a>            <span class="p">)</span>
</span><span id="BacktestService-652"><a href="#BacktestService-652"><span class="linenos">652</span></a>
</span><span id="BacktestService-653"><a href="#BacktestService-653"><span class="linenos">653</span></a>            <span class="c1"># Alias para evitar ambigüedad en las relaciones</span>
</span><span id="BacktestService-654"><a href="#BacktestService-654"><span class="linenos">654</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="BacktestService-655"><a href="#BacktestService-655"><span class="linenos">655</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService-656"><a href="#BacktestService-656"><span class="linenos">656</span></a>
</span><span id="BacktestService-657"><a href="#BacktestService-657"><span class="linenos">657</span></a>            <span class="c1"># Subquery para seleccionar la mejor temporalidad por StrategyId - TickerId</span>
</span><span id="BacktestService-658"><a href="#BacktestService-658"><span class="linenos">658</span></a>            <span class="n">best_temporalities</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-659"><a href="#BacktestService-659"><span class="linenos">659</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService-660"><a href="#BacktestService-660"><span class="linenos">660</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">,</span>
</span><span id="BacktestService-661"><a href="#BacktestService-661"><span class="linenos">661</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService-662"><a href="#BacktestService-662"><span class="linenos">662</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService-663"><a href="#BacktestService-663"><span class="linenos">663</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;max_custom_metric&quot;</span><span class="p">)</span>
</span><span id="BacktestService-664"><a href="#BacktestService-664"><span class="linenos">664</span></a>                <span class="p">)</span>
</span><span id="BacktestService-665"><a href="#BacktestService-665"><span class="linenos">665</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-666"><a href="#BacktestService-666"><span class="linenos">666</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">))</span>
</span><span id="BacktestService-667"><a href="#BacktestService-667"><span class="linenos">667</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService-668"><a href="#BacktestService-668"><span class="linenos">668</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService-669"><a href="#BacktestService-669"><span class="linenos">669</span></a>            <span class="p">)</span>
</span><span id="BacktestService-670"><a href="#BacktestService-670"><span class="linenos">670</span></a>
</span><span id="BacktestService-671"><a href="#BacktestService-671"><span class="linenos">671</span></a>            <span class="c1"># Query final para traer solo los registros que corresponden a la mejor temporalidad</span>
</span><span id="BacktestService-672"><a href="#BacktestService-672"><span class="linenos">672</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-673"><a href="#BacktestService-673"><span class="linenos">673</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="BacktestService-674"><a href="#BacktestService-674"><span class="linenos">674</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService-675"><a href="#BacktestService-675"><span class="linenos">675</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_temporalities</span><span class="p">,</span>
</span><span id="BacktestService-676"><a href="#BacktestService-676"><span class="linenos">676</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="BacktestService-677"><a href="#BacktestService-677"><span class="linenos">677</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="BacktestService-678"><a href="#BacktestService-678"><span class="linenos">678</span></a>                    <span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_custom_metric</span><span class="p">))</span>
</span><span id="BacktestService-679"><a href="#BacktestService-679"><span class="linenos">679</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService-680"><a href="#BacktestService-680"><span class="linenos">680</span></a>            <span class="p">)</span>
</span><span id="BacktestService-681"><a href="#BacktestService-681"><span class="linenos">681</span></a>
</span><span id="BacktestService-682"><a href="#BacktestService-682"><span class="linenos">682</span></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="BacktestService-683"><a href="#BacktestService-683"><span class="linenos">683</span></a>
</span><span id="BacktestService-684"><a href="#BacktestService-684"><span class="linenos">684</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_favorites</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService-685"><a href="#BacktestService-685"><span class="linenos">685</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-686"><a href="#BacktestService-686"><span class="linenos">686</span></a>            <span class="n">favorites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Favorite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BacktestService-687"><a href="#BacktestService-687"><span class="linenos">687</span></a>        
</span><span id="BacktestService-688"><a href="#BacktestService-688"><span class="linenos">688</span></a>        <span class="k">return</span> <span class="n">favorites</span>
</span><span id="BacktestService-689"><a href="#BacktestService-689"><span class="linenos">689</span></a>        
</span><span id="BacktestService-690"><a href="#BacktestService-690"><span class="linenos">690</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
</span><span id="BacktestService-691"><a href="#BacktestService-691"><span class="linenos">691</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-692"><a href="#BacktestService-692"><span class="linenos">692</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="BacktestService-693"><a href="#BacktestService-693"><span class="linenos">693</span></a>            <span class="k">return</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">TradeHistory</span>
</span><span id="BacktestService-694"><a href="#BacktestService-694"><span class="linenos">694</span></a>
</span><span id="BacktestService-695"><a href="#BacktestService-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_filter</span><span class="p">(</span>
</span><span id="BacktestService-696"><a href="#BacktestService-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService-697"><a href="#BacktestService-697"><span class="linenos">697</span></a>        <span class="n">return_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-698"><a href="#BacktestService-698"><span class="linenos">698</span></a>        <span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-699"><a href="#BacktestService-699"><span class="linenos">699</span></a>        <span class="n">stability_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-700"><a href="#BacktestService-700"><span class="linenos">700</span></a>        <span class="n">sharpe_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-701"><a href="#BacktestService-701"><span class="linenos">701</span></a>        <span class="n">trades</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-702"><a href="#BacktestService-702"><span class="linenos">702</span></a>        <span class="n">rreturn_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-703"><a href="#BacktestService-703"><span class="linenos">703</span></a>        <span class="n">custom_metric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-704"><a href="#BacktestService-704"><span class="linenos">704</span></a>        <span class="n">winrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-705"><a href="#BacktestService-705"><span class="linenos">705</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService-706"><a href="#BacktestService-706"><span class="linenos">706</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService-707"><a href="#BacktestService-707"><span class="linenos">707</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService-708"><a href="#BacktestService-708"><span class="linenos">708</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService-709"><a href="#BacktestService-709"><span class="linenos">709</span></a>            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BacktestService-710"><a href="#BacktestService-710"><span class="linenos">710</span></a>
</span><span id="BacktestService-711"><a href="#BacktestService-711"><span class="linenos">711</span></a>            <span class="c1"># Base query y joins explícitos</span>
</span><span id="BacktestService-712"><a href="#BacktestService-712"><span class="linenos">712</span></a>            <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="BacktestService-713"><a href="#BacktestService-713"><span class="linenos">713</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>\
</span><span id="BacktestService-714"><a href="#BacktestService-714"><span class="linenos">714</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>\
</span><span id="BacktestService-715"><a href="#BacktestService-715"><span class="linenos">715</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Ticker</span><span class="p">,</span> <span class="n">Ticker</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService-716"><a href="#BacktestService-716"><span class="linenos">716</span></a>
</span><span id="BacktestService-717"><a href="#BacktestService-717"><span class="linenos">717</span></a>            <span class="c1"># Filtros numéricos</span>
</span><span id="BacktestService-718"><a href="#BacktestService-718"><span class="linenos">718</span></a>            <span class="k">if</span> <span class="n">return_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-719"><a href="#BacktestService-719"><span class="linenos">719</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Return</span> <span class="o">&gt;=</span> <span class="n">return_</span><span class="p">)</span>
</span><span id="BacktestService-720"><a href="#BacktestService-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="n">drawdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-721"><a href="#BacktestService-721"><span class="linenos">721</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Drawdown</span> <span class="o">&lt;=</span> <span class="n">drawdown</span><span class="p">)</span>
</span><span id="BacktestService-722"><a href="#BacktestService-722"><span class="linenos">722</span></a>            <span class="k">if</span> <span class="n">stability_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-723"><a href="#BacktestService-723"><span class="linenos">723</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityRatio</span> <span class="o">&gt;=</span> <span class="n">stability_ratio</span><span class="p">)</span>
</span><span id="BacktestService-724"><a href="#BacktestService-724"><span class="linenos">724</span></a>            <span class="k">if</span> <span class="n">sharpe_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-725"><a href="#BacktestService-725"><span class="linenos">725</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">SharpeRatio</span> <span class="o">&gt;=</span> <span class="n">sharpe_ratio</span><span class="p">)</span>
</span><span id="BacktestService-726"><a href="#BacktestService-726"><span class="linenos">726</span></a>            <span class="k">if</span> <span class="n">trades</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-727"><a href="#BacktestService-727"><span class="linenos">727</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Trades</span> <span class="o">&gt;=</span> <span class="n">trades</span><span class="p">)</span>
</span><span id="BacktestService-728"><a href="#BacktestService-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="n">rreturn_dd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-729"><a href="#BacktestService-729"><span class="linenos">729</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">&gt;=</span> <span class="n">rreturn_dd</span><span class="p">)</span>
</span><span id="BacktestService-730"><a href="#BacktestService-730"><span class="linenos">730</span></a>            <span class="k">if</span> <span class="n">custom_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-731"><a href="#BacktestService-731"><span class="linenos">731</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">&gt;=</span> <span class="n">custom_metric</span><span class="p">)</span>
</span><span id="BacktestService-732"><a href="#BacktestService-732"><span class="linenos">732</span></a>            <span class="k">if</span> <span class="n">winrate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService-733"><a href="#BacktestService-733"><span class="linenos">733</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">WinRate</span> <span class="o">&gt;=</span> <span class="n">winrate</span><span class="p">)</span>
</span><span id="BacktestService-734"><a href="#BacktestService-734"><span class="linenos">734</span></a>
</span><span id="BacktestService-735"><a href="#BacktestService-735"><span class="linenos">735</span></a>            <span class="c1"># Filtros por texto con ILIKE correctamente aplicados</span>
</span><span id="BacktestService-736"><a href="#BacktestService-736"><span class="linenos">736</span></a>            <span class="k">if</span> <span class="n">strategy</span><span class="p">:</span>
</span><span id="BacktestService-737"><a href="#BacktestService-737"><span class="linenos">737</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="BacktestService-738"><a href="#BacktestService-738"><span class="linenos">738</span></a>            <span class="k">if</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="BacktestService-739"><a href="#BacktestService-739"><span class="linenos">739</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ticker</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="BacktestService-740"><a href="#BacktestService-740"><span class="linenos">740</span></a>
</span><span id="BacktestService-741"><a href="#BacktestService-741"><span class="linenos">741</span></a>            <span class="c1"># Query final que aplica filtros correctamente</span>
</span><span id="BacktestService-742"><a href="#BacktestService-742"><span class="linenos">742</span></a>            <span class="n">final_query</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService-743"><a href="#BacktestService-743"><span class="linenos">743</span></a>                <span class="n">query</span>
</span><span id="BacktestService-744"><a href="#BacktestService-744"><span class="linenos">744</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
</span><span id="BacktestService-745"><a href="#BacktestService-745"><span class="linenos">745</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService-746"><a href="#BacktestService-746"><span class="linenos">746</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="BacktestService-747"><a href="#BacktestService-747"><span class="linenos">747</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="BacktestService-748"><a href="#BacktestService-748"><span class="linenos">748</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">TradeHistory</span><span class="p">),</span>
</span><span id="BacktestService-749"><a href="#BacktestService-749"><span class="linenos">749</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">MontecarloTest</span><span class="p">),</span>
</span><span id="BacktestService-750"><a href="#BacktestService-750"><span class="linenos">750</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="BacktestService-751"><a href="#BacktestService-751"><span class="linenos">751</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="BacktestService-752"><a href="#BacktestService-752"><span class="linenos">752</span></a>                <span class="p">)</span>
</span><span id="BacktestService-753"><a href="#BacktestService-753"><span class="linenos">753</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span><span id="BacktestService-754"><a href="#BacktestService-754"><span class="linenos">754</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService-755"><a href="#BacktestService-755"><span class="linenos">755</span></a>            <span class="p">)</span>
</span><span id="BacktestService-756"><a href="#BacktestService-756"><span class="linenos">756</span></a>
</span><span id="BacktestService-757"><a href="#BacktestService-757"><span class="linenos">757</span></a>            <span class="k">return</span> <span class="n">final_query</span>
</span></pre></div>


            <div class="docstring"><p>Handles the orchestration, execution, persistence, and retrieval of backtests and related performance metrics.</p>

<p>This service acts as the central component for running backtests on trading strategies, saving their results,
and performing various queries on historical performance data. It supports streaming logs, asynchronous execution,
and interaction with the database and configuration layers.</p>

<p>Main features include:</p>

<ul>
<li>Running and saving individual or batch backtests across strategy/ticker/timeframe/risk combinations.</li>
<li>Loading strategies dynamically and executing them with proper capital, leverage, and configuration.</li>
<li>Persisting detailed performance metrics and trade history in the database.</li>
<li>Performing deletions and cleanup of historical test data (including files and DB records).</li>
<li>Providing filtering, querying, and tagging of backtests (e.g. by performance, robustness, favorites).</li>
<li>Identifying robust strategies via custom metrics and filters (e.g. return/drawdown ratio &gt; 1).</li>
<li>Managing test dependencies such as Monte Carlo, Luck Test, and Random Test results.</li>
</ul>

<p>Attributes:
    db_service (DbService): Handles database connections and CRUD operations.
    bot_service (BotService): Manages bot records used during backtesting.
    config_service (ConfigService): Provides access to configuration values (e.g. risk-free rate).</p>

<p>Notes:
    - Backtests can be persisted with reports or run temporarily.
    - Streaming logs (via queues) allow real-time feedback when executing long-running backtests.
    - This class assumes a full application context with all entities (Bot, BotPerformance, Trade, etc.) properly defined.</p>
</div>


                            <div id="BacktestService.db_service" class="classattr">
                                <div class="attr variable">
            <span class="name">db_service</span>

        
    </div>
    <a class="headerlink" href="#BacktestService.db_service"></a>
    
    

                            </div>
                            <div id="BacktestService.bot_service" class="classattr">
                                <div class="attr variable">
            <span class="name">bot_service</span>

        
    </div>
    <a class="headerlink" href="#BacktestService.bot_service"></a>
    
    

                            </div>
                            <div id="BacktestService.config_service" class="classattr">
                                <div class="attr variable">
            <span class="name">config_service</span>

        
    </div>
    <a class="headerlink" href="#BacktestService.config_service"></a>
    
    

                            </div>
                            <div id="BacktestService.async_iterator" class="classattr">
                                        <input id="BacktestService.async_iterator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">async_iterator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">iterable</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BacktestService.async_iterator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.async_iterator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.async_iterator-76"><a href="#BacktestService.async_iterator-76"><span class="linenos">76</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
</span><span id="BacktestService.async_iterator-77"><a href="#BacktestService.async_iterator-77"><span class="linenos">77</span></a>        <span class="c1"># Si iterable es una lista, la envolvemos en una iteración asíncrona</span>
</span><span id="BacktestService.async_iterator-78"><a href="#BacktestService.async_iterator-78"><span class="linenos">78</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
</span><span id="BacktestService.async_iterator-79"><a href="#BacktestService.async_iterator-79"><span class="linenos">79</span></a>            <span class="k">yield</span> <span class="n">item</span>
</span><span id="BacktestService.async_iterator-80"><a href="#BacktestService.async_iterator-80"><span class="linenos">80</span></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.run_backtest" class="classattr">
                                        <input id="BacktestService.run_backtest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-streaming_endpoint">@streaming_endpoint</div>

        <span class="def">async def</span>
        <span class="name">run_backtest</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">strategy</span><span class="p">:</span> <span class="n"><a href="../entities/strategy.html#Strategy">app.backbone.entities.strategy.Strategy</a></span>,</span><span class="param">	<span class="n">ticker</span><span class="p">:</span> <span class="n"><a href="../entities/ticker.html#Ticker">app.backbone.entities.ticker.Ticker</a></span>,</span><span class="param">	<span class="n">timeframe</span><span class="p">:</span> <span class="n"><a href="../entities/timeframe.html#Timeframe">app.backbone.entities.timeframe.Timeframe</a></span>,</span><span class="param">	<span class="n">date_from</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span>,</span><span class="param">	<span class="n">date_to</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">risk</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">Queue</span></span><span class="return-annotation">) -> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.run_backtest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.run_backtest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.run_backtest-82"><a href="#BacktestService.run_backtest-82"><span class="linenos"> 82</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="BacktestService.run_backtest-83"><a href="#BacktestService.run_backtest-83"><span class="linenos"> 83</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtest</span><span class="p">(</span>
</span><span id="BacktestService.run_backtest-84"><a href="#BacktestService.run_backtest-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-85"><a href="#BacktestService.run_backtest-85"><span class="linenos"> 85</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-86"><a href="#BacktestService.run_backtest-86"><span class="linenos"> 86</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-87"><a href="#BacktestService.run_backtest-87"><span class="linenos"> 87</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="n">Ticker</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-88"><a href="#BacktestService.run_backtest-88"><span class="linenos"> 88</span></a>        <span class="n">timeframe</span><span class="p">:</span> <span class="n">Timeframe</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-89"><a href="#BacktestService.run_backtest-89"><span class="linenos"> 89</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-90"><a href="#BacktestService.run_backtest-90"><span class="linenos"> 90</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-91"><a href="#BacktestService.run_backtest-91"><span class="linenos"> 91</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-92"><a href="#BacktestService.run_backtest-92"><span class="linenos"> 92</span></a>        <span class="n">risk</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-93"><a href="#BacktestService.run_backtest-93"><span class="linenos"> 93</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-94"><a href="#BacktestService.run_backtest-94"><span class="linenos"> 94</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-95"><a href="#BacktestService.run_backtest-95"><span class="linenos"> 95</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BacktestService.run_backtest-96"><a href="#BacktestService.run_backtest-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BacktestService.run_backtest-97"><a href="#BacktestService.run_backtest-97"><span class="linenos"> 97</span></a><span class="sd">        Executes an asynchronous backtest for a given trading strategy and returns performance metrics, </span>
</span><span id="BacktestService.run_backtest-98"><a href="#BacktestService.run_backtest-98"><span class="linenos"> 98</span></a><span class="sd">        trade details, and statistics via a streaming endpoint.</span>
</span><span id="BacktestService.run_backtest-99"><a href="#BacktestService.run_backtest-99"><span class="linenos"> 99</span></a>
</span><span id="BacktestService.run_backtest-100"><a href="#BacktestService.run_backtest-100"><span class="linenos">100</span></a><span class="sd">        This function loads the specified strategy, fetches historical price data, applies leverage rules,</span>
</span><span id="BacktestService.run_backtest-101"><a href="#BacktestService.run_backtest-101"><span class="linenos">101</span></a><span class="sd">        and runs a backtest simulation. Results are streamed in real-time through an asyncio queue, </span>
</span><span id="BacktestService.run_backtest-102"><a href="#BacktestService.run_backtest-102"><span class="linenos">102</span></a><span class="sd">        and optional plots/reports are generated.</span>
</span><span id="BacktestService.run_backtest-103"><a href="#BacktestService.run_backtest-103"><span class="linenos">103</span></a>
</span><span id="BacktestService.run_backtest-104"><a href="#BacktestService.run_backtest-104"><span class="linenos">104</span></a><span class="sd">        Steps performed:</span>
</span><span id="BacktestService.run_backtest-105"><a href="#BacktestService.run_backtest-105"><span class="linenos">105</span></a><span class="sd">        - Loads the trading strategy dynamically from a module path.</span>
</span><span id="BacktestService.run_backtest-106"><a href="#BacktestService.run_backtest-106"><span class="linenos">106</span></a><span class="sd">        - Retrieves leverage rules from a YAML config file.</span>
</span><span id="BacktestService.run_backtest-107"><a href="#BacktestService.run_backtest-107"><span class="linenos">107</span></a><span class="sd">        - Fetches and prepares historical price data for the given ticker/timeframe.</span>
</span><span id="BacktestService.run_backtest-108"><a href="#BacktestService.run_backtest-108"><span class="linenos">108</span></a><span class="sd">        - Computes margin requirements based on leverage.</span>
</span><span id="BacktestService.run_backtest-109"><a href="#BacktestService.run_backtest-109"><span class="linenos">109</span></a><span class="sd">        - Executes the backtest using the strategy&#39;s logic and calculates performance metrics.</span>
</span><span id="BacktestService.run_backtest-110"><a href="#BacktestService.run_backtest-110"><span class="linenos">110</span></a><span class="sd">        - Generates and saves backtest plots (temporary or persistent) if requested.</span>
</span><span id="BacktestService.run_backtest-111"><a href="#BacktestService.run_backtest-111"><span class="linenos">111</span></a><span class="sd">        - Streams progress updates, logs, and final results through the provided queue.</span>
</span><span id="BacktestService.run_backtest-112"><a href="#BacktestService.run_backtest-112"><span class="linenos">112</span></a>
</span><span id="BacktestService.run_backtest-113"><a href="#BacktestService.run_backtest-113"><span class="linenos">113</span></a><span class="sd">        Parameters:</span>
</span><span id="BacktestService.run_backtest-114"><a href="#BacktestService.run_backtest-114"><span class="linenos">114</span></a><span class="sd">        - initial_cash (float): Starting capital for the backtest simulation.</span>
</span><span id="BacktestService.run_backtest-115"><a href="#BacktestService.run_backtest-115"><span class="linenos">115</span></a><span class="sd">        - strategy (Strategy): Strategy object containing the module path and name.</span>
</span><span id="BacktestService.run_backtest-116"><a href="#BacktestService.run_backtest-116"><span class="linenos">116</span></a><span class="sd">        - ticker (Ticker): Financial instrument to backtest on (e.g., currency pair, stock).</span>
</span><span id="BacktestService.run_backtest-117"><a href="#BacktestService.run_backtest-117"><span class="linenos">117</span></a><span class="sd">        - timeframe (Timeframe): Timeframe for price data (e.g., &#39;1H&#39;, &#39;4H&#39;).</span>
</span><span id="BacktestService.run_backtest-118"><a href="#BacktestService.run_backtest-118"><span class="linenos">118</span></a><span class="sd">        - date_from (pd.Timestamp): Start date for historical data.</span>
</span><span id="BacktestService.run_backtest-119"><a href="#BacktestService.run_backtest-119"><span class="linenos">119</span></a><span class="sd">        - date_to (pd.Timestamp): End date for historical data.</span>
</span><span id="BacktestService.run_backtest-120"><a href="#BacktestService.run_backtest-120"><span class="linenos">120</span></a><span class="sd">        - method (str): Reserved for future backtest variations (unused in current implementation).</span>
</span><span id="BacktestService.run_backtest-121"><a href="#BacktestService.run_backtest-121"><span class="linenos">121</span></a><span class="sd">        - risk (float): Risk percentage per trade (e.g., 0.01 for 1% risk).</span>
</span><span id="BacktestService.run_backtest-122"><a href="#BacktestService.run_backtest-122"><span class="linenos">122</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode: </span>
</span><span id="BacktestService.run_backtest-123"><a href="#BacktestService.run_backtest-123"><span class="linenos">123</span></a><span class="sd">            - &#39;temp&#39;: Saves in a temporary directory (auto-cleaned later).</span>
</span><span id="BacktestService.run_backtest-124"><a href="#BacktestService.run_backtest-124"><span class="linenos">124</span></a><span class="sd">            - &#39;persist&#39;: Saves in the main backtest_plots directory.</span>
</span><span id="BacktestService.run_backtest-125"><a href="#BacktestService.run_backtest-125"><span class="linenos">125</span></a><span class="sd">            - Any other value skips plot generation.</span>
</span><span id="BacktestService.run_backtest-126"><a href="#BacktestService.run_backtest-126"><span class="linenos">126</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for real-time progress streaming.</span>
</span><span id="BacktestService.run_backtest-127"><a href="#BacktestService.run_backtest-127"><span class="linenos">127</span></a>
</span><span id="BacktestService.run_backtest-128"><a href="#BacktestService.run_backtest-128"><span class="linenos">128</span></a><span class="sd">        Returns:</span>
</span><span id="BacktestService.run_backtest-129"><a href="#BacktestService.run_backtest-129"><span class="linenos">129</span></a><span class="sd">        AsyncGenerator[str, None]: Yields three objects upon completion:</span>
</span><span id="BacktestService.run_backtest-130"><a href="#BacktestService.run_backtest-130"><span class="linenos">130</span></a><span class="sd">        - performance (pd.DataFrame): Aggregated strategy performance metrics.</span>
</span><span id="BacktestService.run_backtest-131"><a href="#BacktestService.run_backtest-131"><span class="linenos">131</span></a><span class="sd">        - trade_performance (pd.DataFrame): Detailed trade-by-trade results.</span>
</span><span id="BacktestService.run_backtest-132"><a href="#BacktestService.run_backtest-132"><span class="linenos">132</span></a><span class="sd">        - stats (pd.DataFrame): Statistical summaries (e.g., Sharpe ratio, max drawdown).</span>
</span><span id="BacktestService.run_backtest-133"><a href="#BacktestService.run_backtest-133"><span class="linenos">133</span></a>
</span><span id="BacktestService.run_backtest-134"><a href="#BacktestService.run_backtest-134"><span class="linenos">134</span></a><span class="sd">        Side effects:</span>
</span><span id="BacktestService.run_backtest-135"><a href="#BacktestService.run_backtest-135"><span class="linenos">135</span></a><span class="sd">        - Reads leverage configurations from &#39;./app/configs/leverages.yml&#39;.</span>
</span><span id="BacktestService.run_backtest-136"><a href="#BacktestService.run_backtest-136"><span class="linenos">136</span></a><span class="sd">        - May create HTML plot files in either &#39;./app/templates/static/backtest_plots/temp&#39; (temporary)</span>
</span><span id="BacktestService.run_backtest-137"><a href="#BacktestService.run_backtest-137"><span class="linenos">137</span></a><span class="sd">        or &#39;./app/templates/static/backtest_plots&#39; (persistent).</span>
</span><span id="BacktestService.run_backtest-138"><a href="#BacktestService.run_backtest-138"><span class="linenos">138</span></a><span class="sd">        - Streams logs/results via the provided asyncio.Queue (e.g., for frontend progress updates).</span>
</span><span id="BacktestService.run_backtest-139"><a href="#BacktestService.run_backtest-139"><span class="linenos">139</span></a>
</span><span id="BacktestService.run_backtest-140"><a href="#BacktestService.run_backtest-140"><span class="linenos">140</span></a><span class="sd">        Notes:</span>
</span><span id="BacktestService.run_backtest-141"><a href="#BacktestService.run_backtest-141"><span class="linenos">141</span></a><span class="sd">        - The strategy module path must follow the convention: &#39;app.backbone.strategies.{strategy_name}&#39;.</span>
</span><span id="BacktestService.run_backtest-142"><a href="#BacktestService.run_backtest-142"><span class="linenos">142</span></a><span class="sd">        - Temporary plots include a timestamp and are automatically purged by a separate cleanup process.</span>
</span><span id="BacktestService.run_backtest-143"><a href="#BacktestService.run_backtest-143"><span class="linenos">143</span></a><span class="sd">        - Risk-free rate is fetched from the application&#39;s config service (used for Sharpe ratio calculations).</span>
</span><span id="BacktestService.run_backtest-144"><a href="#BacktestService.run_backtest-144"><span class="linenos">144</span></a><span class="sd">        - Margin is calculated as 1/leverage (e.g., 50x leverage → 2% margin requirement).</span>
</span><span id="BacktestService.run_backtest-145"><a href="#BacktestService.run_backtest-145"><span class="linenos">145</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BacktestService.run_backtest-146"><a href="#BacktestService.run_backtest-146"><span class="linenos">146</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Loading strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-147"><a href="#BacktestService.run_backtest-147"><span class="linenos">147</span></a>        
</span><span id="BacktestService.run_backtest-148"><a href="#BacktestService.run_backtest-148"><span class="linenos">148</span></a>        <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BacktestService.run_backtest-149"><a href="#BacktestService.run_backtest-149"><span class="linenos">149</span></a>        <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService.run_backtest-150"><a href="#BacktestService.run_backtest-150"><span class="linenos">150</span></a>        
</span><span id="BacktestService.run_backtest-151"><a href="#BacktestService.run_backtest-151"><span class="linenos">151</span></a>        <span class="n">strategy_path</span> <span class="o">=</span> <span class="s1">&#39;app.backbone.strategies.&#39;</span> <span class="o">+</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span>
</span><span id="BacktestService.run_backtest-152"><a href="#BacktestService.run_backtest-152"><span class="linenos">152</span></a>        <span class="n">strategy_func</span> <span class="o">=</span> <span class="n">load_function</span><span class="p">(</span><span class="n">strategy_path</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-153"><a href="#BacktestService.run_backtest-153"><span class="linenos">153</span></a>        
</span><span id="BacktestService.run_backtest-154"><a href="#BacktestService.run_backtest-154"><span class="linenos">154</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Strategy </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s2"> loaded succesfully&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-155"><a href="#BacktestService.run_backtest-155"><span class="linenos">155</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading leverages&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-156"><a href="#BacktestService.run_backtest-156"><span class="linenos">156</span></a>
</span><span id="BacktestService.run_backtest-157"><a href="#BacktestService.run_backtest-157"><span class="linenos">157</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./app/configs/leverages.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_name</span><span class="p">:</span>
</span><span id="BacktestService.run_backtest-158"><a href="#BacktestService.run_backtest-158"><span class="linenos">158</span></a>            <span class="n">leverages</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-159"><a href="#BacktestService.run_backtest-159"><span class="linenos">159</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Leverages loaded&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-160"><a href="#BacktestService.run_backtest-160"><span class="linenos">160</span></a>
</span><span id="BacktestService.run_backtest-161"><a href="#BacktestService.run_backtest-161"><span class="linenos">161</span></a>        <span class="n">leverage</span> <span class="o">=</span> <span class="n">leverages</span><span class="p">[</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
</span><span id="BacktestService.run_backtest-162"><a href="#BacktestService.run_backtest-162"><span class="linenos">162</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">leverage</span>
</span><span id="BacktestService.run_backtest-163"><a href="#BacktestService.run_backtest-163"><span class="linenos">163</span></a>        
</span><span id="BacktestService.run_backtest-164"><a href="#BacktestService.run_backtest-164"><span class="linenos">164</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Getting data&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-165"><a href="#BacktestService.run_backtest-165"><span class="linenos">165</span></a>
</span><span id="BacktestService.run_backtest-166"><a href="#BacktestService.run_backtest-166"><span class="linenos">166</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">MetaTraderNumber</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-167"><a href="#BacktestService.run_backtest-167"><span class="linenos">167</span></a>        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-168"><a href="#BacktestService.run_backtest-168"><span class="linenos">168</span></a>
</span><span id="BacktestService.run_backtest-169"><a href="#BacktestService.run_backtest-169"><span class="linenos">169</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data ready: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-170"><a href="#BacktestService.run_backtest-170"><span class="linenos">170</span></a>
</span><span id="BacktestService.run_backtest-171"><a href="#BacktestService.run_backtest-171"><span class="linenos">171</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting backtest&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-172"><a href="#BacktestService.run_backtest-172"><span class="linenos">172</span></a>
</span><span id="BacktestService.run_backtest-173"><a href="#BacktestService.run_backtest-173"><span class="linenos">173</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_from</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">date_to</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService.run_backtest-174"><a href="#BacktestService.run_backtest-174"><span class="linenos">174</span></a>        <span class="n">plot_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService.run_backtest-175"><a href="#BacktestService.run_backtest-175"><span class="linenos">175</span></a>
</span><span id="BacktestService.run_backtest-176"><a href="#BacktestService.run_backtest-176"><span class="linenos">176</span></a>        <span class="k">if</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;temp&#39;</span><span class="p">:</span>
</span><span id="BacktestService.run_backtest-177"><a href="#BacktestService.run_backtest-177"><span class="linenos">177</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots/temp&#39;</span>
</span><span id="BacktestService.run_backtest-178"><a href="#BacktestService.run_backtest-178"><span class="linenos">178</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/backtest_plots/temp&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span><span class="p">))</span>
</span><span id="BacktestService.run_backtest-179"><a href="#BacktestService.run_backtest-179"><span class="linenos">179</span></a>
</span><span id="BacktestService.run_backtest-180"><a href="#BacktestService.run_backtest-180"><span class="linenos">180</span></a>        <span class="k">elif</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span><span class="p">:</span>
</span><span id="BacktestService.run_backtest-181"><a href="#BacktestService.run_backtest-181"><span class="linenos">181</span></a>            <span class="n">plot_path</span> <span class="o">=</span> <span class="s1">&#39;./app/templates/static/backtest_plots&#39;</span>
</span><span id="BacktestService.run_backtest-182"><a href="#BacktestService.run_backtest-182"><span class="linenos">182</span></a>
</span><span id="BacktestService.run_backtest-183"><a href="#BacktestService.run_backtest-183"><span class="linenos">183</span></a>        <span class="n">risk_free_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_service</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="s1">&#39;RiskFreeRate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-184"><a href="#BacktestService.run_backtest-184"><span class="linenos">184</span></a>
</span><span id="BacktestService.run_backtest-185"><a href="#BacktestService.run_backtest-185"><span class="linenos">185</span></a>        <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">run_strategy_and_get_performances</span><span class="p">(</span>
</span><span id="BacktestService.run_backtest-186"><a href="#BacktestService.run_backtest-186"><span class="linenos">186</span></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy_func</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-187"><a href="#BacktestService.run_backtest-187"><span class="linenos">187</span></a>            <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-188"><a href="#BacktestService.run_backtest-188"><span class="linenos">188</span></a>            <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-189"><a href="#BacktestService.run_backtest-189"><span class="linenos">189</span></a>            <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-190"><a href="#BacktestService.run_backtest-190"><span class="linenos">190</span></a>            <span class="n">prices</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-191"><a href="#BacktestService.run_backtest-191"><span class="linenos">191</span></a>            <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-192"><a href="#BacktestService.run_backtest-192"><span class="linenos">192</span></a>            <span class="n">risk_free_rate</span><span class="o">=</span><span class="n">risk_free_rate</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-193"><a href="#BacktestService.run_backtest-193"><span class="linenos">193</span></a>            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-194"><a href="#BacktestService.run_backtest-194"><span class="linenos">194</span></a>            <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-195"><a href="#BacktestService.run_backtest-195"><span class="linenos">195</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="BacktestService.run_backtest-196"><a href="#BacktestService.run_backtest-196"><span class="linenos">196</span></a>            <span class="n">save_report</span><span class="o">=</span> <span class="n">save_bt_plot</span> <span class="o">==</span> <span class="s1">&#39;persist&#39;</span> <span class="c1"># Solo genera el reporte si no es una corrida temporal</span>
</span><span id="BacktestService.run_backtest-197"><a href="#BacktestService.run_backtest-197"><span class="linenos">197</span></a>        <span class="p">)</span>
</span><span id="BacktestService.run_backtest-198"><a href="#BacktestService.run_backtest-198"><span class="linenos">198</span></a>
</span><span id="BacktestService.run_backtest-199"><a href="#BacktestService.run_backtest-199"><span class="linenos">199</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest is done :)&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-200"><a href="#BacktestService.run_backtest-200"><span class="linenos">200</span></a>
</span><span id="BacktestService.run_backtest-201"><a href="#BacktestService.run_backtest-201"><span class="linenos">201</span></a>        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtest-202"><a href="#BacktestService.run_backtest-202"><span class="linenos">202</span></a>        
</span><span id="BacktestService.run_backtest-203"><a href="#BacktestService.run_backtest-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span>
</span></pre></div>


            <div class="docstring"><p>Executes an asynchronous backtest for a given trading strategy and returns performance metrics, 
trade details, and statistics via a streaming endpoint.</p>

<p>This function loads the specified strategy, fetches historical price data, applies leverage rules,
and runs a backtest simulation. Results are streamed in real-time through an asyncio queue, 
and optional plots/reports are generated.</p>

<p>Steps performed:</p>

<ul>
<li>Loads the trading strategy dynamically from a module path.</li>
<li>Retrieves leverage rules from a YAML config file.</li>
<li>Fetches and prepares historical price data for the given ticker/timeframe.</li>
<li>Computes margin requirements based on leverage.</li>
<li>Executes the backtest using the strategy's logic and calculates performance metrics.</li>
<li>Generates and saves backtest plots (temporary or persistent) if requested.</li>
<li>Streams progress updates, logs, and final results through the provided queue.</li>
</ul>

<p>Parameters:</p>

<ul>
<li>initial_cash (float): Starting capital for the backtest simulation.</li>
<li>strategy (Strategy): Strategy object containing the module path and name.</li>
<li>ticker (Ticker): Financial instrument to backtest on (e.g., currency pair, stock).</li>
<li>timeframe (Timeframe): Timeframe for price data (e.g., '1H', '4H').</li>
<li>date_from (pd.Timestamp): Start date for historical data.</li>
<li>date_to (pd.Timestamp): End date for historical data.</li>
<li>method (str): Reserved for future backtest variations (unused in current implementation).</li>
<li>risk (float): Risk percentage per trade (e.g., 0.01 for 1% risk).</li>
<li>save_bt_plot (str): Plot saving mode: 
<ul>
<li>'temp': Saves in a temporary directory (auto-cleaned later).</li>
<li>'persist': Saves in the main backtest_plots directory.</li>
<li>Any other value skips plot generation.</li>
</ul></li>
<li>queue (asyncio.Queue): Async queue for real-time progress streaming.</li>
</ul>

<p>Returns:
AsyncGenerator[str, None]: Yields three objects upon completion:</p>

<ul>
<li>performance (pd.DataFrame): Aggregated strategy performance metrics.</li>
<li>trade_performance (pd.DataFrame): Detailed trade-by-trade results.</li>
<li>stats (pd.DataFrame): Statistical summaries (e.g., Sharpe ratio, max drawdown).</li>
</ul>

<p>Side effects:</p>

<ul>
<li>Reads leverage configurations from './app/configs/leverages.yml'.</li>
<li>May create HTML plot files in either './app/templates/static/backtest_plots/temp' (temporary)
or './app/templates/static/backtest_plots' (persistent).</li>
<li>Streams logs/results via the provided asyncio.Queue (e.g., for frontend progress updates).</li>
</ul>

<p>Notes:</p>

<ul>
<li>The strategy module path must follow the convention: 'app.backbone.strategies.{strategy_name}'.</li>
<li>Temporary plots include a timestamp and are automatically purged by a separate cleanup process.</li>
<li>Risk-free rate is fetched from the application's config service (used for Sharpe ratio calculations).</li>
<li>Margin is calculated as 1/leverage (e.g., 50x leverage → 2% margin requirement).</li>
</ul>
</div>


                            </div>
                            <div id="BacktestService.run_backtests_and_save" class="classattr">
                                        <input id="BacktestService.run_backtests_and_save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-streaming_endpoint">@streaming_endpoint</div>

        <span class="def">async def</span>
        <span class="name">run_backtests_and_save</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">strategies</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="../entities/strategy.html#Strategy">app.backbone.entities.strategy.Strategy</a></span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/strategy.html#Strategy">app.backbone.entities.strategy.Strategy</a></span><span class="p">]]</span>,</span><span class="param">	<span class="n">tickers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="../entities/ticker.html#Ticker">app.backbone.entities.ticker.Ticker</a></span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/ticker.html#Ticker">app.backbone.entities.ticker.Ticker</a></span><span class="p">]]</span>,</span><span class="param">	<span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/timeframe.html#Timeframe">app.backbone.entities.timeframe.Timeframe</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">date_from</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>,</span><span class="param">	<span class="n">date_to</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">risks</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>,</span><span class="param">	<span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">Queue</span></span><span class="return-annotation">) -> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.run_backtests_and_save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.run_backtests_and_save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.run_backtests_and_save-205"><a href="#BacktestService.run_backtests_and_save-205"><span class="linenos">205</span></a>    <span class="nd">@streaming_endpoint</span>
</span><span id="BacktestService.run_backtests_and_save-206"><a href="#BacktestService.run_backtests_and_save-206"><span class="linenos">206</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_backtests_and_save</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-207"><a href="#BacktestService.run_backtests_and_save-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-208"><a href="#BacktestService.run_backtests_and_save-208"><span class="linenos">208</span></a>        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-209"><a href="#BacktestService.run_backtests_and_save-209"><span class="linenos">209</span></a>        <span class="n">strategies</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
</span><span id="BacktestService.run_backtests_and_save-210"><a href="#BacktestService.run_backtests_and_save-210"><span class="linenos">210</span></a>        <span class="n">tickers</span><span class="p">:</span> <span class="n">Ticker</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Ticker</span><span class="p">],</span>
</span><span id="BacktestService.run_backtests_and_save-211"><a href="#BacktestService.run_backtests_and_save-211"><span class="linenos">211</span></a>        <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Timeframe</span><span class="p">],</span>
</span><span id="BacktestService.run_backtests_and_save-212"><a href="#BacktestService.run_backtests_and_save-212"><span class="linenos">212</span></a>        <span class="n">date_from</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-213"><a href="#BacktestService.run_backtests_and_save-213"><span class="linenos">213</span></a>        <span class="n">date_to</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-214"><a href="#BacktestService.run_backtests_and_save-214"><span class="linenos">214</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-215"><a href="#BacktestService.run_backtests_and_save-215"><span class="linenos">215</span></a>        <span class="n">risks</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="BacktestService.run_backtests_and_save-216"><a href="#BacktestService.run_backtests_and_save-216"><span class="linenos">216</span></a>        <span class="n">save_bt_plot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-217"><a href="#BacktestService.run_backtests_and_save-217"><span class="linenos">217</span></a>        <span class="n">queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-218"><a href="#BacktestService.run_backtests_and_save-218"><span class="linenos">218</span></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BacktestService.run_backtests_and_save-219"><a href="#BacktestService.run_backtests_and_save-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BacktestService.run_backtests_and_save-220"><a href="#BacktestService.run_backtests_and_save-220"><span class="linenos">220</span></a><span class="sd">        Executes multiple backtests in parallel for all combinations of strategies, tickers, timeframes and risks,</span>
</span><span id="BacktestService.run_backtests_and_save-221"><a href="#BacktestService.run_backtests_and_save-221"><span class="linenos">221</span></a><span class="sd">        then saves results to the database while streaming progress updates.</span>
</span><span id="BacktestService.run_backtests_and_save-222"><a href="#BacktestService.run_backtests_and_save-222"><span class="linenos">222</span></a>
</span><span id="BacktestService.run_backtests_and_save-223"><a href="#BacktestService.run_backtests_and_save-223"><span class="linenos">223</span></a><span class="sd">        This function handles the complete backtesting pipeline:</span>
</span><span id="BacktestService.run_backtests_and_save-224"><a href="#BacktestService.run_backtests_and_save-224"><span class="linenos">224</span></a><span class="sd">        - Generates all possible combinations of input parameters</span>
</span><span id="BacktestService.run_backtests_and_save-225"><a href="#BacktestService.run_backtests_and_save-225"><span class="linenos">225</span></a><span class="sd">        - Checks for existing backtest results to avoid duplicate work</span>
</span><span id="BacktestService.run_backtests_and_save-226"><a href="#BacktestService.run_backtests_and_save-226"><span class="linenos">226</span></a><span class="sd">        - Runs new backtests when needed using run_backtest()</span>
</span><span id="BacktestService.run_backtests_and_save-227"><a href="#BacktestService.run_backtests_and_save-227"><span class="linenos">227</span></a><span class="sd">        - Saves performance metrics, trade details, and statistics to the database</span>
</span><span id="BacktestService.run_backtests_and_save-228"><a href="#BacktestService.run_backtests_and_save-228"><span class="linenos">228</span></a><span class="sd">        - Provides real-time feedback through an async queue</span>
</span><span id="BacktestService.run_backtests_and_save-229"><a href="#BacktestService.run_backtests_and_save-229"><span class="linenos">229</span></a>
</span><span id="BacktestService.run_backtests_and_save-230"><a href="#BacktestService.run_backtests_and_save-230"><span class="linenos">230</span></a><span class="sd">        Steps performed:</span>
</span><span id="BacktestService.run_backtests_and_save-231"><a href="#BacktestService.run_backtests_and_save-231"><span class="linenos">231</span></a><span class="sd">        1. Normalizes all input parameters to lists (single items → single-element lists)</span>
</span><span id="BacktestService.run_backtests_and_save-232"><a href="#BacktestService.run_backtests_and_save-232"><span class="linenos">232</span></a><span class="sd">        2. Generates all combinations of strategies/tickers/timeframes/risks</span>
</span><span id="BacktestService.run_backtests_and_save-233"><a href="#BacktestService.run_backtests_and_save-233"><span class="linenos">233</span></a><span class="sd">        3. For each combination:</span>
</span><span id="BacktestService.run_backtests_and_save-234"><a href="#BacktestService.run_backtests_and_save-234"><span class="linenos">234</span></a><span class="sd">        - Checks if bot exists in database</span>
</span><span id="BacktestService.run_backtests_and_save-235"><a href="#BacktestService.run_backtests_and_save-235"><span class="linenos">235</span></a><span class="sd">        - Verifies if backtest already exists for the date range</span>
</span><span id="BacktestService.run_backtests_and_save-236"><a href="#BacktestService.run_backtests_and_save-236"><span class="linenos">236</span></a><span class="sd">        - Runs new backtest if needed</span>
</span><span id="BacktestService.run_backtests_and_save-237"><a href="#BacktestService.run_backtests_and_save-237"><span class="linenos">237</span></a><span class="sd">        - Converts results to database objects</span>
</span><span id="BacktestService.run_backtests_and_save-238"><a href="#BacktestService.run_backtests_and_save-238"><span class="linenos">238</span></a><span class="sd">        - Saves all data (bot, performance, trades) transactionally</span>
</span><span id="BacktestService.run_backtests_and_save-239"><a href="#BacktestService.run_backtests_and_save-239"><span class="linenos">239</span></a><span class="sd">        4. Streams progress, warnings, and completion messages via queue</span>
</span><span id="BacktestService.run_backtests_and_save-240"><a href="#BacktestService.run_backtests_and_save-240"><span class="linenos">240</span></a>
</span><span id="BacktestService.run_backtests_and_save-241"><a href="#BacktestService.run_backtests_and_save-241"><span class="linenos">241</span></a><span class="sd">        Parameters:</span>
</span><span id="BacktestService.run_backtests_and_save-242"><a href="#BacktestService.run_backtests_and_save-242"><span class="linenos">242</span></a><span class="sd">        - initial_cash (float): Starting capital for all backtests</span>
</span><span id="BacktestService.run_backtests_and_save-243"><a href="#BacktestService.run_backtests_and_save-243"><span class="linenos">243</span></a><span class="sd">        - strategies (Strategy|List[Strategy]): Single strategy or list to test</span>
</span><span id="BacktestService.run_backtests_and_save-244"><a href="#BacktestService.run_backtests_and_save-244"><span class="linenos">244</span></a><span class="sd">        - tickers (Ticker|List[Ticker]): Financial instrument(s) to backtest</span>
</span><span id="BacktestService.run_backtests_and_save-245"><a href="#BacktestService.run_backtests_and_save-245"><span class="linenos">245</span></a><span class="sd">        - timeframes (List[Timeframe]): Time intervals to test (e.g. [&#39;1H&#39;, &#39;4H&#39;])</span>
</span><span id="BacktestService.run_backtests_and_save-246"><a href="#BacktestService.run_backtests_and_save-246"><span class="linenos">246</span></a><span class="sd">        - date_from (date): Start date for historical data</span>
</span><span id="BacktestService.run_backtests_and_save-247"><a href="#BacktestService.run_backtests_and_save-247"><span class="linenos">247</span></a><span class="sd">        - date_to (date): End date for historical data</span>
</span><span id="BacktestService.run_backtests_and_save-248"><a href="#BacktestService.run_backtests_and_save-248"><span class="linenos">248</span></a><span class="sd">        - method (str): Backtesting methodology identifier</span>
</span><span id="BacktestService.run_backtests_and_save-249"><a href="#BacktestService.run_backtests_and_save-249"><span class="linenos">249</span></a><span class="sd">        - risks (float|List[float]): Risk percentage(s) per trade (e.g. [0.01, 0.02])</span>
</span><span id="BacktestService.run_backtests_and_save-250"><a href="#BacktestService.run_backtests_and_save-250"><span class="linenos">250</span></a><span class="sd">        - save_bt_plot (str): Plot saving mode:</span>
</span><span id="BacktestService.run_backtests_and_save-251"><a href="#BacktestService.run_backtests_and_save-251"><span class="linenos">251</span></a><span class="sd">            - &#39;temp&#39;: Temporary storage</span>
</span><span id="BacktestService.run_backtests_and_save-252"><a href="#BacktestService.run_backtests_and_save-252"><span class="linenos">252</span></a><span class="sd">            - &#39;persist&#39;: Permanent storage</span>
</span><span id="BacktestService.run_backtests_and_save-253"><a href="#BacktestService.run_backtests_and_save-253"><span class="linenos">253</span></a><span class="sd">            - Other: Skip plot generation</span>
</span><span id="BacktestService.run_backtests_and_save-254"><a href="#BacktestService.run_backtests_and_save-254"><span class="linenos">254</span></a><span class="sd">        - queue (asyncio.Queue): Async queue for progress streaming</span>
</span><span id="BacktestService.run_backtests_and_save-255"><a href="#BacktestService.run_backtests_and_save-255"><span class="linenos">255</span></a>
</span><span id="BacktestService.run_backtests_and_save-256"><a href="#BacktestService.run_backtests_and_save-256"><span class="linenos">256</span></a><span class="sd">        Returns:</span>
</span><span id="BacktestService.run_backtests_and_save-257"><a href="#BacktestService.run_backtests_and_save-257"><span class="linenos">257</span></a><span class="sd">        - AsyncGenerator[str, None]: Yields list of saved BotPerformance objects when complete</span>
</span><span id="BacktestService.run_backtests_and_save-258"><a href="#BacktestService.run_backtests_and_save-258"><span class="linenos">258</span></a>
</span><span id="BacktestService.run_backtests_and_save-259"><a href="#BacktestService.run_backtests_and_save-259"><span class="linenos">259</span></a><span class="sd">        Side effects:</span>
</span><span id="BacktestService.run_backtests_and_save-260"><a href="#BacktestService.run_backtests_and_save-260"><span class="linenos">260</span></a><span class="sd">        - Creates/updates database records for:</span>
</span><span id="BacktestService.run_backtests_and_save-261"><a href="#BacktestService.run_backtests_and_save-261"><span class="linenos">261</span></a><span class="sd">            - Bot configurations</span>
</span><span id="BacktestService.run_backtests_and_save-262"><a href="#BacktestService.run_backtests_and_save-262"><span class="linenos">262</span></a><span class="sd">            - Performance metrics</span>
</span><span id="BacktestService.run_backtests_and_save-263"><a href="#BacktestService.run_backtests_and_save-263"><span class="linenos">263</span></a><span class="sd">            - Individual trades</span>
</span><span id="BacktestService.run_backtests_and_save-264"><a href="#BacktestService.run_backtests_and_save-264"><span class="linenos">264</span></a><span class="sd">        - May generate plot files depending on save_bt_plot parameter</span>
</span><span id="BacktestService.run_backtests_and_save-265"><a href="#BacktestService.run_backtests_and_save-265"><span class="linenos">265</span></a><span class="sd">        - Streams messages to provided queue including:</span>
</span><span id="BacktestService.run_backtests_and_save-266"><a href="#BacktestService.run_backtests_and_save-266"><span class="linenos">266</span></a><span class="sd">            - Progress logs</span>
</span><span id="BacktestService.run_backtests_and_save-267"><a href="#BacktestService.run_backtests_and_save-267"><span class="linenos">267</span></a><span class="sd">            - Warnings about duplicates</span>
</span><span id="BacktestService.run_backtests_and_save-268"><a href="#BacktestService.run_backtests_and_save-268"><span class="linenos">268</span></a><span class="sd">            - Completion/failure notifications</span>
</span><span id="BacktestService.run_backtests_and_save-269"><a href="#BacktestService.run_backtests_and_save-269"><span class="linenos">269</span></a>
</span><span id="BacktestService.run_backtests_and_save-270"><a href="#BacktestService.run_backtests_and_save-270"><span class="linenos">270</span></a><span class="sd">        Notes:</span>
</span><span id="BacktestService.run_backtests_and_save-271"><a href="#BacktestService.run_backtests_and_save-271"><span class="linenos">271</span></a><span class="sd">        - Automatically skips existing backtests for the same parameters/date range</span>
</span><span id="BacktestService.run_backtests_and_save-272"><a href="#BacktestService.run_backtests_and_save-272"><span class="linenos">272</span></a><span class="sd">        - Uses atomic database transactions to ensure data consistency</span>
</span><span id="BacktestService.run_backtests_and_save-273"><a href="#BacktestService.run_backtests_and_save-273"><span class="linenos">273</span></a><span class="sd">        - New bots are created if they don&#39;t exist in the database</span>
</span><span id="BacktestService.run_backtests_and_save-274"><a href="#BacktestService.run_backtests_and_save-274"><span class="linenos">274</span></a><span class="sd">        - Trade history is extracted from backtest stats and saved relationally</span>
</span><span id="BacktestService.run_backtests_and_save-275"><a href="#BacktestService.run_backtests_and_save-275"><span class="linenos">275</span></a><span class="sd">        - All database operations use the service&#39;s db_service interface</span>
</span><span id="BacktestService.run_backtests_and_save-276"><a href="#BacktestService.run_backtests_and_save-276"><span class="linenos">276</span></a><span class="sd">        - Failures for individual combinations don&#39;t stop overall execution</span>
</span><span id="BacktestService.run_backtests_and_save-277"><a href="#BacktestService.run_backtests_and_save-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BacktestService.run_backtests_and_save-278"><a href="#BacktestService.run_backtests_and_save-278"><span class="linenos">278</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-279"><a href="#BacktestService.run_backtests_and_save-279"><span class="linenos">279</span></a>            <span class="n">backtests</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BacktestService.run_backtests_and_save-280"><a href="#BacktestService.run_backtests_and_save-280"><span class="linenos">280</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService.run_backtests_and_save-281"><a href="#BacktestService.run_backtests_and_save-281"><span class="linenos">281</span></a>
</span><span id="BacktestService.run_backtests_and_save-282"><a href="#BacktestService.run_backtests_and_save-282"><span class="linenos">282</span></a>            <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategies</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">strategies</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">strategies</span>
</span><span id="BacktestService.run_backtests_and_save-283"><a href="#BacktestService.run_backtests_and_save-283"><span class="linenos">283</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tickers</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">tickers</span>
</span><span id="BacktestService.run_backtests_and_save-284"><a href="#BacktestService.run_backtests_and_save-284"><span class="linenos">284</span></a>            <span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeframes</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">timeframes</span>
</span><span id="BacktestService.run_backtests_and_save-285"><a href="#BacktestService.run_backtests_and_save-285"><span class="linenos">285</span></a>            <span class="n">risks</span> <span class="o">=</span> <span class="p">[</span><span class="n">risks</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">risks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">risks</span>
</span><span id="BacktestService.run_backtests_and_save-286"><a href="#BacktestService.run_backtests_and_save-286"><span class="linenos">286</span></a>  
</span><span id="BacktestService.run_backtests_and_save-287"><a href="#BacktestService.run_backtests_and_save-287"><span class="linenos">287</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">strategies</span><span class="p">,</span> <span class="n">tickers</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">,</span> <span class="n">risks</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-288"><a href="#BacktestService.run_backtests_and_save-288"><span class="linenos">288</span></a>
</span><span id="BacktestService.run_backtests_and_save-289"><a href="#BacktestService.run_backtests_and_save-289"><span class="linenos">289</span></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_iterator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">)):</span>
</span><span id="BacktestService.run_backtests_and_save-290"><a href="#BacktestService.run_backtests_and_save-290"><span class="linenos">290</span></a>                <span class="n">strategy</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">risk</span> <span class="o">=</span> <span class="n">combination</span>
</span><span id="BacktestService.run_backtests_and_save-291"><a href="#BacktestService.run_backtests_and_save-291"><span class="linenos">291</span></a>
</span><span id="BacktestService.run_backtests_and_save-292"><a href="#BacktestService.run_backtests_and_save-292"><span class="linenos">292</span></a>                <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BacktestService.run_backtests_and_save-293"><a href="#BacktestService.run_backtests_and_save-293"><span class="linenos">293</span></a>
</span><span id="BacktestService.run_backtests_and_save-294"><a href="#BacktestService.run_backtests_and_save-294"><span class="linenos">294</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-295"><a href="#BacktestService.run_backtests_and_save-295"><span class="linenos">295</span></a>                
</span><span id="BacktestService.run_backtests_and_save-296"><a href="#BacktestService.run_backtests_and_save-296"><span class="linenos">296</span></a>                <span class="n">bot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="BacktestService.run_backtests_and_save-297"><a href="#BacktestService.run_backtests_and_save-297"><span class="linenos">297</span></a>                
</span><span id="BacktestService.run_backtests_and_save-298"><a href="#BacktestService.run_backtests_and_save-298"><span class="linenos">298</span></a>                <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking bot in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-299"><a href="#BacktestService.run_backtests_and_save-299"><span class="linenos">299</span></a>
</span><span id="BacktestService.run_backtests_and_save-300"><a href="#BacktestService.run_backtests_and_save-300"><span class="linenos">300</span></a>                <span class="n">bot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_service</span><span class="o">.</span><span class="n">get_bot</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-301"><a href="#BacktestService.run_backtests_and_save-301"><span class="linenos">301</span></a>                    <span class="n">strategy_id</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-302"><a href="#BacktestService.run_backtests_and_save-302"><span class="linenos">302</span></a>                    <span class="n">ticker_id</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-303"><a href="#BacktestService.run_backtests_and_save-303"><span class="linenos">303</span></a>                    <span class="n">timeframe_id</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-304"><a href="#BacktestService.run_backtests_and_save-304"><span class="linenos">304</span></a>                    <span class="n">risk</span><span class="o">=</span><span class="n">risk</span>   
</span><span id="BacktestService.run_backtests_and_save-305"><a href="#BacktestService.run_backtests_and_save-305"><span class="linenos">305</span></a>                <span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-306"><a href="#BacktestService.run_backtests_and_save-306"><span class="linenos">306</span></a>                
</span><span id="BacktestService.run_backtests_and_save-307"><a href="#BacktestService.run_backtests_and_save-307"><span class="linenos">307</span></a>                <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BacktestService.run_backtests_and_save-308"><a href="#BacktestService.run_backtests_and_save-308"><span class="linenos">308</span></a>
</span><span id="BacktestService.run_backtests_and_save-309"><a href="#BacktestService.run_backtests_and_save-309"><span class="linenos">309</span></a>                <span class="k">if</span> <span class="n">bot</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-310"><a href="#BacktestService.run_backtests_and_save-310"><span class="linenos">310</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot already exists&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-311"><a href="#BacktestService.run_backtests_and_save-311"><span class="linenos">311</span></a>
</span><span id="BacktestService.run_backtests_and_save-312"><a href="#BacktestService.run_backtests_and_save-312"><span class="linenos">312</span></a>                    <span class="n">bot_exists</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BacktestService.run_backtests_and_save-313"><a href="#BacktestService.run_backtests_and_save-313"><span class="linenos">313</span></a>
</span><span id="BacktestService.run_backtests_and_save-314"><a href="#BacktestService.run_backtests_and_save-314"><span class="linenos">314</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Checking backtest in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-315"><a href="#BacktestService.run_backtests_and_save-315"><span class="linenos">315</span></a>                    <span class="n">result_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performances_by_bot_dates</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-316"><a href="#BacktestService.run_backtests_and_save-316"><span class="linenos">316</span></a>                        <span class="n">bot_id</span><span class="o">=</span><span class="n">bot</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-317"><a href="#BacktestService.run_backtests_and_save-317"><span class="linenos">317</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-318"><a href="#BacktestService.run_backtests_and_save-318"><span class="linenos">318</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span>
</span><span id="BacktestService.run_backtests_and_save-319"><a href="#BacktestService.run_backtests_and_save-319"><span class="linenos">319</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-320"><a href="#BacktestService.run_backtests_and_save-320"><span class="linenos">320</span></a>                    
</span><span id="BacktestService.run_backtests_and_save-321"><a href="#BacktestService.run_backtests_and_save-321"><span class="linenos">321</span></a>                    <span class="k">if</span> <span class="n">result_performance</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-322"><a href="#BacktestService.run_backtests_and_save-322"><span class="linenos">322</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_performance</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-323"><a href="#BacktestService.run_backtests_and_save-323"><span class="linenos">323</span></a>                        <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;The backtest already exists. Skipping...&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-324"><a href="#BacktestService.run_backtests_and_save-324"><span class="linenos">324</span></a>                        <span class="k">continue</span>
</span><span id="BacktestService.run_backtests_and_save-325"><a href="#BacktestService.run_backtests_and_save-325"><span class="linenos">325</span></a>
</span><span id="BacktestService.run_backtests_and_save-326"><a href="#BacktestService.run_backtests_and_save-326"><span class="linenos">326</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-327"><a href="#BacktestService.run_backtests_and_save-327"><span class="linenos">327</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;The bot is not in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-328"><a href="#BacktestService.run_backtests_and_save-328"><span class="linenos">328</span></a>                    <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-329"><a href="#BacktestService.run_backtests_and_save-329"><span class="linenos">329</span></a>                        <span class="n">Name</span><span class="o">=</span><span class="n">bot_name</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-330"><a href="#BacktestService.run_backtests_and_save-330"><span class="linenos">330</span></a>                        <span class="n">StrategyId</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-331"><a href="#BacktestService.run_backtests_and_save-331"><span class="linenos">331</span></a>                        <span class="n">TickerId</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-332"><a href="#BacktestService.run_backtests_and_save-332"><span class="linenos">332</span></a>                        <span class="n">TimeframeId</span><span class="o">=</span><span class="n">timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-333"><a href="#BacktestService.run_backtests_and_save-333"><span class="linenos">333</span></a>                        <span class="n">Risk</span><span class="o">=</span><span class="n">risk</span>
</span><span id="BacktestService.run_backtests_and_save-334"><a href="#BacktestService.run_backtests_and_save-334"><span class="linenos">334</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-335"><a href="#BacktestService.run_backtests_and_save-335"><span class="linenos">335</span></a>
</span><span id="BacktestService.run_backtests_and_save-336"><a href="#BacktestService.run_backtests_and_save-336"><span class="linenos">336</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-337"><a href="#BacktestService.run_backtests_and_save-337"><span class="linenos">337</span></a>                    <span class="n">performance</span><span class="p">,</span> <span class="n">trade_performance</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-338"><a href="#BacktestService.run_backtests_and_save-338"><span class="linenos">338</span></a>                        <span class="n">initial_cash</span><span class="o">=</span><span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-339"><a href="#BacktestService.run_backtests_and_save-339"><span class="linenos">339</span></a>                        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-340"><a href="#BacktestService.run_backtests_and_save-340"><span class="linenos">340</span></a>                        <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-341"><a href="#BacktestService.run_backtests_and_save-341"><span class="linenos">341</span></a>                        <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-342"><a href="#BacktestService.run_backtests_and_save-342"><span class="linenos">342</span></a>                        <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-343"><a href="#BacktestService.run_backtests_and_save-343"><span class="linenos">343</span></a>                        <span class="n">date_to</span><span class="o">=</span><span class="n">date_to</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-344"><a href="#BacktestService.run_backtests_and_save-344"><span class="linenos">344</span></a>                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-345"><a href="#BacktestService.run_backtests_and_save-345"><span class="linenos">345</span></a>                        <span class="n">risk</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-346"><a href="#BacktestService.run_backtests_and_save-346"><span class="linenos">346</span></a>                        <span class="n">save_bt_plot</span><span class="o">=</span><span class="n">save_bt_plot</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-347"><a href="#BacktestService.run_backtests_and_save-347"><span class="linenos">347</span></a>                        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-348"><a href="#BacktestService.run_backtests_and_save-348"><span class="linenos">348</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-349"><a href="#BacktestService.run_backtests_and_save-349"><span class="linenos">349</span></a>
</span><span id="BacktestService.run_backtests_and_save-350"><a href="#BacktestService.run_backtests_and_save-350"><span class="linenos">350</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;Saving metrics in the database&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-351"><a href="#BacktestService.run_backtests_and_save-351"><span class="linenos">351</span></a>
</span><span id="BacktestService.run_backtests_and_save-352"><a href="#BacktestService.run_backtests_and_save-352"><span class="linenos">352</span></a>                    <span class="n">bot_performance_for_db</span> <span class="o">=</span> <span class="n">_performance_from_df_to_obj</span><span class="p">(</span>
</span><span id="BacktestService.run_backtests_and_save-353"><a href="#BacktestService.run_backtests_and_save-353"><span class="linenos">353</span></a>                        <span class="n">performance</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-354"><a href="#BacktestService.run_backtests_and_save-354"><span class="linenos">354</span></a>                        <span class="n">date_from</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-355"><a href="#BacktestService.run_backtests_and_save-355"><span class="linenos">355</span></a>                        <span class="n">date_to</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-356"><a href="#BacktestService.run_backtests_and_save-356"><span class="linenos">356</span></a>                        <span class="n">risk</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-357"><a href="#BacktestService.run_backtests_and_save-357"><span class="linenos">357</span></a>                        <span class="n">method</span><span class="p">,</span> 
</span><span id="BacktestService.run_backtests_and_save-358"><a href="#BacktestService.run_backtests_and_save-358"><span class="linenos">358</span></a>                        <span class="n">bot</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-359"><a href="#BacktestService.run_backtests_and_save-359"><span class="linenos">359</span></a>                        <span class="n">initial_cash</span><span class="p">,</span>
</span><span id="BacktestService.run_backtests_and_save-360"><a href="#BacktestService.run_backtests_and_save-360"><span class="linenos">360</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-361"><a href="#BacktestService.run_backtests_and_save-361"><span class="linenos">361</span></a>                    
</span><span id="BacktestService.run_backtests_and_save-362"><a href="#BacktestService.run_backtests_and_save-362"><span class="linenos">362</span></a>                    <span class="n">trade_performance_for_db</span> <span class="o">=</span> <span class="p">[</span><span class="n">BotTradePerformance</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trade_performance</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="BacktestService.run_backtests_and_save-363"><a href="#BacktestService.run_backtests_and_save-363"><span class="linenos">363</span></a>                    <span class="n">trade_performance_for_db</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span> 
</span><span id="BacktestService.run_backtests_and_save-364"><a href="#BacktestService.run_backtests_and_save-364"><span class="linenos">364</span></a>                    
</span><span id="BacktestService.run_backtests_and_save-365"><a href="#BacktestService.run_backtests_and_save-365"><span class="linenos">365</span></a>                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-366"><a href="#BacktestService.run_backtests_and_save-366"><span class="linenos">366</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_exists</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-367"><a href="#BacktestService.run_backtests_and_save-367"><span class="linenos">367</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-368"><a href="#BacktestService.run_backtests_and_save-368"><span class="linenos">368</span></a>                        
</span><span id="BacktestService.run_backtests_and_save-369"><a href="#BacktestService.run_backtests_and_save-369"><span class="linenos">369</span></a>                        <span class="n">backtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">bot_performance_for_db</span><span class="p">))</span>
</span><span id="BacktestService.run_backtests_and_save-370"><a href="#BacktestService.run_backtests_and_save-370"><span class="linenos">370</span></a>
</span><span id="BacktestService.run_backtests_and_save-371"><a href="#BacktestService.run_backtests_and_save-371"><span class="linenos">371</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade_performance_for_db</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-372"><a href="#BacktestService.run_backtests_and_save-372"><span class="linenos">372</span></a>                        
</span><span id="BacktestService.run_backtests_and_save-373"><a href="#BacktestService.run_backtests_and_save-373"><span class="linenos">373</span></a>                        <span class="n">trade_history</span> <span class="o">=</span> <span class="n">trades_from_df_to_obj</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">_trades</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-374"><a href="#BacktestService.run_backtests_and_save-374"><span class="linenos">374</span></a>
</span><span id="BacktestService.run_backtests_and_save-375"><a href="#BacktestService.run_backtests_and_save-375"><span class="linenos">375</span></a>                        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trade_history</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-376"><a href="#BacktestService.run_backtests_and_save-376"><span class="linenos">376</span></a>                            <span class="n">trade</span><span class="o">.</span><span class="n">BotPerformance</span> <span class="o">=</span> <span class="n">bot_performance_for_db</span>
</span><span id="BacktestService.run_backtests_and_save-377"><a href="#BacktestService.run_backtests_and_save-377"><span class="linenos">377</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">trade</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-378"><a href="#BacktestService.run_backtests_and_save-378"><span class="linenos">378</span></a>
</span><span id="BacktestService.run_backtests_and_save-379"><a href="#BacktestService.run_backtests_and_save-379"><span class="linenos">379</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;It&#39;s done buddy ;)&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-380"><a href="#BacktestService.run_backtests_and_save-380"><span class="linenos">380</span></a>                
</span><span id="BacktestService.run_backtests_and_save-381"><a href="#BacktestService.run_backtests_and_save-381"><span class="linenos">381</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-382"><a href="#BacktestService.run_backtests_and_save-382"><span class="linenos">382</span></a>                    <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BacktestService.run_backtests_and_save-383"><a href="#BacktestService.run_backtests_and_save-383"><span class="linenos">383</span></a>            
</span><span id="BacktestService.run_backtests_and_save-384"><a href="#BacktestService.run_backtests_and_save-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="n">backtests</span>
</span><span id="BacktestService.run_backtests_and_save-385"><a href="#BacktestService.run_backtests_and_save-385"><span class="linenos">385</span></a>            
</span><span id="BacktestService.run_backtests_and_save-386"><a href="#BacktestService.run_backtests_and_save-386"><span class="linenos">386</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BacktestService.run_backtests_and_save-387"><a href="#BacktestService.run_backtests_and_save-387"><span class="linenos">387</span></a>            <span class="k">await</span> <span class="n">log_message</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Executes multiple backtests in parallel for all combinations of strategies, tickers, timeframes and risks,
then saves results to the database while streaming progress updates.</p>

<p>This function handles the complete backtesting pipeline:</p>

<ul>
<li>Generates all possible combinations of input parameters</li>
<li>Checks for existing backtest results to avoid duplicate work</li>
<li>Runs new backtests when needed using run_backtest()</li>
<li>Saves performance metrics, trade details, and statistics to the database</li>
<li>Provides real-time feedback through an async queue</li>
</ul>

<p>Steps performed:</p>

<ol>
<li>Normalizes all input parameters to lists (single items → single-element lists)</li>
<li>Generates all combinations of strategies/tickers/timeframes/risks</li>
<li>For each combination:</li>
</ol>

<ul>
<li>Checks if bot exists in database</li>
<li>Verifies if backtest already exists for the date range</li>
<li>Runs new backtest if needed</li>
<li>Converts results to database objects</li>
<li>Saves all data (bot, performance, trades) transactionally</li>
</ul>

<ol start="4">
<li>Streams progress, warnings, and completion messages via queue</li>
</ol>

<p>Parameters:</p>

<ul>
<li>initial_cash (float): Starting capital for all backtests</li>
<li>strategies (Strategy|List[Strategy]): Single strategy or list to test</li>
<li>tickers (Ticker|List[Ticker]): Financial instrument(s) to backtest</li>
<li>timeframes (List[Timeframe]): Time intervals to test (e.g. ['1H', '4H'])</li>
<li>date_from (date): Start date for historical data</li>
<li>date_to (date): End date for historical data</li>
<li>method (str): Backtesting methodology identifier</li>
<li>risks (float|List[float]): Risk percentage(s) per trade (e.g. [0.01, 0.02])</li>
<li>save_bt_plot (str): Plot saving mode:
<ul>
<li>'temp': Temporary storage</li>
<li>'persist': Permanent storage</li>
<li>Other: Skip plot generation</li>
</ul></li>
<li>queue (asyncio.Queue): Async queue for progress streaming</li>
</ul>

<p>Returns:</p>

<ul>
<li>AsyncGenerator[str, None]: Yields list of saved BotPerformance objects when complete</li>
</ul>

<p>Side effects:</p>

<ul>
<li>Creates/updates database records for:
<ul>
<li>Bot configurations</li>
<li>Performance metrics</li>
<li>Individual trades</li>
</ul></li>
<li>May generate plot files depending on save_bt_plot parameter</li>
<li>Streams messages to provided queue including:
<ul>
<li>Progress logs</li>
<li>Warnings about duplicates</li>
<li>Completion/failure notifications</li>
</ul></li>
</ul>

<p>Notes:</p>

<ul>
<li>Automatically skips existing backtests for the same parameters/date range</li>
<li>Uses atomic database transactions to ensure data consistency</li>
<li>New bots are created if they don't exist in the database</li>
<li>Trade history is extracted from backtest stats and saved relationally</li>
<li>All database operations use the service's db_service interface</li>
<li>Failures for individual combinations don't stop overall execution</li>
</ul>
</div>


                            </div>
                            <div id="BacktestService.get_performances_by_strategy_ticker" class="classattr">
                                        <input id="BacktestService.get_performances_by_strategy_ticker-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_performances_by_strategy_ticker</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">strategy_id</span>,</span><span class="param">	<span class="n">ticker_id</span></span><span class="return-annotation">) -> <span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_performances_by_strategy_ticker-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_performances_by_strategy_ticker"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_performances_by_strategy_ticker-389"><a href="#BacktestService.get_performances_by_strategy_ticker-389"><span class="linenos">389</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_strategy_ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">,</span> <span class="n">ticker_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-390"><a href="#BacktestService.get_performances_by_strategy_ticker-390"><span class="linenos">390</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-391"><a href="#BacktestService.get_performances_by_strategy_ticker-391"><span class="linenos">391</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-392"><a href="#BacktestService.get_performances_by_strategy_ticker-392"><span class="linenos">392</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-393"><a href="#BacktestService.get_performances_by_strategy_ticker-393"><span class="linenos">393</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-394"><a href="#BacktestService.get_performances_by_strategy_ticker-394"><span class="linenos">394</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">ticker_id</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-395"><a href="#BacktestService.get_performances_by_strategy_ticker-395"><span class="linenos">395</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-396"><a href="#BacktestService.get_performances_by_strategy_ticker-396"><span class="linenos">396</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">))</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-397"><a href="#BacktestService.get_performances_by_strategy_ticker-397"><span class="linenos">397</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-398"><a href="#BacktestService.get_performances_by_strategy_ticker-398"><span class="linenos">398</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_performances_by_strategy_ticker-399"><a href="#BacktestService.get_performances_by_strategy_ticker-399"><span class="linenos">399</span></a>
</span><span id="BacktestService.get_performances_by_strategy_ticker-400"><a href="#BacktestService.get_performances_by_strategy_ticker-400"><span class="linenos">400</span></a>            <span class="k">return</span> <span class="n">bot_performances</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_performances_by_bot_dates" class="classattr">
                                        <input id="BacktestService.get_performances_by_bot_dates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_performances_by_bot_dates</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bot_id</span>,</span><span class="param">	<span class="n">date_from</span>,</span><span class="param">	<span class="n">date_to</span></span><span class="return-annotation">) -> <span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_performances_by_bot_dates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_performances_by_bot_dates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_performances_by_bot_dates-402"><a href="#BacktestService.get_performances_by_bot_dates-402"><span class="linenos">402</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performances_by_bot_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span>
</span><span id="BacktestService.get_performances_by_bot_dates-403"><a href="#BacktestService.get_performances_by_bot_dates-403"><span class="linenos">403</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_performances_by_bot_dates-404"><a href="#BacktestService.get_performances_by_bot_dates-404"><span class="linenos">404</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_performances_by_bot_dates-405"><a href="#BacktestService.get_performances_by_bot_dates-405"><span class="linenos">405</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-406"><a href="#BacktestService.get_performances_by_bot_dates-406"><span class="linenos">406</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService.get_performances_by_bot_dates-407"><a href="#BacktestService.get_performances_by_bot_dates-407"><span class="linenos">407</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">RandomTestPerformance</span><span class="p">),</span>
</span><span id="BacktestService.get_performances_by_bot_dates-408"><a href="#BacktestService.get_performances_by_bot_dates-408"><span class="linenos">408</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformance</span><span class="p">),</span>
</span><span id="BacktestService.get_performances_by_bot_dates-409"><a href="#BacktestService.get_performances_by_bot_dates-409"><span class="linenos">409</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-410"><a href="#BacktestService.get_performances_by_bot_dates-410"><span class="linenos">410</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_id</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-411"><a href="#BacktestService.get_performances_by_bot_dates-411"><span class="linenos">411</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateFrom</span> <span class="o">==</span> <span class="n">date_from</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-412"><a href="#BacktestService.get_performances_by_bot_dates-412"><span class="linenos">412</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">DateTo</span> <span class="o">==</span> <span class="n">date_to</span><span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-413"><a href="#BacktestService.get_performances_by_bot_dates-413"><span class="linenos">413</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="BacktestService.get_performances_by_bot_dates-414"><a href="#BacktestService.get_performances_by_bot_dates-414"><span class="linenos">414</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_performances_by_bot_dates-415"><a href="#BacktestService.get_performances_by_bot_dates-415"><span class="linenos">415</span></a>            
</span><span id="BacktestService.get_performances_by_bot_dates-416"><a href="#BacktestService.get_performances_by_bot_dates-416"><span class="linenos">416</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_performance_by_bot" class="classattr">
                                        <input id="BacktestService.get_performance_by_bot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_performance_by_bot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bot_id</span></span><span class="return-annotation">) -> <span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_performance_by_bot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_performance_by_bot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_performance_by_bot-418"><a href="#BacktestService.get_performance_by_bot-418"><span class="linenos">418</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_performance_by_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="BacktestService.get_performance_by_bot-419"><a href="#BacktestService.get_performance_by_bot-419"><span class="linenos">419</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_performance_by_bot-420"><a href="#BacktestService.get_performance_by_bot-420"><span class="linenos">420</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">BotId</span><span class="o">=</span><span class="n">bot_id</span><span class="p">)</span>  
</span><span id="BacktestService.get_performance_by_bot-421"><a href="#BacktestService.get_performance_by_bot-421"><span class="linenos">421</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_bot_performance_by_id" class="classattr">
                                        <input id="BacktestService.get_bot_performance_by_id-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_bot_performance_by_id</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bot_performance_id</span></span><span class="return-annotation">) -> <span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_bot_performance_by_id-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_bot_performance_by_id"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_bot_performance_by_id-423"><a href="#BacktestService.get_bot_performance_by_id-423"><span class="linenos">423</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bot_performance_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BotPerformance</span><span class="p">:</span> <span class="c1"># cambiar bot_id por backtest_id</span>
</span><span id="BacktestService.get_bot_performance_by_id-424"><a href="#BacktestService.get_bot_performance_by_id-424"><span class="linenos">424</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_bot_performance_by_id-425"><a href="#BacktestService.get_bot_performance_by_id-425"><span class="linenos">425</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="BacktestService.get_bot_performance_by_id-426"><a href="#BacktestService.get_bot_performance_by_id-426"><span class="linenos">426</span></a>
</span><span id="BacktestService.get_bot_performance_by_id-427"><a href="#BacktestService.get_bot_performance_by_id-427"><span class="linenos">427</span></a>            <span class="k">return</span> <span class="n">bot_performance</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.delete_from_strategy" class="classattr">
                                        <input id="BacktestService.delete_from_strategy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_from_strategy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">strategy_id</span></span><span class="return-annotation">) -> <span class="n"><a href="operation_result.html#OperationResult">app.backbone.services.operation_result.OperationResult</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.delete_from_strategy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.delete_from_strategy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.delete_from_strategy-429"><a href="#BacktestService.delete_from_strategy-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_from_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService.delete_from_strategy-430"><a href="#BacktestService.delete_from_strategy-430"><span class="linenos">430</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.delete_from_strategy-431"><a href="#BacktestService.delete_from_strategy-431"><span class="linenos">431</span></a>            <span class="n">bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-432"><a href="#BacktestService.delete_from_strategy-432"><span class="linenos">432</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-433"><a href="#BacktestService.delete_from_strategy-433"><span class="linenos">433</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-434"><a href="#BacktestService.delete_from_strategy-434"><span class="linenos">434</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-435"><a href="#BacktestService.delete_from_strategy-435"><span class="linenos">435</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.delete_from_strategy-436"><a href="#BacktestService.delete_from_strategy-436"><span class="linenos">436</span></a>
</span><span id="BacktestService.delete_from_strategy-437"><a href="#BacktestService.delete_from_strategy-437"><span class="linenos">437</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-438"><a href="#BacktestService.delete_from_strategy-438"><span class="linenos">438</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MetricWharehouse</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-439"><a href="#BacktestService.delete_from_strategy-439"><span class="linenos">439</span></a>                    <span class="n">MetricWharehouse</span><span class="o">.</span><span class="n">MontecarloTestId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-440"><a href="#BacktestService.delete_from_strategy-440"><span class="linenos">440</span></a>                        <span class="n">select</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-441"><a href="#BacktestService.delete_from_strategy-441"><span class="linenos">441</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-442"><a href="#BacktestService.delete_from_strategy-442"><span class="linenos">442</span></a>                <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-443"><a href="#BacktestService.delete_from_strategy-443"><span class="linenos">443</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-444"><a href="#BacktestService.delete_from_strategy-444"><span class="linenos">444</span></a>
</span><span id="BacktestService.delete_from_strategy-445"><a href="#BacktestService.delete_from_strategy-445"><span class="linenos">445</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-446"><a href="#BacktestService.delete_from_strategy-446"><span class="linenos">446</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MontecarloTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-447"><a href="#BacktestService.delete_from_strategy-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-448"><a href="#BacktestService.delete_from_strategy-448"><span class="linenos">448</span></a>
</span><span id="BacktestService.delete_from_strategy-449"><a href="#BacktestService.delete_from_strategy-449"><span class="linenos">449</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-450"><a href="#BacktestService.delete_from_strategy-450"><span class="linenos">450</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">RandomTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RandomTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-451"><a href="#BacktestService.delete_from_strategy-451"><span class="linenos">451</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-452"><a href="#BacktestService.delete_from_strategy-452"><span class="linenos">452</span></a>
</span><span id="BacktestService.delete_from_strategy-453"><a href="#BacktestService.delete_from_strategy-453"><span class="linenos">453</span></a>            <span class="n">lucktest_bp_subq</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-454"><a href="#BacktestService.delete_from_strategy-454"><span class="linenos">454</span></a>                <span class="n">select</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-455"><a href="#BacktestService.delete_from_strategy-455"><span class="linenos">455</span></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-456"><a href="#BacktestService.delete_from_strategy-456"><span class="linenos">456</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.delete_from_strategy-457"><a href="#BacktestService.delete_from_strategy-457"><span class="linenos">457</span></a>
</span><span id="BacktestService.delete_from_strategy-458"><a href="#BacktestService.delete_from_strategy-458"><span class="linenos">458</span></a>            <span class="n">bot_performances</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService.delete_from_strategy-459"><a href="#BacktestService.delete_from_strategy-459"><span class="linenos">459</span></a>
</span><span id="BacktestService.delete_from_strategy-460"><a href="#BacktestService.delete_from_strategy-460"><span class="linenos">460</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">lucktest_bp_subq</span><span class="p">)))</span>
</span><span id="BacktestService.delete_from_strategy-461"><a href="#BacktestService.delete_from_strategy-461"><span class="linenos">461</span></a>
</span><span id="BacktestService.delete_from_strategy-462"><a href="#BacktestService.delete_from_strategy-462"><span class="linenos">462</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-463"><a href="#BacktestService.delete_from_strategy-463"><span class="linenos">463</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">LuckTest</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LuckTest</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-464"><a href="#BacktestService.delete_from_strategy-464"><span class="linenos">464</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-465"><a href="#BacktestService.delete_from_strategy-465"><span class="linenos">465</span></a>
</span><span id="BacktestService.delete_from_strategy-466"><a href="#BacktestService.delete_from_strategy-466"><span class="linenos">466</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-467"><a href="#BacktestService.delete_from_strategy-467"><span class="linenos">467</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-468"><a href="#BacktestService.delete_from_strategy-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-469"><a href="#BacktestService.delete_from_strategy-469"><span class="linenos">469</span></a>
</span><span id="BacktestService.delete_from_strategy-470"><a href="#BacktestService.delete_from_strategy-470"><span class="linenos">470</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-471"><a href="#BacktestService.delete_from_strategy-471"><span class="linenos">471</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Trade</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Trade</span><span class="o">.</span><span class="n">BotPerformanceId</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-472"><a href="#BacktestService.delete_from_strategy-472"><span class="linenos">472</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-473"><a href="#BacktestService.delete_from_strategy-473"><span class="linenos">473</span></a>
</span><span id="BacktestService.delete_from_strategy-474"><a href="#BacktestService.delete_from_strategy-474"><span class="linenos">474</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-475"><a href="#BacktestService.delete_from_strategy-475"><span class="linenos">475</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bp_subq</span><span class="p">))</span>
</span><span id="BacktestService.delete_from_strategy-476"><a href="#BacktestService.delete_from_strategy-476"><span class="linenos">476</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-477"><a href="#BacktestService.delete_from_strategy-477"><span class="linenos">477</span></a>
</span><span id="BacktestService.delete_from_strategy-478"><a href="#BacktestService.delete_from_strategy-478"><span class="linenos">478</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="BacktestService.delete_from_strategy-479"><a href="#BacktestService.delete_from_strategy-479"><span class="linenos">479</span></a>                <span class="n">delete</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-480"><a href="#BacktestService.delete_from_strategy-480"><span class="linenos">480</span></a>            <span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-481"><a href="#BacktestService.delete_from_strategy-481"><span class="linenos">481</span></a>        
</span><span id="BacktestService.delete_from_strategy-482"><a href="#BacktestService.delete_from_strategy-482"><span class="linenos">482</span></a>        <span class="c1"># Borrar archivos relacionados</span>
</span><span id="BacktestService.delete_from_strategy-483"><a href="#BacktestService.delete_from_strategy-483"><span class="linenos">483</span></a>        <span class="k">for</span> <span class="n">bot_performance</span> <span class="ow">in</span> <span class="n">bot_performances</span><span class="p">:</span>
</span><span id="BacktestService.delete_from_strategy-484"><a href="#BacktestService.delete_from_strategy-484"><span class="linenos">484</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-485"><a href="#BacktestService.delete_from_strategy-485"><span class="linenos">485</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-486"><a href="#BacktestService.delete_from_strategy-486"><span class="linenos">486</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="BacktestService.delete_from_strategy-487"><a href="#BacktestService.delete_from_strategy-487"><span class="linenos">487</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="BacktestService.delete_from_strategy-488"><a href="#BacktestService.delete_from_strategy-488"><span class="linenos">488</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-489"><a href="#BacktestService.delete_from_strategy-489"><span class="linenos">489</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="BacktestService.delete_from_strategy-490"><a href="#BacktestService.delete_from_strategy-490"><span class="linenos">490</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="BacktestService.delete_from_strategy-491"><a href="#BacktestService.delete_from_strategy-491"><span class="linenos">491</span></a>
</span><span id="BacktestService.delete_from_strategy-492"><a href="#BacktestService.delete_from_strategy-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.delete" class="classattr">
                                        <input id="BacktestService.delete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bot_performance</span></span><span class="return-annotation">) -> <span class="n"><a href="operation_result.html#OperationResult">app.backbone.services.operation_result.OperationResult</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.delete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.delete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.delete-495"><a href="#BacktestService.delete-495"><span class="linenos">495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService.delete-496"><a href="#BacktestService.delete-496"><span class="linenos">496</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.delete-497"><a href="#BacktestService.delete-497"><span class="linenos">497</span></a>            <span class="c1"># Cargar el objeto con relaciones necesarias</span>
</span><span id="BacktestService.delete-498"><a href="#BacktestService.delete-498"><span class="linenos">498</span></a>            <span class="n">bot_performance_id</span> <span class="o">=</span> <span class="n">bot_performance</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bot_performance</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span>
</span><span id="BacktestService.delete-499"><a href="#BacktestService.delete-499"><span class="linenos">499</span></a>
</span><span id="BacktestService.delete-500"><a href="#BacktestService.delete-500"><span class="linenos">500</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="BacktestService.delete-501"><a href="#BacktestService.delete-501"><span class="linenos">501</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService.delete-502"><a href="#BacktestService.delete-502"><span class="linenos">502</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="BacktestService.delete-503"><a href="#BacktestService.delete-503"><span class="linenos">503</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="BacktestService.delete-504"><a href="#BacktestService.delete-504"><span class="linenos">504</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="BacktestService.delete-505"><a href="#BacktestService.delete-505"><span class="linenos">505</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="BacktestService.delete-506"><a href="#BacktestService.delete-506"><span class="linenos">506</span></a>                <span class="p">)</span>\
</span><span id="BacktestService.delete-507"><a href="#BacktestService.delete-507"><span class="linenos">507</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bot_performance_id</span><span class="p">)</span>\
</span><span id="BacktestService.delete-508"><a href="#BacktestService.delete-508"><span class="linenos">508</span></a>                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="BacktestService.delete-509"><a href="#BacktestService.delete-509"><span class="linenos">509</span></a>
</span><span id="BacktestService.delete-510"><a href="#BacktestService.delete-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_performance</span><span class="p">:</span>
</span><span id="BacktestService.delete-511"><a href="#BacktestService.delete-511"><span class="linenos">511</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;BotPerformance not found&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService.delete-512"><a href="#BacktestService.delete-512"><span class="linenos">512</span></a>
</span><span id="BacktestService.delete-513"><a href="#BacktestService.delete-513"><span class="linenos">513</span></a>            <span class="c1"># Eliminar relaciones directas</span>
</span><span id="BacktestService.delete-514"><a href="#BacktestService.delete-514"><span class="linenos">514</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">:</span>
</span><span id="BacktestService.delete-515"><a href="#BacktestService.delete-515"><span class="linenos">515</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-516"><a href="#BacktestService.delete-516"><span class="linenos">516</span></a>
</span><span id="BacktestService.delete-517"><a href="#BacktestService.delete-517"><span class="linenos">517</span></a>            <span class="c1"># Eliminar Montecarlo y métricas asociadas</span>
</span><span id="BacktestService.delete-518"><a href="#BacktestService.delete-518"><span class="linenos">518</span></a>            <span class="n">montecarlo_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService.delete-519"><a href="#BacktestService.delete-519"><span class="linenos">519</span></a>            <span class="k">if</span> <span class="n">montecarlo_test</span><span class="p">:</span>
</span><span id="BacktestService.delete-520"><a href="#BacktestService.delete-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MetricWharehouse</span><span class="p">,</span> <span class="n">MontecarloTestId</span><span class="o">=</span><span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-521"><a href="#BacktestService.delete-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">MontecarloTest</span><span class="p">,</span> <span class="n">montecarlo_test</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-522"><a href="#BacktestService.delete-522"><span class="linenos">522</span></a>
</span><span id="BacktestService.delete-523"><a href="#BacktestService.delete-523"><span class="linenos">523</span></a>            <span class="c1"># Eliminar LuckTests y sus performances</span>
</span><span id="BacktestService.delete-524"><a href="#BacktestService.delete-524"><span class="linenos">524</span></a>            <span class="n">luck_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService.delete-525"><a href="#BacktestService.delete-525"><span class="linenos">525</span></a>            <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">luck_tests</span><span class="p">:</span>
</span><span id="BacktestService.delete-526"><a href="#BacktestService.delete-526"><span class="linenos">526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">LuckTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService.delete-527"><a href="#BacktestService.delete-527"><span class="linenos">527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">LuckTest</span><span class="p">,</span> <span class="n">lt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-528"><a href="#BacktestService.delete-528"><span class="linenos">528</span></a>
</span><span id="BacktestService.delete-529"><a href="#BacktestService.delete-529"><span class="linenos">529</span></a>            <span class="c1"># Borrar archivos relacionados</span>
</span><span id="BacktestService.delete-530"><a href="#BacktestService.delete-530"><span class="linenos">530</span></a>            <span class="n">str_date_from</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateFrom</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService.delete-531"><a href="#BacktestService.delete-531"><span class="linenos">531</span></a>            <span class="n">str_date_to</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">DateTo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="BacktestService.delete-532"><a href="#BacktestService.delete-532"><span class="linenos">532</span></a>            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bot_performance</span><span class="o">.</span><span class="n">Bot</span><span class="o">.</span><span class="n">Name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_from</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">str_date_to</span><span class="si">}</span><span class="s1">.html&#39;</span>
</span><span id="BacktestService.delete-533"><a href="#BacktestService.delete-533"><span class="linenos">533</span></a>            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;luck_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;t_test_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots&#39;</span><span class="p">,</span> <span class="s1">&#39;backtest_plots/reports&#39;</span><span class="p">]:</span>
</span><span id="BacktestService.delete-534"><a href="#BacktestService.delete-534"><span class="linenos">534</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;./app/templates/static/&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="BacktestService.delete-535"><a href="#BacktestService.delete-535"><span class="linenos">535</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="BacktestService.delete-536"><a href="#BacktestService.delete-536"><span class="linenos">536</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="BacktestService.delete-537"><a href="#BacktestService.delete-537"><span class="linenos">537</span></a>
</span><span id="BacktestService.delete-538"><a href="#BacktestService.delete-538"><span class="linenos">538</span></a>            <span class="c1"># Eliminar RandomTests y sus dependencias</span>
</span><span id="BacktestService.delete-539"><a href="#BacktestService.delete-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">:</span>
</span><span id="BacktestService.delete-540"><a href="#BacktestService.delete-540"><span class="linenos">540</span></a>                <span class="n">rt</span> <span class="o">=</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">RandomTest</span>
</span><span id="BacktestService.delete-541"><a href="#BacktestService.delete-541"><span class="linenos">541</span></a>                <span class="n">rt_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService.delete-542"><a href="#BacktestService.delete-542"><span class="linenos">542</span></a>                <span class="k">if</span> <span class="n">rt_perf</span><span class="p">:</span>
</span><span id="BacktestService.delete-543"><a href="#BacktestService.delete-543"><span class="linenos">543</span></a>                    <span class="n">rt_trade_perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">rt_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-544"><a href="#BacktestService.delete-544"><span class="linenos">544</span></a>                    <span class="k">if</span> <span class="n">rt_trade_perf</span><span class="p">:</span>
</span><span id="BacktestService.delete-545"><a href="#BacktestService.delete-545"><span class="linenos">545</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotTradePerformance</span><span class="p">,</span> <span class="n">rt_trade_perf</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-546"><a href="#BacktestService.delete-546"><span class="linenos">546</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">RandomTestPerformanceId</span><span class="p">)</span>
</span><span id="BacktestService.delete-547"><a href="#BacktestService.delete-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">RandomTest</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-548"><a href="#BacktestService.delete-548"><span class="linenos">548</span></a>
</span><span id="BacktestService.delete-549"><a href="#BacktestService.delete-549"><span class="linenos">549</span></a>            <span class="c1"># Borrar trades relacionados</span>
</span><span id="BacktestService.delete-550"><a href="#BacktestService.delete-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">BotPerformanceId</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>
</span><span id="BacktestService.delete-551"><a href="#BacktestService.delete-551"><span class="linenos">551</span></a>
</span><span id="BacktestService.delete-552"><a href="#BacktestService.delete-552"><span class="linenos">552</span></a>            <span class="c1"># Si no hay más performance, borrar el Bot</span>
</span><span id="BacktestService.delete-553"><a href="#BacktestService.delete-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">:</span>
</span><span id="BacktestService.delete-554"><a href="#BacktestService.delete-554"><span class="linenos">554</span></a>                <span class="n">rem</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span> <span class="o">==</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="BacktestService.delete-555"><a href="#BacktestService.delete-555"><span class="linenos">555</span></a>                <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BacktestService.delete-556"><a href="#BacktestService.delete-556"><span class="linenos">556</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.delete-557"><a href="#BacktestService.delete-557"><span class="linenos">557</span></a>
</span><span id="BacktestService.delete-558"><a href="#BacktestService.delete-558"><span class="linenos">558</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.delete-559"><a href="#BacktestService.delete-559"><span class="linenos">559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="BacktestService.delete-560"><a href="#BacktestService.delete-560"><span class="linenos">560</span></a>
</span><span id="BacktestService.delete-561"><a href="#BacktestService.delete-561"><span class="linenos">561</span></a>        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.update_favorite" class="classattr">
                                        <input id="BacktestService.update_favorite-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_favorite</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">performance_id</span></span><span class="return-annotation">) -> <span class="n"><a href="operation_result.html#OperationResult">app.backbone.services.operation_result.OperationResult</a></span>:</span></span>

                <label class="view-source-button" for="BacktestService.update_favorite-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.update_favorite"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.update_favorite-564"><a href="#BacktestService.update_favorite-564"><span class="linenos">564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OperationResult</span><span class="p">:</span>
</span><span id="BacktestService.update_favorite-565"><a href="#BacktestService.update_favorite-565"><span class="linenos">565</span></a>
</span><span id="BacktestService.update_favorite-566"><a href="#BacktestService.update_favorite-566"><span class="linenos">566</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.update_favorite-567"><a href="#BacktestService.update_favorite-567"><span class="linenos">567</span></a>            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance_id</span><span class="p">)</span>
</span><span id="BacktestService.update_favorite-568"><a href="#BacktestService.update_favorite-568"><span class="linenos">568</span></a>            
</span><span id="BacktestService.update_favorite-569"><a href="#BacktestService.update_favorite-569"><span class="linenos">569</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">performance</span><span class="p">:</span>
</span><span id="BacktestService.update_favorite-570"><a href="#BacktestService.update_favorite-570"><span class="linenos">570</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Backtest not found&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService.update_favorite-571"><a href="#BacktestService.update_favorite-571"><span class="linenos">571</span></a>            
</span><span id="BacktestService.update_favorite-572"><a href="#BacktestService.update_favorite-572"><span class="linenos">572</span></a>            <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">performance</span><span class="o">.</span><span class="n">Favorite</span>
</span><span id="BacktestService.update_favorite-573"><a href="#BacktestService.update_favorite-573"><span class="linenos">573</span></a>            <span class="n">updated_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">performance</span><span class="p">)</span>   
</span><span id="BacktestService.update_favorite-574"><a href="#BacktestService.update_favorite-574"><span class="linenos">574</span></a>
</span><span id="BacktestService.update_favorite-575"><a href="#BacktestService.update_favorite-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_performance</span><span class="p">:</span>
</span><span id="BacktestService.update_favorite-576"><a href="#BacktestService.update_favorite-576"><span class="linenos">576</span></a>                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Update failed&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BacktestService.update_favorite-577"><a href="#BacktestService.update_favorite-577"><span class="linenos">577</span></a>
</span><span id="BacktestService.update_favorite-578"><a href="#BacktestService.update_favorite-578"><span class="linenos">578</span></a>            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">(</span><span class="n">ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">updated_performance</span><span class="o">.</span><span class="n">Favorite</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_robusts" class="classattr">
                                        <input id="BacktestService.get_robusts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_robusts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_robusts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_robusts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_robusts-580"><a href="#BacktestService.get_robusts-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService.get_robusts-581"><a href="#BacktestService.get_robusts-581"><span class="linenos">581</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_robusts-582"><a href="#BacktestService.get_robusts-582"><span class="linenos">582</span></a>            <span class="c1"># Subquery para filtrar estrategias robustas (RreturnDd promedio &gt; 1)</span>
</span><span id="BacktestService.get_robusts-583"><a href="#BacktestService.get_robusts-583"><span class="linenos">583</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts-584"><a href="#BacktestService.get_robusts-584"><span class="linenos">584</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts-585"><a href="#BacktestService.get_robusts-585"><span class="linenos">585</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts-586"><a href="#BacktestService.get_robusts-586"><span class="linenos">586</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts-587"><a href="#BacktestService.get_robusts-587"><span class="linenos">587</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts-588"><a href="#BacktestService.get_robusts-588"><span class="linenos">588</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-589"><a href="#BacktestService.get_robusts-589"><span class="linenos">589</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-590"><a href="#BacktestService.get_robusts-590"><span class="linenos">590</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts-591"><a href="#BacktestService.get_robusts-591"><span class="linenos">591</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts-592"><a href="#BacktestService.get_robusts-592"><span class="linenos">592</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="BacktestService.get_robusts-593"><a href="#BacktestService.get_robusts-593"><span class="linenos">593</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts-594"><a href="#BacktestService.get_robusts-594"><span class="linenos">594</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-595"><a href="#BacktestService.get_robusts-595"><span class="linenos">595</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-596"><a href="#BacktestService.get_robusts-596"><span class="linenos">596</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts-597"><a href="#BacktestService.get_robusts-597"><span class="linenos">597</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts-598"><a href="#BacktestService.get_robusts-598"><span class="linenos">598</span></a>
</span><span id="BacktestService.get_robusts-599"><a href="#BacktestService.get_robusts-599"><span class="linenos">599</span></a>            <span class="c1"># Alias para evitar ambigüedad</span>
</span><span id="BacktestService.get_robusts-600"><a href="#BacktestService.get_robusts-600"><span class="linenos">600</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-601"><a href="#BacktestService.get_robusts-601"><span class="linenos">601</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-602"><a href="#BacktestService.get_robusts-602"><span class="linenos">602</span></a>
</span><span id="BacktestService.get_robusts-603"><a href="#BacktestService.get_robusts-603"><span class="linenos">603</span></a>            <span class="c1"># Subquery para asignar un número de fila basado en StabilityWeightedRar</span>
</span><span id="BacktestService.get_robusts-604"><a href="#BacktestService.get_robusts-604"><span class="linenos">604</span></a>            <span class="n">ranked_subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts-605"><a href="#BacktestService.get_robusts-605"><span class="linenos">605</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts-606"><a href="#BacktestService.get_robusts-606"><span class="linenos">606</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;bp_id&quot;</span><span class="p">),</span>
</span><span id="BacktestService.get_robusts-607"><a href="#BacktestService.get_robusts-607"><span class="linenos">607</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts-608"><a href="#BacktestService.get_robusts-608"><span class="linenos">608</span></a>                    <span class="o">.</span><span class="n">over</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts-609"><a href="#BacktestService.get_robusts-609"><span class="linenos">609</span></a>                        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">],</span>
</span><span id="BacktestService.get_robusts-610"><a href="#BacktestService.get_robusts-610"><span class="linenos">610</span></a>                        <span class="n">order_by</span><span class="o">=</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
</span><span id="BacktestService.get_robusts-611"><a href="#BacktestService.get_robusts-611"><span class="linenos">611</span></a>                    <span class="p">)</span>
</span><span id="BacktestService.get_robusts-612"><a href="#BacktestService.get_robusts-612"><span class="linenos">612</span></a>                    <span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;row_num&quot;</span><span class="p">),</span>
</span><span id="BacktestService.get_robusts-613"><a href="#BacktestService.get_robusts-613"><span class="linenos">613</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts-614"><a href="#BacktestService.get_robusts-614"><span class="linenos">614</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-615"><a href="#BacktestService.get_robusts-615"><span class="linenos">615</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts-616"><a href="#BacktestService.get_robusts-616"><span class="linenos">616</span></a>                    <span class="n">subquery</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts-617"><a href="#BacktestService.get_robusts-617"><span class="linenos">617</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-618"><a href="#BacktestService.get_robusts-618"><span class="linenos">618</span></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">),</span>
</span><span id="BacktestService.get_robusts-619"><a href="#BacktestService.get_robusts-619"><span class="linenos">619</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts-620"><a href="#BacktestService.get_robusts-620"><span class="linenos">620</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts-621"><a href="#BacktestService.get_robusts-621"><span class="linenos">621</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts-622"><a href="#BacktestService.get_robusts-622"><span class="linenos">622</span></a>
</span><span id="BacktestService.get_robusts-623"><a href="#BacktestService.get_robusts-623"><span class="linenos">623</span></a>            <span class="c1"># Query final seleccionando solo los mejores (row_num == 1)</span>
</span><span id="BacktestService.get_robusts-624"><a href="#BacktestService.get_robusts-624"><span class="linenos">624</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts-625"><a href="#BacktestService.get_robusts-625"><span class="linenos">625</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-626"><a href="#BacktestService.get_robusts-626"><span class="linenos">626</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="p">,</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">bp_id</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-627"><a href="#BacktestService.get_robusts-627"><span class="linenos">627</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranked_subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">row_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts-628"><a href="#BacktestService.get_robusts-628"><span class="linenos">628</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts-629"><a href="#BacktestService.get_robusts-629"><span class="linenos">629</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts-630"><a href="#BacktestService.get_robusts-630"><span class="linenos">630</span></a>
</span><span id="BacktestService.get_robusts-631"><a href="#BacktestService.get_robusts-631"><span class="linenos">631</span></a>            <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_robusts_by_strategy_id" class="classattr">
                                        <input id="BacktestService.get_robusts_by_strategy_id-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_robusts_by_strategy_id</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">strategy_id</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_robusts_by_strategy_id-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_robusts_by_strategy_id"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_robusts_by_strategy_id-633"><a href="#BacktestService.get_robusts_by_strategy_id-633"><span class="linenos">633</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_robusts_by_strategy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-634"><a href="#BacktestService.get_robusts_by_strategy_id-634"><span class="linenos">634</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-635"><a href="#BacktestService.get_robusts_by_strategy_id-635"><span class="linenos">635</span></a>            <span class="c1"># Subquery para calcular el promedio de RreturnDd por StrategyId y TickerId</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-636"><a href="#BacktestService.get_robusts_by_strategy_id-636"><span class="linenos">636</span></a>            <span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-637"><a href="#BacktestService.get_robusts_by_strategy_id-637"><span class="linenos">637</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-638"><a href="#BacktestService.get_robusts_by_strategy_id-638"><span class="linenos">638</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-639"><a href="#BacktestService.get_robusts_by_strategy_id-639"><span class="linenos">639</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-640"><a href="#BacktestService.get_robusts_by_strategy_id-640"><span class="linenos">640</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-641"><a href="#BacktestService.get_robusts_by_strategy_id-641"><span class="linenos">641</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-642"><a href="#BacktestService.get_robusts_by_strategy_id-642"><span class="linenos">642</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Timeframe</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TimeframeId</span> <span class="o">==</span> <span class="n">Timeframe</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-643"><a href="#BacktestService.get_robusts_by_strategy_id-643"><span class="linenos">643</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-644"><a href="#BacktestService.get_robusts_by_strategy_id-644"><span class="linenos">644</span></a>                    <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">strategy_id</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-645"><a href="#BacktestService.get_robusts_by_strategy_id-645"><span class="linenos">645</span></a>                    <span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">!=</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-646"><a href="#BacktestService.get_robusts_by_strategy_id-646"><span class="linenos">646</span></a>                    <span class="n">Timeframe</span><span class="o">.</span><span class="n">Selected</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-647"><a href="#BacktestService.get_robusts_by_strategy_id-647"><span class="linenos">647</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-648"><a href="#BacktestService.get_robusts_by_strategy_id-648"><span class="linenos">648</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-649"><a href="#BacktestService.get_robusts_by_strategy_id-649"><span class="linenos">649</span></a>                <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># &gt;= en lugar de &gt; para incluir exactamente 1</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-650"><a href="#BacktestService.get_robusts_by_strategy_id-650"><span class="linenos">650</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-651"><a href="#BacktestService.get_robusts_by_strategy_id-651"><span class="linenos">651</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-652"><a href="#BacktestService.get_robusts_by_strategy_id-652"><span class="linenos">652</span></a>
</span><span id="BacktestService.get_robusts_by_strategy_id-653"><a href="#BacktestService.get_robusts_by_strategy_id-653"><span class="linenos">653</span></a>            <span class="c1"># Alias para evitar ambigüedad en las relaciones</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-654"><a href="#BacktestService.get_robusts_by_strategy_id-654"><span class="linenos">654</span></a>            <span class="n">bot_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Bot</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-655"><a href="#BacktestService.get_robusts_by_strategy_id-655"><span class="linenos">655</span></a>            <span class="n">bp_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-656"><a href="#BacktestService.get_robusts_by_strategy_id-656"><span class="linenos">656</span></a>
</span><span id="BacktestService.get_robusts_by_strategy_id-657"><a href="#BacktestService.get_robusts_by_strategy_id-657"><span class="linenos">657</span></a>            <span class="c1"># Subquery para seleccionar la mejor temporalidad por StrategyId - TickerId</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-658"><a href="#BacktestService.get_robusts_by_strategy_id-658"><span class="linenos">658</span></a>            <span class="n">best_temporalities</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-659"><a href="#BacktestService.get_robusts_by_strategy_id-659"><span class="linenos">659</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-660"><a href="#BacktestService.get_robusts_by_strategy_id-660"><span class="linenos">660</span></a>                    <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-661"><a href="#BacktestService.get_robusts_by_strategy_id-661"><span class="linenos">661</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-662"><a href="#BacktestService.get_robusts_by_strategy_id-662"><span class="linenos">662</span></a>                    <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-663"><a href="#BacktestService.get_robusts_by_strategy_id-663"><span class="linenos">663</span></a>                    <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;max_custom_metric&quot;</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-664"><a href="#BacktestService.get_robusts_by_strategy_id-664"><span class="linenos">664</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-665"><a href="#BacktestService.get_robusts_by_strategy_id-665"><span class="linenos">665</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-666"><a href="#BacktestService.get_robusts_by_strategy_id-666"><span class="linenos">666</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">))</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-667"><a href="#BacktestService.get_robusts_by_strategy_id-667"><span class="linenos">667</span></a>                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-668"><a href="#BacktestService.get_robusts_by_strategy_id-668"><span class="linenos">668</span></a>                <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-669"><a href="#BacktestService.get_robusts_by_strategy_id-669"><span class="linenos">669</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-670"><a href="#BacktestService.get_robusts_by_strategy_id-670"><span class="linenos">670</span></a>
</span><span id="BacktestService.get_robusts_by_strategy_id-671"><a href="#BacktestService.get_robusts_by_strategy_id-671"><span class="linenos">671</span></a>            <span class="c1"># Query final para traer solo los registros que corresponden a la mejor temporalidad</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-672"><a href="#BacktestService.get_robusts_by_strategy_id-672"><span class="linenos">672</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-673"><a href="#BacktestService.get_robusts_by_strategy_id-673"><span class="linenos">673</span></a>                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">bp_alias</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-674"><a href="#BacktestService.get_robusts_by_strategy_id-674"><span class="linenos">674</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bot_alias</span><span class="p">,</span> <span class="n">bot_alias</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">bp_alias</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-675"><a href="#BacktestService.get_robusts_by_strategy_id-675"><span class="linenos">675</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_temporalities</span><span class="p">,</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-676"><a href="#BacktestService.get_robusts_by_strategy_id-676"><span class="linenos">676</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">StrategyId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-677"><a href="#BacktestService.get_robusts_by_strategy_id-677"><span class="linenos">677</span></a>                    <span class="p">(</span><span class="n">bot_alias</span><span class="o">.</span><span class="n">TickerId</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span> <span class="o">&amp;</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-678"><a href="#BacktestService.get_robusts_by_strategy_id-678"><span class="linenos">678</span></a>                    <span class="p">(</span><span class="n">bp_alias</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">==</span> <span class="n">best_temporalities</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_custom_metric</span><span class="p">))</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-679"><a href="#BacktestService.get_robusts_by_strategy_id-679"><span class="linenos">679</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-680"><a href="#BacktestService.get_robusts_by_strategy_id-680"><span class="linenos">680</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_robusts_by_strategy_id-681"><a href="#BacktestService.get_robusts_by_strategy_id-681"><span class="linenos">681</span></a>
</span><span id="BacktestService.get_robusts_by_strategy_id-682"><a href="#BacktestService.get_robusts_by_strategy_id-682"><span class="linenos">682</span></a>            <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_favorites" class="classattr">
                                        <input id="BacktestService.get_favorites-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_favorites</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_favorites-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_favorites"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_favorites-684"><a href="#BacktestService.get_favorites-684"><span class="linenos">684</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_favorites</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService.get_favorites-685"><a href="#BacktestService.get_favorites-685"><span class="linenos">685</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_favorites-686"><a href="#BacktestService.get_favorites-686"><span class="linenos">686</span></a>            <span class="n">favorites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_many_by_filter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="n">Favorite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BacktestService.get_favorites-687"><a href="#BacktestService.get_favorites-687"><span class="linenos">687</span></a>        
</span><span id="BacktestService.get_favorites-688"><a href="#BacktestService.get_favorites-688"><span class="linenos">688</span></a>        <span class="k">return</span> <span class="n">favorites</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_trades" class="classattr">
                                        <input id="BacktestService.get_trades-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_trades</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bot_performance_id</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/trade.html#Trade">app.backbone.entities.trade.Trade</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_trades-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_trades"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_trades-690"><a href="#BacktestService.get_trades-690"><span class="linenos">690</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_performance_id</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
</span><span id="BacktestService.get_trades-691"><a href="#BacktestService.get_trades-691"><span class="linenos">691</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_trades-692"><a href="#BacktestService.get_trades-692"><span class="linenos">692</span></a>            <span class="n">bot_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">BotPerformance</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bot_performance_id</span><span class="p">)</span>  
</span><span id="BacktestService.get_trades-693"><a href="#BacktestService.get_trades-693"><span class="linenos">693</span></a>            <span class="k">return</span> <span class="n">bot_performance</span><span class="o">.</span><span class="n">TradeHistory</span>
</span></pre></div>


    

                            </div>
                            <div id="BacktestService.get_by_filter" class="classattr">
                                        <input id="BacktestService.get_by_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_by_filter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">return_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">stability_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sharpe_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">trades</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">rreturn_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">custom_metric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">winrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../entities/bot_performance.html#BotPerformance">app.backbone.entities.bot_performance.BotPerformance</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BacktestService.get_by_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BacktestService.get_by_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BacktestService.get_by_filter-695"><a href="#BacktestService.get_by_filter-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_filter</span><span class="p">(</span>
</span><span id="BacktestService.get_by_filter-696"><a href="#BacktestService.get_by_filter-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-697"><a href="#BacktestService.get_by_filter-697"><span class="linenos">697</span></a>        <span class="n">return_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-698"><a href="#BacktestService.get_by_filter-698"><span class="linenos">698</span></a>        <span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-699"><a href="#BacktestService.get_by_filter-699"><span class="linenos">699</span></a>        <span class="n">stability_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-700"><a href="#BacktestService.get_by_filter-700"><span class="linenos">700</span></a>        <span class="n">sharpe_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-701"><a href="#BacktestService.get_by_filter-701"><span class="linenos">701</span></a>        <span class="n">trades</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-702"><a href="#BacktestService.get_by_filter-702"><span class="linenos">702</span></a>        <span class="n">rreturn_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-703"><a href="#BacktestService.get_by_filter-703"><span class="linenos">703</span></a>        <span class="n">custom_metric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-704"><a href="#BacktestService.get_by_filter-704"><span class="linenos">704</span></a>        <span class="n">winrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-705"><a href="#BacktestService.get_by_filter-705"><span class="linenos">705</span></a>        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BacktestService.get_by_filter-706"><a href="#BacktestService.get_by_filter-706"><span class="linenos">706</span></a>        <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BacktestService.get_by_filter-707"><a href="#BacktestService.get_by_filter-707"><span class="linenos">707</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BotPerformance</span><span class="p">]:</span>
</span><span id="BacktestService.get_by_filter-708"><a href="#BacktestService.get_by_filter-708"><span class="linenos">708</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_service</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-709"><a href="#BacktestService.get_by_filter-709"><span class="linenos">709</span></a>            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BacktestService.get_by_filter-710"><a href="#BacktestService.get_by_filter-710"><span class="linenos">710</span></a>
</span><span id="BacktestService.get_by_filter-711"><a href="#BacktestService.get_by_filter-711"><span class="linenos">711</span></a>            <span class="c1"># Base query y joins explícitos</span>
</span><span id="BacktestService.get_by_filter-712"><a href="#BacktestService.get_by_filter-712"><span class="linenos">712</span></a>            <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BotPerformance</span><span class="p">)</span>\
</span><span id="BacktestService.get_by_filter-713"><a href="#BacktestService.get_by_filter-713"><span class="linenos">713</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Bot</span><span class="p">,</span> <span class="n">Bot</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotId</span><span class="p">)</span>\
</span><span id="BacktestService.get_by_filter-714"><a href="#BacktestService.get_by_filter-714"><span class="linenos">714</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">StrategyId</span><span class="p">)</span>\
</span><span id="BacktestService.get_by_filter-715"><a href="#BacktestService.get_by_filter-715"><span class="linenos">715</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Ticker</span><span class="p">,</span> <span class="n">Ticker</span><span class="o">.</span><span class="n">Id</span> <span class="o">==</span> <span class="n">Bot</span><span class="o">.</span><span class="n">TickerId</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-716"><a href="#BacktestService.get_by_filter-716"><span class="linenos">716</span></a>
</span><span id="BacktestService.get_by_filter-717"><a href="#BacktestService.get_by_filter-717"><span class="linenos">717</span></a>            <span class="c1"># Filtros numéricos</span>
</span><span id="BacktestService.get_by_filter-718"><a href="#BacktestService.get_by_filter-718"><span class="linenos">718</span></a>            <span class="k">if</span> <span class="n">return_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-719"><a href="#BacktestService.get_by_filter-719"><span class="linenos">719</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Return</span> <span class="o">&gt;=</span> <span class="n">return_</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-720"><a href="#BacktestService.get_by_filter-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="n">drawdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-721"><a href="#BacktestService.get_by_filter-721"><span class="linenos">721</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Drawdown</span> <span class="o">&lt;=</span> <span class="n">drawdown</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-722"><a href="#BacktestService.get_by_filter-722"><span class="linenos">722</span></a>            <span class="k">if</span> <span class="n">stability_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-723"><a href="#BacktestService.get_by_filter-723"><span class="linenos">723</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityRatio</span> <span class="o">&gt;=</span> <span class="n">stability_ratio</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-724"><a href="#BacktestService.get_by_filter-724"><span class="linenos">724</span></a>            <span class="k">if</span> <span class="n">sharpe_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-725"><a href="#BacktestService.get_by_filter-725"><span class="linenos">725</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">SharpeRatio</span> <span class="o">&gt;=</span> <span class="n">sharpe_ratio</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-726"><a href="#BacktestService.get_by_filter-726"><span class="linenos">726</span></a>            <span class="k">if</span> <span class="n">trades</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-727"><a href="#BacktestService.get_by_filter-727"><span class="linenos">727</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Trades</span> <span class="o">&gt;=</span> <span class="n">trades</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-728"><a href="#BacktestService.get_by_filter-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="n">rreturn_dd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-729"><a href="#BacktestService.get_by_filter-729"><span class="linenos">729</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span> <span class="o">&gt;=</span> <span class="n">rreturn_dd</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-730"><a href="#BacktestService.get_by_filter-730"><span class="linenos">730</span></a>            <span class="k">if</span> <span class="n">custom_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-731"><a href="#BacktestService.get_by_filter-731"><span class="linenos">731</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">StabilityWeightedRar</span> <span class="o">&gt;=</span> <span class="n">custom_metric</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-732"><a href="#BacktestService.get_by_filter-732"><span class="linenos">732</span></a>            <span class="k">if</span> <span class="n">winrate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-733"><a href="#BacktestService.get_by_filter-733"><span class="linenos">733</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">WinRate</span> <span class="o">&gt;=</span> <span class="n">winrate</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-734"><a href="#BacktestService.get_by_filter-734"><span class="linenos">734</span></a>
</span><span id="BacktestService.get_by_filter-735"><a href="#BacktestService.get_by_filter-735"><span class="linenos">735</span></a>            <span class="c1"># Filtros por texto con ILIKE correctamente aplicados</span>
</span><span id="BacktestService.get_by_filter-736"><a href="#BacktestService.get_by_filter-736"><span class="linenos">736</span></a>            <span class="k">if</span> <span class="n">strategy</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-737"><a href="#BacktestService.get_by_filter-737"><span class="linenos">737</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Strategy</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="BacktestService.get_by_filter-738"><a href="#BacktestService.get_by_filter-738"><span class="linenos">738</span></a>            <span class="k">if</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="BacktestService.get_by_filter-739"><a href="#BacktestService.get_by_filter-739"><span class="linenos">739</span></a>                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ticker</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
</span><span id="BacktestService.get_by_filter-740"><a href="#BacktestService.get_by_filter-740"><span class="linenos">740</span></a>
</span><span id="BacktestService.get_by_filter-741"><a href="#BacktestService.get_by_filter-741"><span class="linenos">741</span></a>            <span class="c1"># Query final que aplica filtros correctamente</span>
</span><span id="BacktestService.get_by_filter-742"><a href="#BacktestService.get_by_filter-742"><span class="linenos">742</span></a>            <span class="n">final_query</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BacktestService.get_by_filter-743"><a href="#BacktestService.get_by_filter-743"><span class="linenos">743</span></a>                <span class="n">query</span>
</span><span id="BacktestService.get_by_filter-744"><a href="#BacktestService.get_by_filter-744"><span class="linenos">744</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
</span><span id="BacktestService.get_by_filter-745"><a href="#BacktestService.get_by_filter-745"><span class="linenos">745</span></a>                <span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="BacktestService.get_by_filter-746"><a href="#BacktestService.get_by_filter-746"><span class="linenos">746</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">Bot</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-747"><a href="#BacktestService.get_by_filter-747"><span class="linenos">747</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">BotTradePerformance</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-748"><a href="#BacktestService.get_by_filter-748"><span class="linenos">748</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">TradeHistory</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-749"><a href="#BacktestService.get_by_filter-749"><span class="linenos">749</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">MontecarloTest</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-750"><a href="#BacktestService.get_by_filter-750"><span class="linenos">750</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">LuckTest</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-751"><a href="#BacktestService.get_by_filter-751"><span class="linenos">751</span></a>                    <span class="n">joinedload</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RandomTest</span><span class="p">),</span>
</span><span id="BacktestService.get_by_filter-752"><a href="#BacktestService.get_by_filter-752"><span class="linenos">752</span></a>                <span class="p">)</span>
</span><span id="BacktestService.get_by_filter-753"><a href="#BacktestService.get_by_filter-753"><span class="linenos">753</span></a>                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">BotPerformance</span><span class="o">.</span><span class="n">RreturnDd</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</span><span id="BacktestService.get_by_filter-754"><a href="#BacktestService.get_by_filter-754"><span class="linenos">754</span></a>                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="BacktestService.get_by_filter-755"><a href="#BacktestService.get_by_filter-755"><span class="linenos">755</span></a>            <span class="p">)</span>
</span><span id="BacktestService.get_by_filter-756"><a href="#BacktestService.get_by_filter-756"><span class="linenos">756</span></a>
</span><span id="BacktestService.get_by_filter-757"><a href="#BacktestService.get_by_filter-757"><span class="linenos">757</span></a>            <span class="k">return</span> <span class="n">final_query</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>